<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashScope TTS è°ƒè¯•å·¥å…·</title>
    <script src="js/tts/DashScopeEngine.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; background: #2a2a2a; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
        input, textarea, button { padding: 10px; margin: 5px; border: 1px solid #555; background: #333; color: #fff; border-radius: 4px; }
        button { cursor: pointer; background: #4c6ef5; }
        button:hover { background: #364fc7; }
        .log { background: #000; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-result.success { background: #2b8a3e; }
        .test-result.error { background: #c92a2a; }
        .test-result.warning { background: #f08c00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ DashScope TTS è°ƒè¯•å·¥å…·</h1>
        
        <!-- API å¯†é’¥é…ç½® -->
        <div class="section">
            <h2>1. API å¯†é’¥é…ç½®</h2>
            <input type="password" id="api-key" placeholder="è¾“å…¥ DashScope API å¯†é’¥" style="width: 400px;">
            <button onclick="validateApiKey()">éªŒè¯å¯†é’¥</button>
            <div id="key-status" class="test-result" style="display: none;"></div>
        </div>

        <!-- ç½‘ç»œè¿æ¥æµ‹è¯• -->
        <div class="section">
            <h2>2. ç½‘ç»œè¿æ¥æµ‹è¯•</h2>
            <button onclick="testNetworkConnection()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <div id="network-status" class="test-result" style="display: none;"></div>
        </div>

        <!-- API ç«¯ç‚¹æµ‹è¯• -->
        <div class="section">
            <h2>3. API ç«¯ç‚¹æµ‹è¯•</h2>
            <button onclick="testApiEndpoint()">æµ‹è¯• API ç«¯ç‚¹</button>
            <div id="endpoint-status" class="test-result" style="display: none;"></div>
        </div>

        <!-- TTS å‚æ•°æµ‹è¯• -->
        <div class="section">
            <h2>4. TTS å‚æ•°æµ‹è¯•</h2>
            <div>
                <label>æ–‡æœ¬å†…å®¹ï¼š</label><br>
                <textarea id="test-text" rows="4" style="width: 100%;">è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºæµ‹è¯•è¯­éŸ³åˆæˆåŠŸèƒ½çš„æ–‡æœ¬ã€‚æˆ‘ä»¬å°†é€šè¿‡è¿™æ®µæ–‡æœ¬æ¥éªŒè¯TTSç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’ŒéŸ³è´¨æ•ˆæœã€‚é€šè¿‡è¿™ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°äº†è§£è¯­éŸ³åˆæˆçš„è´¨é‡å’Œæ€§èƒ½è¡¨ç°ã€‚</textarea>
            </div>
            <div>
                <label>éŸ³è‰²é€‰æ‹©ï¼š</label>
                <select id="voice-select" style="padding: 10px; margin: 5px;">
                    <option value="Cherry">Cherry (å¥³å£°)</option>
                    <option value="Siming">Siming (ç”·å£°)</option>
                    <option value="Zhidar">Zhidar (ç”·å£°)</option>
                    <option value="Kai">Kai (ä½æ²‰å¾¡å°‘éŸ³)</option>
                    <option value="Nofish">Nofish (æ¸…å†·å°‘å¹´éŸ³)</option>
                    <option value="Lenn">Lenn (æ¸©æŸ”å¤§å”éŸ³)</option>
                </select>
            </div>
            <div style="margin: 10px 0;">
                <button onclick="testTTSRequest()">ğŸš€ æµ‹è¯•TTS</button>
                <button onclick="testAllNewVoices()" style="background: #2196F3;">æµ‹è¯•æ–°éŸ³è‰²å¯¹æ¯”</button>
                <button onclick="clearTTSResults()" style="background: #FF5722;">æ¸…é™¤æµ‹è¯•ç»“æœ</button>
            </div>
            <div id="tts-status" class="test-result" style="display: none;"></div>
        </div>

        <!-- å®Œæ•´æµç¨‹æµ‹è¯• -->
        <div class="section">
            <h2>5. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="full-test-status" class="test-result" style="display: none;"></div>
        </div>

        <!-- é”™è¯¯æ—¥å¿— -->
        <div class="section">
            <h2>6. è¯¦ç»†æ—¥å¿—</h2>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="debug-log" class="log"></div>
        </div>
    </div>

    <script>
        let debugLog = document.getElementById('debug-log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            debugLog.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            debugLog.innerHTML = '';
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${type}`;
            element.textContent = message;
        }

        // 1. éªŒè¯ API å¯†é’¥æ ¼å¼
        function validateApiKey() {
            const apiKey = document.getElementById('api-key').value;
            
            if (!apiKey) {
                showResult('key-status', 'âŒ è¯·è¾“å…¥ API å¯†é’¥', 'error');
                log('API å¯†é’¥ä¸ºç©º', 'error');
                return false;
            }

            // åŸºæœ¬æ ¼å¼æ£€æŸ¥
            if (apiKey.length < 20) {
                showResult('key-status', 'âŒ API å¯†é’¥é•¿åº¦ä¸è¶³', 'error');
                log('API å¯†é’¥é•¿åº¦ä¸è¶³', 'error');
                return false;
            }

            if (/\s/.test(apiKey)) {
                showResult('key-status', 'âŒ API å¯†é’¥åŒ…å«ç©ºæ ¼', 'error');
                log('API å¯†é’¥åŒ…å«ç©ºæ ¼', 'error');
                return false;
            }

            showResult('key-status', 'âœ… API å¯†é’¥æ ¼å¼æ­£ç¡®', 'success');
            log('API å¯†é’¥æ ¼å¼éªŒè¯é€šè¿‡', 'success');
            return true;
        }

        // 2. æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testNetworkConnection() {
            log('å¼€å§‹æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');
            
            try {
                // æµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥
                const response = await fetch('https://www.baidu.com', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                showResult('network-status', 'âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
                log('ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡', 'success');
                
            } catch (error) {
                showResult('network-status', 'âŒ ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
                log('ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // 3. æµ‹è¯• API ç«¯ç‚¹
        async function testApiEndpoint() {
            const apiKey = document.getElementById('api-key').value;
            
            if (!validateApiKey()) {
                showResult('endpoint-status', 'âŒ è¯·å…ˆé…ç½®æœ‰æ•ˆçš„ API å¯†é’¥', 'error');
                return;
            }

            log('å¼€å§‹æµ‹è¯• API ç«¯ç‚¹...', 'info');

            try {
                // æ£€æŸ¥ DashScopeEngine æ˜¯å¦å¯ç”¨
                if (typeof DashScopeEngine === 'undefined') {
                    throw new Error('DashScopeEngine æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                // åˆ›å»º DashScope å¼•æ“å®ä¾‹
                const engine = new DashScopeEngine();
                engine.setApiKey(apiKey);
                
                // éªŒè¯ API å¯†é’¥
                const validation = await engine.validateApiKey();
                
                if (validation.isValid) {
                    showResult('endpoint-status', 'âœ… API ç«¯ç‚¹è¿æ¥æˆåŠŸ', 'success');
                    log('API ç«¯ç‚¹æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    showResult('endpoint-status', `âŒ API éªŒè¯å¤±è´¥: ${validation.error}`, 'error');
                    log('API ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ' + validation.error, 'error');
                }
                
            } catch (error) {
                log(`API ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('endpoint-status', `âŒ API ç«¯ç‚¹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 4. æµ‹è¯• TTS è¯·æ±‚
        async function testTTSRequest() {
            const apiKey = document.getElementById('api-key').value;
            const text = document.getElementById('test-text').value;
            const voice = document.getElementById('voice-select').value;

            if (!validateApiKey()) {
                showResult('tts-status', 'âŒ è¯·å…ˆé…ç½®æœ‰æ•ˆçš„ API å¯†é’¥', 'error');
                return;
            }

            if (!text.trim()) {
                showResult('tts-status', 'âŒ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬', 'error');
                return;
            }

            log(`å¼€å§‹æµ‹è¯• TTS è¯·æ±‚ - æ–‡æœ¬: "${text}", éŸ³è‰²: ${voice}`, 'info');

            try {
                const engine = new DashScopeEngine();
                engine.setApiKey(apiKey);
                
                // æ˜ å°„éŸ³è‰²åç§°
                const voiceMapping = {
                    'Kai': 'yushao',
                    'Nofish': 'shaonian', 
                    'Lenn': 'dashu'
                };
                
                const mappedVoice = voiceMapping[voice] || 'yushao';
                log(`éŸ³è‰²æ˜ å°„: ${voice} â†’ ${mappedVoice}`, 'info');
                
                const startTime = performance.now();
                await engine.synthesize(text, { voice: mappedVoice });
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                showResult('tts-status', `âœ… TTS æµ‹è¯•æˆåŠŸï¼è€—æ—¶: ${duration}ms`, 'success');
                log(`TTS æµ‹è¯•å®Œæˆï¼Œè€—æ—¶: ${duration}ms`, 'success');
                
            } catch (error) {
                log(`TTS æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('tts-status', `âŒ TTS æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ‰€æœ‰æ–°éŸ³è‰²å¯¹æ¯”
        async function testAllNewVoices() {
            const apiKey = document.getElementById('api-key').value;
            const text = document.getElementById('test-text').value || 'ä½ å¥½ï¼Œæˆ‘æ˜¯è¯­éŸ³åŠ©æ‰‹ï¼Œè¿™æ˜¯éŸ³è‰²æµ‹è¯•ã€‚';

            if (!validateApiKey()) {
                showResult('tts-status', 'âŒ è¯·å…ˆé…ç½®æœ‰æ•ˆçš„ API å¯†é’¥', 'error');
                return;
            }

            log('å¼€å§‹æµ‹è¯•æ‰€æœ‰æ–°éŸ³è‰²...', 'info');
            showResult('tts-status', 'ğŸ”„ æ­£åœ¨æµ‹è¯•æ‰€æœ‰éŸ³è‰²...', 'warning');

            const voices = [
                { name: 'Kai', mapped: 'yushao', desc: 'ä½æ²‰å¾¡å°‘éŸ³' },
                { name: 'Nofish', mapped: 'shaonian', desc: 'æ¸…å†·å°‘å¹´éŸ³' },
                { name: 'Lenn', mapped: 'dashu', desc: 'æ¸©æŸ”å¤§å”éŸ³' }
            ];

            try {
                const engine = new DashScopeEngine();
                engine.setApiKey(apiKey);

                for (const voice of voices) {
                    log(`æµ‹è¯•éŸ³è‰²: ${voice.name} (${voice.desc})`, 'info');
                    
                    try {
                        await engine.synthesize(text, { voice: voice.mapped });
                        log(`âœ… ${voice.name} æµ‹è¯•æˆåŠŸ`, 'success');
                        
                        // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (voiceError) {
                        log(`âŒ ${voice.name} æµ‹è¯•å¤±è´¥: ${voiceError.message}`, 'error');
                    }
                }

                showResult('tts-status', 'âœ… æ‰€æœ‰éŸ³è‰²æµ‹è¯•å®Œæˆ', 'success');
                log('æ‰€æœ‰éŸ³è‰²æµ‹è¯•å®Œæˆ', 'success');

            } catch (error) {
                log(`éŸ³è‰²æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('tts-status', `âŒ éŸ³è‰²æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 5. è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
            showResult('full-test-status', 'ğŸ”„ æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•...', 'warning');

            try {
                // 1. éªŒè¯ API å¯†é’¥
                if (!validateApiKey()) {
                    throw new Error('API å¯†é’¥éªŒè¯å¤±è´¥');
                }

                // 2. æµ‹è¯•ç½‘ç»œè¿æ¥
                await testNetworkConnection();
                await new Promise(resolve => setTimeout(resolve, 500));

                // 3. æµ‹è¯• API ç«¯ç‚¹
                await testApiEndpoint();
                await new Promise(resolve => setTimeout(resolve, 500));

                // 4. æµ‹è¯• TTS è¯·æ±‚
                await testTTSRequest();

                showResult('full-test-status', 'âœ… å®Œæ•´æµ‹è¯•æµç¨‹é€šè¿‡', 'success');
                log('å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ', 'success');

            } catch (error) {
                showResult('full-test-status', `âŒ å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log('å®Œæ•´æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        function clearTTSResults() {
            document.getElementById('tts-status').style.display = 'none';
            log('æ¸…é™¤äº† TTS æµ‹è¯•ç»“æœ', 'info');
        }

        // åˆå§‹åŒ–
        log('DashScope TTS è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
        log('è¯·æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç›´æ¥è¿è¡Œå®Œæ•´æµ‹è¯•', 'info');
    </script>
</body>
</html>