<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muse | å¥¹çš„æƒ…æ¬²ç”»å»Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muse: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#121212',
                            rose: '#e11d48', 
                            gold: '#e5e5e5',
                            dim: '#525252',
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* === Background Slideshow (Double Buffer) === */
        .hero-slideshow {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            overflow: hidden;
        }
        .slide-image {
            position: absolute;
            inset: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 3s ease-in-out, transform 8s ease-out; 
            transform: scale(1.1);
            filter: contrast(1.1) brightness(0.6) blur(1px);
            z-index: 0;
            will-change: opacity, transform;
        }
        .slide-image.active {
            opacity: 1;
            transform: scale(1);
            z-index: 2;
        }
        .slide-image.previous {
            opacity: 1 !important;
            z-index: 1;
        }

        /* === UI Elements === */
        .flow-text-layer {
            font-family: "Playfair Display", serif; 
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 0 40px rgba(225, 29, 72, 0.6); 
            letter-spacing: 0.15em;
            mix-blend-mode: overlay;
        }
        .glass-panel { 
            background: rgba(10, 10, 10, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        .voice-card { position: relative; }
        .voice-card.selected {
            border-color: #e11d48;
            background: rgba(225, 29, 72, 0.1);
        }
        .indicator-dot {
            height: 8px; width: 8px; border-radius: 50%;
            background-color: #e11d48;
            display: none;
            box-shadow: 0 0 8px #e11d48;
        }
        .voice-card.selected .indicator-dot { display: block; }
        
        /* é—®å·é€‰é¡¹æ ·å¼ */
        .option-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .selected-option {
            border-color: #e11d48 !important;
            background: rgba(225, 29, 72, 0.15) !important;
            transform: scale(1.02) !important;
            box-shadow: 0 0 20px rgba(225, 29, 72, 0.3) !important;
        }
        
        .option-item:hover {
            transform: scale(1.02);
        }
        
        .selected-option:hover {
            transform: scale(1.03) !important;
        }
        
        /* åœºæ™¯é€‰æ‹©æ ·å¼ */
        .scene-type-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .scene-type-btn.active {
            background: rgba(225, 29, 72, 0.2) !important;
            border-color: rgba(225, 29, 72, 0.3) !important;
            color: white !important;
        }
        
        .preset-scene-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .preset-scene-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* èƒŒæ™¯é€‰æ‹©æ ·å¼ */
        .bg-option {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .bg-option:hover {
            transform: scale(1.05);
        }
        
        /* èŠå¤©èƒŒæ™¯é®ç½© */
        .chat-bg-overlay {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%);
            backdrop-filter: blur(1px);
        }
        
        @media (max-width: 768px) {
            #chat-interface {
                position: fixed; inset: 0; z-index: 60; background-color: #0a0a0a;
            }
        }
    </style>
</head>
<body class="bg-muse-black text-muse-gold font-sans antialiased overflow-x-hidden selection:bg-muse-rose selection:text-white">

    <!-- 1. HERO SECTION -->
    <section id="landing-page" class="relative w-full h-screen overflow-hidden flex flex-col items-center justify-center z-50 bg-muse-black transition-opacity duration-1000">
        <div class="hero-slideshow" id="slideshow-container">
            <div class="absolute inset-0 bg-gradient-to-b from-muse-black/30 via-transparent to-muse-black/90 z-20 pointer-events-none"></div>
            <div class="absolute inset-0 opacity-[0.08] z-20 pointer-events-none" style="background-image: url('https://grainy-gradients.vercel.app/noise.svg');"></div>
        </div>
        <div class="relative z-30 text-center px-6 flex flex-col items-center">
            <div class="mb-8 animate-fade-in">
                <h1 class="flow-text-layer text-7xl md:text-[10rem] font-black leading-none select-none">MUSE</h1>
            </div>
            <p class="font-serif italic text-white/70 text-lg md:text-xl mb-12 animate-fade-in mix-blend-screen" style="animation-delay: 0.2s;">Your Narrative. Your Pleasure.</p>
            <div class="animate-fade-in" style="animation-delay: 0.4s;">
                <button onclick="enterPrism()" class="group relative px-10 py-4 overflow-hidden rounded-full border border-white/20 hover:border-muse-rose transition-all duration-500 bg-white/5 backdrop-blur-md">
                    <div class="absolute inset-0 w-0 bg-muse-rose/40 transition-all duration-500 ease-out group-hover:w-full"></div>
                    <span class="relative font-serif text-xs tracking-[0.25em] text-white group-hover:text-white transition-colors duration-300 uppercase">ä»Šæ™šä½ ä¹Ÿç¡ä¸ç€å—ï¼Ÿ</span>
                </button>
            </div>
        </div>
    </section>

    <!-- 2. The Prism (Quiz) -->
    <section id="prism-modal" class="fixed inset-0 z-[60] hidden bg-muse-black/95 backdrop-blur-xl flex items-center justify-center p-6 transition-opacity duration-500 overflow-y-auto">
        <div class="max-w-xl w-full relative">
            <button onclick="closePrism()" class="absolute -top-12 right-0 md:top-0 md:-right-12 text-stone-500 hover:text-white p-2 z-50"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="mb-8 flex justify-between items-end border-b border-white/10 pb-4">
                <h2 class="font-serif text-3xl text-muse-gold">The Prism</h2>
                <span class="text-xs text-muse-dim tracking-widest" id="prism-step-indicator">STEP 1 / 3</span>
            </div>
            <div id="question-container" class="min-h-[300px] flex flex-col justify-center animate-fade-in"></div>
            <div class="flex justify-between mt-8">
                <button onclick="prevQuestion()" id="prev-btn" class="text-muse-dim hover:text-white text-xs tracking-widest invisible flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> BACK</button>
            </div>
        </div>
    </section>

    <!-- 3. Main Dashboard -->
    <main id="main-content" class="fixed inset-0 top-0 w-full h-full hidden flex-col md:flex-row z-40 bg-muse-black transition-opacity duration-1000 opacity-0 overflow-y-auto md:overflow-hidden">
        <div id="global-nav" class="sticky top-0 z-50 flex justify-between items-center p-4 bg-muse-black/80 backdrop-blur-md md:absolute md:top-6 md:right-6 md:bg-transparent md:p-0 md:justify-end border-b border-white/5 md:border-none transition-opacity duration-300">
            <div class="md:hidden font-serif text-muse-gold tracking-widest text-lg">MUSE</div>
            <div class="flex gap-4 items-center">
                <button onclick="openPrism()" class="text-[10px] text-muse-dim hover:text-white tracking-widest transition">PROFILE</button>
                <button onclick="openApiKeySettings()" class="text-[10px] text-muse-dim hover:text-white tracking-widest transition">KEY</button>
            </div>
        </div>

        <!-- Left: AI Solo Fantasy -->
        <div class="relative w-full md:w-5/12 min-h-[80vh] md:h-full border-b md:border-b-0 md:border-r border-white/5 flex flex-col bg-muse-panel shrink-0">
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                <div class="absolute -top-[20%] -left-[20%] w-[150%] h-[150%] bg-[url('https://images.unsplash.com/photo-1505322022379-7c3353ee6291?q=80&w=1000&auto=format&fit=crop')] bg-cover opacity-10 blur-sm mix-blend-overlay"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-muse-panel via-muse-panel/90 to-transparent"></div>
            </div>
            <div class="relative z-10 flex-1 flex flex-col p-8 md:p-12 justify-center">
                <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-muse-rose animate-pulse"></span>Scene Creator</span>
                <h2 class="font-serif text-3xl md:text-4xl text-muse-gold mb-4">åœºæ™¯ç¼–å‰§</h2>
                <p class="text-muse-dim text-sm mb-6 font-light leading-relaxed max-w-sm">åˆ›å»ºä½ çš„ä¸“å±åœºæ™¯ï¼Œå³ä¾§å¯¹è¯å°†åŸºäºä½ çš„è®¾å®šå±•å¼€ã€‚é€‰æ‹©é¢„è®¾åœºæ™¯æˆ–è‡ªå®šä¹‰ç‹¬ç‰¹çš„æ•…äº‹èƒŒæ™¯ã€‚</p>
                
                <!-- åœºæ™¯é€‰æ‹© -->
                <div class="mb-6">
                    <label class="block text-xs font-medium text-stone-300 mb-3">é€‰æ‹©åœºæ™¯ç±»å‹</label>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="selectSceneType('custom')" id="custom-btn" class="scene-type-btn active px-3 py-2 text-xs rounded border border-white/10 bg-muse-rose/20 text-white transition">è‡ªå®šä¹‰</button>
                        <button onclick="selectSceneType('preset')" id="preset-btn" class="scene-type-btn px-3 py-2 text-xs rounded border border-white/10 bg-white/5 text-stone-400 transition">é¢„è®¾åœºæ™¯</button>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰åœºæ™¯è¾“å…¥ -->
                <div id="custom-scene" class="mb-4">
                    <input type="text" id="custom-scene-input" placeholder="æè¿°ä½ çš„åœºæ™¯ï¼šå¦‚'å’–å•¡å…è§’è½çš„åˆåé˜³å…‰'..." class="w-full bg-black/30 border border-white/10 rounded-lg p-4 text-muse-gold placeholder-muse-dim focus:outline-none focus:border-muse-rose transition backdrop-blur-sm text-sm">
                </div>

                <!-- é¢„è®¾åœºæ™¯é€‰æ‹© -->
                <div id="preset-scenes" class="hidden mb-4">
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="selectPresetScene('library')" class="preset-scene-btn text-left p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-muse-rose/50 transition">
                            <div class="text-sm text-white">ğŸ“š æ·±å¤œå›¾ä¹¦é¦†</div>
                            <div class="text-xs text-stone-400">ä¹¦é¦™ä¸­çš„ç§˜å¯†é‚‚é€…</div>
                        </button>
                        <button onclick="selectPresetScene('rooftop')" class="preset-scene-btn text-left p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-muse-rose/50 transition">
                            <div class="text-sm text-white">ğŸŒƒ å¤©å°å¤œæ™¯</div>
                            <div class="text-xs text-stone-400">åŸå¸‚ç¯ç«ä¸‹çš„å¿ƒåŠ¨</div>
                        </button>
                        <button onclick="selectPresetScene('cafe')" class="preset-scene-btn text-left p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-muse-rose/50 transition">
                            <div class="text-sm text-white">â˜• åˆå¤œå’–å•¡å…</div>
                            <div class="text-xs text-stone-400">æ¸©æš–ç¯å…‰ä¸­çš„æ¸©æŸ”æ—¶å…‰</div>
                        </button>
                        <button onclick="selectPresetScene('garden')" class="preset-scene-btn text-left p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 hover:border-muse-rose/50 transition">
                            <div class="text-sm text-white">ğŸŒ™ æœˆä¸‹èŠ±å›­</div>
                            <div class="text-xs text-stone-400">èŠ±é¦™ä¸æœˆå…‰çš„æµªæ¼«</div>
                        </button>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="generateSceneScript()" id="scene-script-btn" class="w-full py-3 bg-white/5 hover:bg-muse-rose text-white text-xs tracking-[0.2em] rounded-lg transition duration-500 border border-white/5 hover:border-transparent">ç”Ÿæˆåœºæ™¯æè¿°</button>
                    <button onclick="startSceneChat()" id="start-chat-btn" class="w-full py-3 bg-muse-rose/20 hover:bg-muse-rose text-white text-xs tracking-[0.2em] rounded-lg transition duration-500 border border-muse-rose/30 hover:border-transparent disabled:opacity-50 disabled:cursor-not-allowed" disabled>å¼€å§‹å¯¹è¯</button>
                    <div id="scene-result" class="hidden mt-4 p-4 border-l border-muse-rose/30 bg-white/5 rounded-r-lg text-muse-gold/90 text-sm font-serif leading-loose italic max-h-[30vh] overflow-y-auto no-scrollbar animate-fade-in"></div>
                </div>
            </div>
        </div>

        <!-- Right: Interactive Story -->
        <div class="relative w-full md:w-7/12 min-h-[100vh] md:h-full flex flex-col bg-muse-black">
            <div id="scenario-selector" class="flex-1 p-6 md:p-12 overflow-y-auto no-scrollbar pb-24">
                <div class="mb-8">
                    <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 block">Interactive Roleplay</span>
                    <h2 class="font-serif text-3xl md:text-4xl text-muse-gold">æ²‰æµ¸å¯¹è¯</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div onclick="startStory('elevator')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1595435934249-5df7ed86e1c0?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4"><h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">ç§äººç”µæ¢¯</h3><p class="text-[10px] text-muse-dim uppercase tracking-widest">Confined Â· Breath</p></div>
                    </div>
                    <div onclick="startStory('office')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1504593811423-6dd665756598?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4"><h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æ·±å¤œåŠå…¬å®¤</h3><p class="text-[10px] text-muse-dim uppercase tracking-widest">Power Â· Silence</p></div>
                    </div>
                    <div onclick="startStory('bedroom')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4"><h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">è¿·ç¦»å§å®¤</h3><p class="text-[10px] text-muse-dim uppercase tracking-widest">Intimate Â· Skin</p></div>
                    </div>
                    <div onclick="startStory('car')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4"><h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æš´é›¨è½¦å†…</h3><p class="text-[10px] text-muse-dim uppercase tracking-widest">Sound Â· Heat</p></div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="hidden flex-col h-full bg-muse-black">
                <div class="p-3 border-b border-white/5 flex justify-between items-center bg-muse-panel/80 backdrop-blur-sm pt-safe-top">
                    <div class="flex items-center gap-3">
                        <button onclick="exitStory()" class="text-muse-dim hover:text-white transition p-2"><i class="fa-solid fa-chevron-left"></i></button>
                        <div><h3 class="font-serif text-base text-white" id="chat-title">Story Title</h3></div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleSettings()" class="text-[10px] text-muse-gold/80 border border-white/10 hover:border-muse-rose rounded-full px-3 py-1.5 transition flex items-center gap-2 bg-white/5"><i class="fa-solid fa-sliders"></i> <span id="current-persona-label">Default</span></button>
                        <button onclick="toggleVoiceOutput()" id="tts-toggle" class="text-[10px] text-muse-rose border border-muse-rose hover:text-muse-rose rounded-full px-2.5 py-1.5 transition bg-white/5"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                </div>

                <div id="settings-popover" class="absolute top-16 right-4 z-50 bg-muse-panel border border-white/10 rounded-xl p-4 w-72 shadow-2xl hidden glass-panel animate-fade-in">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xs text-muse-dim uppercase tracking-widest">Settings</h4>
                        <button onclick="toggleSettings()" class="text-stone-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-1">Target Gender</label>
                            <select id="setting-gender" class="w-full bg-black/50 text-xs text-white border border-white/10 rounded p-2 focus:border-muse-rose outline-none" onchange="updateLiveSettings()">
                                <option value="masculine">é˜³åˆš (Masculine)</option>
                                <option value="feminine">é˜´æŸ” (Feminine)</option>
                                <option value="neutral">ä¸­æ€§ (Neutral)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-2">Voice Tone</label>
                            <div class="space-y-2">
                                <div class="voice-card border border-white/10 rounded p-2 flex items-center cursor-pointer hover:border-white/30 transition" onclick="selectVoice('yushao', this)">
                                    <div class="mr-3 flex items-center justify-center"><div class="w-4 h-4 rounded-full border border-stone-600 flex items-center justify-center"><div class="indicator-dot"></div></div></div>
                                    <div class="flex-1"><div class="text-xs text-stone-300">ğŸ· ä½æ²‰å¾¡å°‘éŸ³</div><div class="text-[9px] text-stone-500">Kai Â· çŸ¥æ€§</div></div>
                                    <button onclick="event.stopPropagation(); playSample('yushao', this)" class="text-muse-dim hover:text-muse-rose px-2"><i class="fa-solid fa-play"></i></button>
                                </div>
                                <div class="voice-card border border-white/10 rounded p-2 flex items-center cursor-pointer hover:border-white/30 transition" onclick="selectVoice('shaonian', this)">
                                    <div class="mr-3 flex items-center justify-center"><div class="w-4 h-4 rounded-full border border-stone-600 flex items-center justify-center"><div class="indicator-dot"></div></div></div>
                                    <div class="flex-1"><div class="text-xs text-stone-300">â„ï¸ æ¸…å†·å°‘å¹´éŸ³</div><div class="text-[9px] text-stone-500">Nofish Â· æ¸…è„†</div></div>
                                    <button onclick="event.stopPropagation(); playSample('shaonian', this)" class="text-muse-dim hover:text-muse-rose px-2"><i class="fa-solid fa-play"></i></button>
                                </div>
                                <div class="voice-card border border-white/10 rounded p-2 flex items-center cursor-pointer hover:border-white/30 transition" onclick="selectVoice('dashu', this)">
                                    <div class="mr-3 flex items-center justify-center"><div class="w-4 h-4 rounded-full border border-stone-600 flex items-center justify-center"><div class="indicator-dot"></div></div></div>
                                    <div class="flex-1"><div class="text-xs text-stone-300">ğŸ¥ƒ æ¸©æŸ”å¤§å”éŸ³</div><div class="text-[9px] text-stone-500">Lenn Â· æ²‰ç¨³</div></div>
                                    <button onclick="event.stopPropagation(); playSample('dashu', this)" class="text-muse-dim hover:text-muse-rose px-2"><i class="fa-solid fa-play"></i></button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-1">Atmosphere</label>
                            <select id="setting-vibe" class="w-full bg-black/50 text-xs text-white border border-white/10 rounded p-2 focus:border-muse-rose outline-none" onchange="updateLiveSettings()">
                                <option value="tension">æš§æ˜§æ‹‰æ‰¯ (Tension)</option>
                                <option value="romantic">æµªæ¼«å”¯ç¾ (Romantic)</option>
                                <option value="taboo">ç¦å¿Œåˆºæ¿€ (Taboo)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-2">Chat Background</label>
                            <div class="grid grid-cols-3 gap-2">
                                <div onclick="selectChatBackground('', 'ç»å…¸é»‘è‰²')" class="bg-option cursor-pointer border border-white/10 rounded p-1 hover:border-muse-rose/50 transition">
                                    <div class="w-full h-12 bg-muse-black rounded flex items-center justify-center">
                                        <i class="fa-solid fa-moon text-muse-dim text-xs"></i>
                                    </div>
                                    <div class="text-[8px] text-stone-400 text-center mt-1">ç»å…¸</div>
                                </div>
                                <div onclick="selectChatBackground('https://picsum.photos/1920/1080?random=10&blur=2', 'æš§æ˜§ç¯å…‰')" class="bg-option cursor-pointer border border-white/10 rounded p-1 hover:border-muse-rose/50 transition">
                                    <div class="w-full h-12 bg-gradient-to-br from-orange-900 to-red-900 rounded flex items-center justify-center">
                                        <i class="fa-solid fa-lightbulb text-orange-300 text-xs"></i>
                                    </div>
                                    <div class="text-[8px] text-stone-400 text-center mt-1">æš§æ˜§</div>
                                </div>
                                <div onclick="selectChatBackground('https://picsum.photos/1920/1080?random=11&blur=2', 'æ¸©æŸ”å¤œè‰²')" class="bg-option cursor-pointer border border-white/10 rounded p-1 hover:border-muse-rose/50 transition">
                                    <div class="w-full h-12 bg-gradient-to-br from-blue-900 to-purple-900 rounded flex items-center justify-center">
                                        <i class="fa-solid fa-moon text-blue-300 text-xs"></i>
                                    </div>
                                    <div class="text-[8px] text-stone-400 text-center mt-1">æ¸©æŸ”</div>
                                </div>
                                <div onclick="selectChatBackground('https://picsum.photos/1920/1080?random=12&blur=2', 'ç§å¯†ç©ºé—´')" class="bg-option cursor-pointer border border-white/10 rounded p-1 hover:border-muse-rose/50 transition">
                                    <div class="w-full h-12 bg-gradient-to-br from-purple-900 to-pink-900 rounded flex items-center justify-center">
                                        <i class="fa-solid fa-heart text-pink-300 text-xs"></i>
                                    </div>
                                    <div class="text-[8px] text-stone-400 text-center mt-1">ç§å¯†</div>
                                </div>
                                <div onclick="selectChatBackground('https://picsum.photos/1920/1080?random=13&blur=2', 'æœ¦èƒ§æ°›å›´')" class="bg-option cursor-pointer border border-white/10 rounded p-1 hover:border-muse-rose/50 transition">
                                    <div class="w-full h-12 bg-gradient-to-br from-gray-800 to-gray-600 rounded flex items-center justify-center">
                                        <i class="fa-solid fa-cloud text-gray-300 text-xs"></i>
                                    </div>
                                    <div class="text-[8px] text-stone-400 text-center mt-1">æœ¦èƒ§</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-4"></div>
                <div class="p-4 bg-muse-black border-t border-white/5 pb-safe-bottom">
                    <div class="relative max-w-2xl mx-auto flex gap-2">
                        <button id="mic-btn" onmousedown="startListening()" onmouseup="stopListening()" ontouchstart="startListening()" ontouchend="stopListening()" class="bg-white/5 hover:bg-white/10 text-muse-dim hover:text-muse-rose rounded-full w-12 h-12 flex items-center justify-center transition border border-white/10 shrink-0"><i class="fa-solid fa-microphone"></i></button>
                        <div class="flex-1 relative">
                            <input type="text" id="story-input" placeholder="è¾“å…¥æˆ–æŒ‰ä½è¯´è¯..." class="w-full h-12 bg-white/5 border border-white/10 rounded-full pl-6 pr-12 text-sm text-muse-gold focus:outline-none focus:border-muse-rose focus:bg-white/10 transition" onkeypress="if(event.key==='Enter') continueStory()">
                            <button onclick="continueStory()" class="absolute right-2 top-2 p-2 text-muse-dim hover:text-muse-rose transition bg-white/5 rounded-full hover:bg-white/10 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- API Key Modal -->
    <div id="apikey-modal" class="fixed inset-0 z-[70] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel max-w-md w-full p-8 rounded-lg">
            <h3 class="font-serif text-xl text-muse-gold mb-2">Settings</h3>
            <div class="flex gap-2 mb-4 bg-white/5 p-1 rounded">
                <button onclick="switchProvider('gemini')" id="btn-gemini" class="flex-1 py-2 text-xs rounded transition text-white bg-muse-rose">GEMINI</button>
                <button onclick="switchProvider('dashscope')" id="btn-dashscope" class="flex-1 py-2 text-xs rounded transition text-stone-400">ALIYUN</button>
            </div>
            <div id="input-group-gemini">
                <input type="password" id="gemini-key-input" placeholder="Paste Gemini Key..." class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-muse-gold mb-4 text-sm">
            </div>
            <div id="input-group-dashscope" class="hidden">
                <input type="password" id="dashscope-key-input" placeholder="Paste DashScope Key..." class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-muse-gold mb-2 text-sm">
                <button onclick="testDashScopeTTS()" class="w-full bg-white/5 hover:bg-muse-rose/20 text-muse-gold border border-white/10 hover:border-muse-rose py-2 rounded text-xs tracking-widest mb-2">TEST TTS</button>
                <button onclick="openDebugPage()" class="w-full bg-white/5 hover:bg-blue-500/20 text-blue-300 border border-white/10 hover:border-blue-500 py-2 rounded text-xs tracking-widest mb-2">ğŸ”§ DEBUG TOOL</button>
            </div>
            <div class="mb-4">
                <label class="flex items-center gap-2 text-xs text-stone-400">
                    <input type="checkbox" id="debug-mode-toggle" onchange="toggleDebugMode()" class="rounded">
                    å¯ç”¨è°ƒè¯•æ¨¡å¼ (æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—)
                </label>
            </div>
            <button onclick="saveApiSettings()" class="w-full bg-white/10 hover:bg-muse-rose text-white py-2 rounded text-xs tracking-widest">SAVE</button>
            <button onclick="document.getElementById('apikey-modal').classList.add('hidden')" class="w-full mt-2 text-stone-500 text-xs hover:text-white">CLOSE</button>
        </div>
    </div>

    <script src="js/tts/TTSConfig.js"></script>
    <script src="js/tts/DashScopeEngine.js"></script>
    <script src="js/tts/WebSpeechEngine.js"></script>
    <script src="js/tts/TTSService.js"></script>
    <script>
        // ========== 1. ä¼˜åŒ–çš„å›¾ç‰‡è½®æ’­ç³»ç»Ÿ ==========
        const backgroundImages = [
            // ä½¿ç”¨æœ¬åœ°æµªæ¼«ä¸»é¢˜å›¾ç‰‡
            "images/backgrounds/bg1.jpg", // ç¬¬ä¸€å¼ æµªæ¼«å›¾ç‰‡
            "images/backgrounds/bg2.png", // ç¬¬äºŒå¼ æµªæ¼«å›¾ç‰‡
            "images/backgrounds/bg3.png", // ç¬¬ä¸‰å¼ æµªæ¼«å›¾ç‰‡
            "images/backgrounds/bg4.png", // ç¬¬å››å¼ æµªæ¼«å›¾ç‰‡
            "images/backgrounds/bg5.png", // ç¬¬äº”å¼ æµªæ¼«å›¾ç‰‡
            "images/backgrounds/bg6.png"  // ç¬¬å…­å¼ æµªæ¼«å›¾ç‰‡
        ];

        let slideshowInterval;
        let preloadedImages = [];
        let currentSlideIndex = 0;

        // åˆ›å»ºæµªæ¼«ä¸»é¢˜çš„CSSæ¸å˜èƒŒæ™¯ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
        function createFallbackBackground() {
            console.log('ä½¿ç”¨æµªæ¼«ä¸»é¢˜æ¸å˜èƒŒæ™¯ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
            const container = document.getElementById('slideshow-container');
            if (!container) return;
            
            // åˆ›å»ºå¤šå±‚æ¸å˜èƒŒæ™¯å…ƒç´ 
            const gradientBg = document.createElement('div');
            gradientBg.style.cssText = `
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                background: 
                    radial-gradient(circle at 20% 80%, rgba(225, 29, 72, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(147, 51, 234, 0.3) 0%, transparent 50%),
                    linear-gradient(135deg, 
                        #0f0f23 0%, 
                        #1a1a2e 25%, 
                        #16213e 50%, 
                        #0f3460 75%, 
                        #533483 100%);
                opacity: 0.9;
                z-index: 1;
                filter: blur(0.5px);
            `;
            container.appendChild(gradientBg);
            
            // æ·»åŠ åŠ¨æ€å…‰æ•ˆ
            const lightEffect = document.createElement('div');
            lightEffect.style.cssText = `
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                background: 
                    radial-gradient(circle at var(--x, 50%) var(--y, 50%), 
                        rgba(225, 29, 72, 0.1) 0%, 
                        transparent 70%);
                z-index: 2;
                pointer-events: none;
                opacity: 0.8;
            `;
            container.appendChild(lightEffect);
            
            // æ·»åŠ åŠ¨æ€æ•ˆæœ
            let angle = 0;
            setInterval(() => {
                angle += 0.5;
                const x = 50 + Math.sin(angle * 0.01) * 30;
                const y = 50 + Math.cos(angle * 0.01) * 30;
                lightEffect.style.setProperty('--x', x + '%');
                lightEffect.style.setProperty('--y', y + '%');
                
                gradientBg.style.filter = `blur(0.5px) hue-rotate(${angle * 0.5}deg)`;
            }, 100);
        }

        // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
        function preloadImages() {
            console.log('å¼€å§‹é¢„åŠ è½½æµªæ¼«ä¸»é¢˜èƒŒæ™¯å›¾ç‰‡...');
            return Promise.all(backgroundImages.map((src, index) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        console.log(`æµªæ¼«å›¾ç‰‡ ${index + 1} é¢„åŠ è½½æˆåŠŸ:`, src);
                        preloadedImages[index] = img;
                        resolve(img);
                    };
                    img.onerror = (error) => {
                        console.warn(`æµªæ¼«å›¾ç‰‡ ${index + 1} é¢„åŠ è½½å¤±è´¥:`, src, error);
                        console.log('æç¤ºï¼šè¯·ç¡®ä¿å›¾ç‰‡æ–‡ä»¶å­˜åœ¨äº images/backgrounds/ ç›®å½•ä¸­');
                        console.log(`ç¼ºå¤±æ–‡ä»¶: ${src}`);
                        resolve(null); // å¤±è´¥ä¹Ÿç»§ç»­
                    };
                    img.src = src;
                    
                    // 10ç§’è¶…æ—¶
                    setTimeout(() => {
                        if (!preloadedImages[index]) {
                            console.warn(`æµªæ¼«å›¾ç‰‡ ${index + 1} åŠ è½½è¶…æ—¶`);
                            resolve(null);
                        }
                    }, 10000);
                });
            }));
        }

        function initSlideshow() {
            console.log('åˆå§‹åŒ–æµªæ¼«ä¸»é¢˜è½®æ’­ç³»ç»Ÿ...');
            const container = document.getElementById('slideshow-container');
            if (!container) {
                console.error('æ‰¾ä¸åˆ°è½®æ’­å®¹å™¨å…ƒç´ ');
                return;
            }
            
            // æ¸…é™¤æ—§å†…å®¹
            const oldElements = container.querySelectorAll('img, div');
            oldElements.forEach(el => el.remove());

            // æ£€æŸ¥æ˜¯å¦æœ‰æˆåŠŸé¢„åŠ è½½çš„å›¾ç‰‡
            const validImages = preloadedImages.filter(img => img !== null);
            
            if (validImages.length === 0) {
                console.log('æ²¡æœ‰å¯ç”¨çš„æµªæ¼«èƒŒæ™¯å›¾ç‰‡ï¼Œä½¿ç”¨ä¸»é¢˜æ¸å˜èƒŒæ™¯');
                createFallbackBackground();
                return;
            }

            console.log(`ä½¿ç”¨ ${validImages.length} å¼ æµªæ¼«ä¸»é¢˜å›¾ç‰‡`);

            // åˆ›å»ºç¬¬ä¸€å¼ å›¾ç‰‡
            const firstImg = document.createElement('img');
            firstImg.src = validImages[0].src;
            firstImg.className = 'slide-image';
            firstImg.style.cssText = `
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
                opacity: 1;
                z-index: 2;
                transform: scale(1);
                filter: contrast(1.2) brightness(0.7) saturate(1.1);
                transition: opacity 4s ease-in-out, transform 10s ease-out;
            `;
            container.appendChild(firstImg);

            // åˆ›å»ºå…¶ä»–å›¾ç‰‡
            validImages.forEach((img, index) => {
                if (index === 0) return; // ç¬¬ä¸€å¼ å·²æ·»åŠ 
                
                const slideImg = document.createElement('img');
                slideImg.src = img.src;
                slideImg.className = 'slide-image';
                slideImg.style.cssText = `
                    position: absolute;
                    inset: 0;
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    opacity: 0;
                    z-index: 0;
                    transform: scale(1.05);
                    filter: contrast(1.2) brightness(0.7) saturate(1.1);
                    transition: opacity 4s ease-in-out, transform 10s ease-out;
                `;
                container.appendChild(slideImg);
            });
            
            console.log('å¼€å§‹æµªæ¼«ä¸»é¢˜è½®æ’­');
            startSlideshow();
        }

        function startSlideshow() {
            if (slideshowInterval) clearInterval(slideshowInterval);
            
            let slideIndex = 0;
            const effects = ['fade', 'slide', 'zoom', 'parallax'];
            let currentEffect = 0;
            
            slideshowInterval = setInterval(() => {
                const container = document.getElementById('slideshow-container');
                const images = container.querySelectorAll('img');
                const currentImg = images[slideIndex];
                slideIndex = (slideIndex + 1) % images.length;
                const nextImg = images[slideIndex];
                
                // å¾ªç¯ä½¿ç”¨ä¸åŒçš„åˆ‡æ¢æ•ˆæœ
                const effect = effects[currentEffect % effects.length];
                currentEffect++;
                
                applyTransitionEffect(currentImg, nextImg, effect);
                
            }, 4000); // 4ç§’åˆ‡æ¢ä¸€æ¬¡ï¼Œæ›´å¿«çš„åˆ‡æ¢é€Ÿåº¦
        }

        function applyTransitionEffect(currentImg, nextImg, effect) {
            switch(effect) {
                case 'fade':
                    // æµªæ¼«æ·¡å…¥æ·¡å‡º + è½»å¾®ç¼©æ”¾
                    nextImg.style.transition = 'all 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    nextImg.style.opacity = '1';
                    nextImg.style.zIndex = '2';
                    nextImg.style.transform = 'scale(1)';
                    
                    currentImg.style.transition = 'all 2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    currentImg.style.opacity = '0';
                    currentImg.style.transform = 'scale(1.1)';
                    break;
                    
                case 'slide':
                    // æ¸©æŸ”æ»‘åŠ¨æ•ˆæœ
                    nextImg.style.transform = 'translateX(100%) scale(1)';
                    nextImg.style.opacity = '1';
                    nextImg.style.zIndex = '2';
                    nextImg.style.transition = 'all 2s cubic-bezier(0.4, 0, 0.2, 1)';
                    
                    setTimeout(() => {
                        nextImg.style.transform = 'translateX(0) scale(1)';
                        currentImg.style.transform = 'translateX(-100%) scale(1.05)';
                        currentImg.style.transition = 'all 2s cubic-bezier(0.4, 0, 0.2, 1)';
                    }, 50);
                    break;
                    
                case 'zoom':
                    // æ¢¦å¹»ç¼©æ”¾æ•ˆæœ
                    nextImg.style.transform = 'scale(1.3)';
                    nextImg.style.opacity = '0';
                    nextImg.style.zIndex = '2';
                    nextImg.style.transition = 'all 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    
                    setTimeout(() => {
                        nextImg.style.opacity = '1';
                        nextImg.style.transform = 'scale(1)';
                        currentImg.style.opacity = '0';
                        currentImg.style.transform = 'scale(0.8)';
                        currentImg.style.transition = 'all 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    }, 50);
                    break;
                    
                case 'parallax':
                    // æµªæ¼«è§†å·®æ•ˆæœ
                    nextImg.style.transform = 'scale(1.2) translateY(30px)';
                    nextImg.style.opacity = '0';
                    nextImg.style.zIndex = '2';
                    nextImg.style.transition = 'all 3s cubic-bezier(0.23, 1, 0.32, 1)';
                    
                    setTimeout(() => {
                        nextImg.style.opacity = '1';
                        nextImg.style.transform = 'scale(1) translateY(0)';
                        currentImg.style.opacity = '0';
                        currentImg.style.transform = 'scale(1.1) translateY(-30px)';
                        currentImg.style.transition = 'all 3s cubic-bezier(0.23, 1, 0.32, 1)';
                    }, 50);
                    break;
            }
            
            // é‡ç½®å½“å‰å›¾ç‰‡çŠ¶æ€
            setTimeout(() => {
                currentImg.style.zIndex = '0';
                currentImg.style.transform = 'scale(1.05)';
                currentImg.style.opacity = '0';
            }, 2500);
        }

        // ========== 2. Prism Logic ==========
        const quizData = [
            { id: 'orientation', question: "ä½ çš„å¿ƒï¼Œè¢«ä»€ä¹ˆå¸å¼•ï¼Ÿ", options: [{ label: "é˜³åˆšæ°”è´¨ (Masculinity)", value: "masculine" }, { label: "é˜´æŸ”æ°”è´¨ (Femininity)", value: "feminine" }, { label: "æŒæ§ä¸ä¸»å¯¼ (Dominance)", value: "dom" }, { label: "çµé­‚å…±é¸£ (Soul)", value: "fluid" }] },
            { id: 'atmosphere', question: "ä½ åçˆ±æ€æ ·çš„æ°›å›´ï¼Ÿ", options: [{ label: "æš§æ˜§æ‹‰æ‰¯ (Tension)", value: "tension" }, { label: "ç¦å¿Œåˆºæ¿€ (Taboo)", value: "taboo" }, { label: "æ¸©æŸ”æ²»æ„ˆ (Gentle)", value: "gentle" }, { label: "ç»å¯¹æœä» (Submission)", value: "submission" }] },
            { id: 'style', question: "å‰§æœ¬é£æ ¼åå¥½ï¼Ÿ", options: [{ label: "å”¯ç¾å«è“„ (Poetic)", value: "poetic" }, { label: "ç›´ç™½ç‚½çƒ­ (Intense)", value: "intense" }] }
        ];
        let currentStep = 0;
        let userProfile = { orientation: 'masculine', atmosphere: 'tension', style: 'poetic' };

        function enterPrism() {
            document.getElementById('landing-page').style.opacity = '0';
            document.getElementById('global-nav').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('prism-modal').classList.remove('hidden');
                renderQuestion();
            }, 500);
        }
        function closePrism() {
            const hasProfile = localStorage.getItem('muse_profile');
            document.getElementById('prism-modal').classList.add('hidden');
            if(hasProfile) {
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('main-content').classList.add('flex');
                document.getElementById('global-nav').classList.remove('hidden');
                setTimeout(() => document.getElementById('main-content').classList.remove('opacity-0'), 100);
            } else {
                document.getElementById('landing-page').style.display = 'flex';
                document.getElementById('global-nav').classList.remove('hidden');
                setTimeout(() => document.getElementById('landing-page').style.opacity = '1', 50);
            }
        }
        function renderQuestion() {
            const q = quizData[currentStep];
            const container = document.getElementById('question-container');
            
            // æ·»åŠ æ·¡å‡ºæ•ˆæœ
            container.style.opacity = '0';
            container.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                // æ›´æ–°å†…å®¹
                document.getElementById('prism-step-indicator').innerText = `STEP ${currentStep + 1} / ${quizData.length}`;
                let html = `<h3 class="text-2xl font-serif text-white mb-8">${q.question}</h3><div class="grid grid-cols-1 gap-3">`;
                q.options.forEach(opt => {
                    const isSelected = userProfile[q.id] === opt.value;
                    html += `<div onclick="selectOption('${q.id}', '${opt.value}')" class="option-item cursor-pointer border border-white/10 rounded-lg p-4 transition-all duration-300 ease-out hover:bg-white/5 hover:border-muse-rose/50 hover:transform hover:scale-105 ${isSelected ? 'selected-option' : ''}"><div class="font-serif text-lg">${opt.label}</div></div>`;
                });
                container.innerHTML = html + `</div>`;
                document.getElementById('prev-btn').style.visibility = currentStep > 0 ? 'visible' : 'hidden';
                
                // æ·»åŠ æ·¡å…¥æ•ˆæœ
                container.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                container.style.opacity = '1';
                container.style.transform = 'translateY(0)';
            }, 50);
        }
        function selectOption(key, value) {
            userProfile[key] = value;
            
            // ç«‹å³æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼Œé¿å…é‡æ–°æ¸²æŸ“
            const clickedElement = event.target.closest('.option-item');
            if (clickedElement) {
                // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                const container = document.getElementById('question-container');
                container.querySelectorAll('.selected-option').forEach(el => {
                    el.classList.remove('selected-option');
                });
                
                // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                clickedElement.classList.add('selected-option');
                
                // æ·»åŠ ç‚¹å‡»åé¦ˆåŠ¨ç”»
                clickedElement.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    clickedElement.style.transform = '';
                }, 100);
            }
            
            // ä½¿ç”¨requestAnimationFrameç¡®ä¿åŠ¨ç”»æµç•…
            requestAnimationFrame(() => {
                setTimeout(() => {
                    if(currentStep < quizData.length - 1) { 
                        currentStep++; 
                        renderQuestion(); 
                    } else { 
                        finishPrism(); 
                    }
                }, 200); // è¿›ä¸€æ­¥å‡å°‘å»¶è¿Ÿ
            });
        }
        function prevQuestion() { if(currentStep>0) { currentStep--; renderQuestion(); } }
        function finishPrism() {
            localStorage.setItem('muse_profile', JSON.stringify(userProfile));
            closePrism(); updateLiveSettings();
        }
        function openPrism() {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('prism-modal').classList.remove('hidden');
            currentStep = 0; renderQuestion();
        }

        // ========== 3. Voice Logic (ä½¿ç”¨ç°æœ‰çš„ TTS ç»„ä»¶) ==========
        let currentVoice = 'yushao';
        let ttsService = null;
        let debugMode = localStorage.getItem('muse_debug_mode') === 'true';
        
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, type = 'info', data = null) {
            if (!debugMode) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = `[TTS Debug ${timestamp}]`;
            
            if (type === 'error') {
                console.error(prefix, message, data);
            } else if (type === 'warn') {
                console.warn(prefix, message, data);
            } else {
                console.log(prefix, message, data);
            }
        }

        // ç»Ÿä¸€è¯»å–â€œå·²ä¿å­˜çš„éŸ³è‰²åå¥½â€ï¼ˆä¼˜å…ˆä½¿ç”¨æ–°é…ç½® muse_tts_configï¼Œå…¶æ¬¡å…¼å®¹æ—§å­—æ®µ muse_voice_typeï¼‰
        function getSavedTtsVoice() {
            try {
                if (typeof TTSConfig !== 'undefined') {
                    const cfg = new TTSConfig();
                    const v = cfg.get('voice');
                    if (v) return v;
                }
            } catch (e) {
                // ignore
            }
            return localStorage.getItem('muse_voice_type') || 'yushao';
        }

        // åŒæ­¥éŸ³è‰²åˆ°æ—§å­˜å‚¨å­—æ®µï¼Œç¡®ä¿å¯¹è¯é¡µä¸é…ç½®é¡µä¸€è‡´
        function syncVoicePreference(voice) {
            if (!voice) return;
            currentVoice = voice;
            localStorage.setItem('muse_voice_type', voice);
            try {
                if (ttsService && typeof ttsService.updateConfiguration === 'function') {
                    ttsService.updateConfiguration('voice', voice);
                }
            } catch (e) {
                // ignore
            }
        }
        
        // åˆ‡æ¢è°ƒè¯•æ¨¡å¼
        function toggleDebugMode() {
            debugMode = !debugMode;
            localStorage.setItem('muse_debug_mode', debugMode.toString());
            console.log('TTS Debug Mode:', debugMode ? 'ON' : 'OFF');
            return debugMode;
        }
        
        // åˆå§‹åŒ– TTS æœåŠ¡
        async function initTTSService() {
            if (!ttsService) {
                debugLog('åˆå§‹åŒ– TTS æœåŠ¡...');
                
                try {
                    ttsService = new TTSService();

                    // å…ˆåŒæ­¥ä¸€æ¬¡éŸ³è‰²ï¼ˆç¡®ä¿å¯¹è¯é¡µçš„ currentVoice ä¸é…ç½®ä¸€è‡´ï¼‰
                    syncVoicePreference(getSavedTtsVoice());
                    
                    // è®¾ç½® DashScope API å¯†é’¥
                    const dashScopeKey = getApiKey('dashscope');
                    debugLog('DashScope API Key çŠ¶æ€:', dashScopeKey ? 'å·²é…ç½®' : 'æœªé…ç½®');

                    // å°Šé‡é…ç½®é¡µé€‰æ‹©çš„å¼•æ“ï¼šåªæœ‰å½“é…ç½®ä¸º dashscope æ—¶ï¼Œæ‰å°è¯•åˆ‡åˆ° dashscope
                    const desiredEngine = (ttsService.getConfiguration && ttsService.getConfiguration().engine) || 'web-speech';
                    debugLog('æœŸæœ›å¼•æ“(desiredEngine):', desiredEngine);
                    
                    if (dashScopeKey) {
                        debugLog('é…ç½® DashScope API å¯†é’¥...');
                        const result = await ttsService.configureDashScopeApiKey(dashScopeKey);
                        debugLog('DashScope é…ç½®ç»“æœ:', 'info', result);
                        
                        if (desiredEngine === 'dashscope') {
                            if (result.success) {
                                await ttsService.switchEngine('dashscope');
                                debugLog('å·²åˆ‡æ¢åˆ° DashScope å¼•æ“');
                            } else {
                                debugLog('DashScope é…ç½®å¤±è´¥ï¼Œå›é€€ WebSpeech å¼•æ“', 'warn', result.error);
                                await ttsService.switchEngine('web-speech');
                            }
                        } else {
                            // é…ç½®é¡µæœªé€‰æ‹© dashscopeï¼šä¿æŒ web-speechï¼Œé¿å…æ„å¤–åˆ‡æ¢
                            if (ttsService.getCurrentEngine().id !== 'web-speech') {
                                await ttsService.switchEngine('web-speech');
                            }
                        }
                    } else {
                        debugLog('æœªé…ç½® DashScope API å¯†é’¥ï¼Œä½¿ç”¨ WebSpeech å¼•æ“');
                        if (ttsService.getCurrentEngine().id !== 'web-speech') {
                            await ttsService.switchEngine('web-speech');
                        }
                    }
                    
                    debugLog('TTS æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    debugLog('TTS æœåŠ¡åˆå§‹åŒ–å¤±è´¥', 'error', error);
                    throw error;
                }
            }
            return ttsService;
        }
        
        async function playSample(type, btnElement) {
            debugLog(`æ’­æ”¾è¯­éŸ³æ ·æœ¬: ${type}`);
            
            let text = "";
            if (type === 'yushao') text = "è¿‡æ¥ï¼Œä¸ç”¨è¯´è¯ï¼Œå¬æˆ‘å°±å¥½ã€‚";
            else if (type === 'shaonian') text = "åˆ«ç¦»æˆ‘å¤ªè¿‘ï¼Œæˆ‘æ€•æ§åˆ¶ä¸ä½ã€‚";
            else if (type === 'dashu') text = "æŠŠæ‰‹ç»™æˆ‘ï¼Œæ…¢æ…¢æ¥ï¼Œæ²¡å…³ç³»çš„ã€‚";
            
            const btnIcon = btnElement.querySelector('i');
            const originalClass = btnIcon.className;
            btnIcon.className = "fa-solid fa-circle-notch fa-spin";
            
            try {
                const service = await initTTSService();
                debugLog(`ä½¿ç”¨å¼•æ“: ${service.getCurrentEngine().id}`);
                debugLog(`åˆæˆæ–‡æœ¬: "${text}"`);
                debugLog(`éŸ³è‰²ç±»å‹: ${type}`);

                const options = { voice: type };
                debugLog(`è¯•å¬é€‰é¡¹:`, 'info', options);

                await service.synthesize(text, options);
                btnIcon.className = originalClass;
                debugLog('è¯­éŸ³æ ·æœ¬æ’­æ”¾æˆåŠŸ');
                
            } catch (error) {
                debugLog('è¯­éŸ³æ ·æœ¬æ’­æ”¾å¤±è´¥', 'error', error);
                btnIcon.className = originalClass;
                
                console.warn(`è¯­éŸ³è¯•å¬å¤±è´¥: ${error.message}`);
                alert(`è¯­éŸ³è¯•å¬å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ\n2. ç³»ç»ŸéŸ³é‡æ˜¯å¦å¼€å¯\n3. æ˜¯å¦å…è®¸ç½‘ç«™æ’­æ”¾éŸ³é¢‘`);
            }
        }
        
        async function speakText(text, type) {
            debugLog(`è¯­éŸ³åˆæˆè¯·æ±‚: ${text.substring(0, 50)}...`);
            debugLog(`éŸ³è‰²ç±»å‹: ${type}`);
            debugLog(`è¯­éŸ³å¼€å…³çŠ¶æ€: ${voiceEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            
            if (!voiceEnabled) {
                debugLog('è¯­éŸ³æ’­æ”¾å·²ç¦ç”¨ï¼Œè·³è¿‡åˆæˆ');
                return;
            }
            
            try {
                const service = await initTTSService();
                debugLog(`ä½¿ç”¨å¼•æ“: ${service.getCurrentEngine().id}`);

                const config = service.getConfiguration();
                debugLog(`å½“å‰é…ç½®:`, 'info', {
                    voice: config.voice,
                    engine: config.engine,
                    volume: config.volume,
                    speed: config.speed
                });

                const options = { voice: type };
                debugLog(`åˆæˆé€‰é¡¹:`, 'info', options);

                await service.synthesize(text, options);
                debugLog('è¯­éŸ³åˆæˆæˆåŠŸ');
                
            } catch (error) {
                debugLog('è¯­éŸ³åˆæˆå¤±è´¥', 'error', error);
                console.warn('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼š', error.message);

                // å°è¯•ä½¿ç”¨åå¤‡æ–¹æ¡ˆï¼ˆWebSpeechï¼‰
                debugLog('å°è¯•ä½¿ç”¨ WebSpeech åå¤‡æ–¹æ¡ˆ');
                speakTextFallback(text, type);
            }
        }

        function speakTextFallback(text, type) {
            debugLog('ä½¿ç”¨ WebSpeech åå¤‡æ–¹æ¡ˆ');
            
            // åœæ­¢å½“å‰æ’­æ”¾
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            
            if (!window.speechSynthesis) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
                return;
            }
            
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';

                // ä»æ–°é…ç½®é‡Œè¯»å–éŸ³é‡/è¯­é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
                let cfgSpeed = 1.0;
                let cfgVolume = 0.9;
                try {
                    if (ttsService && typeof ttsService.getConfiguration === 'function') {
                        const cfg = ttsService.getConfiguration();
                        if (typeof cfg.speed === 'number') cfgSpeed = cfg.speed;
                        if (typeof cfg.volume === 'number') cfgVolume = (cfg.volume / 100);
                    } else if (typeof TTSConfig !== 'undefined') {
                        const cfg = new TTSConfig();
                        const s = cfg.get('speed');
                        const v = cfg.get('volume');
                        if (typeof s === 'number') cfgSpeed = s;
                        if (typeof v === 'number') cfgVolume = (v / 100);
                    }
                } catch (e) {
                    // ignore
                }

                // æ ¹æ®éŸ³è‰²ç±»å‹è®¾ç½®å‚æ•°ï¼ˆä¸ WebSpeechEngine çš„æ˜ å°„ä¿æŒä¸€è‡´ï¼‰
                if (type === 'yushao') {
                    utterance.pitch = 0.7;
                    utterance.rate = 0.8 * cfgSpeed;
                } else if (type === 'shaonian') {
                    utterance.pitch = 1.2;
                    utterance.rate = 1.0 * cfgSpeed;
                } else if (type === 'dashu') {
                    utterance.pitch = 0.5;
                    utterance.rate = 0.85 * cfgSpeed;
                } else {
                    utterance.pitch = 1.0;
                    utterance.rate = 0.9 * cfgSpeed;
                }
                utterance.volume = cfgVolume;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                utterance.onstart = () => {
                    debugLog('WebSpeech å¼€å§‹æ’­æ”¾');
                };
                
                utterance.onend = () => {
                    debugLog('WebSpeech æ’­æ”¾å®Œæˆ');
                };
                
                utterance.onerror = (event) => {
                    debugLog('WebSpeech æ’­æ”¾é”™è¯¯', 'error', event);
                };
                
                // å¼€å§‹æ’­æ”¾
                window.speechSynthesis.speak(utterance);
                debugLog('WebSpeech è¯­éŸ³åˆæˆå·²å¯åŠ¨');
                
            } catch (error) {
                debugLog('WebSpeech åˆå§‹åŒ–å¤±è´¥', 'error', error);
                console.warn('è¯­éŸ³åˆæˆå¤±è´¥:', error.message);
            }
        }
        
        
        function selectVoice(type, el) {
            currentVoice = type;
            localStorage.setItem('muse_voice_type', type);

            // åŒæ­¥åˆ°æ–°çš„ TTS é…ç½®ï¼Œç¡®ä¿â€œé…ç½®é¡µ/å¯¹è¯é¡µâ€ä¸€è‡´
            try {
                initTTSService().then(service => {
                    if (service && typeof service.updateConfiguration === 'function') {
                        service.updateConfiguration('voice', type);
                    }
                }).catch(() => {});
            } catch (e) {
                // ignore
            }

            document.querySelectorAll('.voice-card').forEach(c => {
                c.classList.remove('selected');
                const dot = c.querySelector('.selection-dot div');
                if(dot) dot.classList.add('hidden');
            });
            if(el) {
                el.classList.add('selected');
                const dot = el.querySelector('.selection-dot div');
                if(dot) dot.classList.remove('hidden');
            }
            updateLiveSettings();
        }

        // ========== AI & Story ==========
        let activeProvider = localStorage.getItem('muse_ai_provider') || 'gemini';
        let voiceEnabled = true; // é»˜è®¤å¯ç”¨è¯­éŸ³
        
        let recognition;
        function initRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onstart = () => document.getElementById('mic-btn').classList.add('text-muse-rose', 'border-muse-rose');
                recognition.onend = () => document.getElementById('mic-btn').classList.remove('text-muse-rose', 'border-muse-rose');
                recognition.onresult = (event) => {
                    document.getElementById('story-input').value = event.results[0][0].transcript;
                    document.getElementById('story-input').focus();
                };
            }
        }
        function startListening() { if(recognition) recognition.start(); else initRecognition(); }
        function stopListening() { if(recognition) recognition.stop(); }

        function toggleVoiceOutput() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('tts-toggle');
            if(voiceEnabled) {
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                btn.classList.add('text-muse-rose', 'border-muse-rose');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
                btn.classList.remove('text-muse-rose', 'border-muse-rose');
                if(window.currentAudio) window.currentAudio.pause();
                window.speechSynthesis.cancel();
            }
        }

        function toggleSettings() {
            const pop = document.getElementById('settings-popover');
            pop.classList.toggle('hidden');
            
            if (!pop.classList.contains('hidden')) {
                // æ¢å¤è¯­éŸ³é€‰æ‹©çŠ¶æ€
                const savedVoice = getSavedTtsVoice();
                syncVoicePreference(savedVoice);
                const activeCard = document.querySelector(`.voice-card[onclick*="'${savedVoice}'"]`);
                if(activeCard) selectVoice(savedVoice, activeCard);
                
                // æ¢å¤èƒŒæ™¯é€‰æ‹©çŠ¶æ€
                const savedBackground = localStorage.getItem('muse_chat_background') || '';
                document.querySelectorAll('.bg-option').forEach(option => {
                    option.classList.remove('border-muse-rose', 'bg-muse-rose/20');
                    option.classList.add('border-white/10');
                });
                
                // é«˜äº®å½“å‰é€‰ä¸­çš„èƒŒæ™¯
                const currentBgOption = document.querySelector(`[onclick*="${savedBackground}"]`);
                if (currentBgOption) {
                    currentBgOption.classList.remove('border-white/10');
                    currentBgOption.classList.add('border-muse-rose', 'bg-muse-rose/20');
                }
            }
        }
        
        function updateLiveSettings() {
            userProfile.orientation = document.getElementById('setting-gender').value;
            userProfile.atmosphere = document.getElementById('setting-vibe').value;
            currentVoice = getSavedTtsVoice();
            // ä¿è¯ legacy å­—æ®µä¹Ÿè·Ÿç€èµ°ï¼ˆå¯¹è¯æ—¶è¯»å– currentVoice / muse_voice_typeï¼‰
            syncVoicePreference(currentVoice);
            document.getElementById('current-persona-label').innerText = `${userProfile.orientation} / ${currentVoice}`;
        }

        let storyContext = "";
        function startStory(scene) {
            document.getElementById('scenario-selector').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('flex');
            document.getElementById('global-nav').classList.add('hidden');
            
            // åº”ç”¨ä¿å­˜çš„èŠå¤©èƒŒæ™¯
            const savedBackground = localStorage.getItem('muse_chat_background');
            if (savedBackground) {
                selectChatBackground(savedBackground, '');
            }
            
            const target = userProfile.orientation === 'feminine' ? 'å¥¹' : 'ä»–';
            let intro = "";
            if(scene === 'elevator') intro = `ç”µæ¢¯æ•…éšœã€‚${target}åœ¨é»‘æš—ä¸­çœ‹å‘ä½ ...`;
            else intro = `é›¨å¤œã€‚${target}é è¿‘äº†ä½ ...`;
            
            storyContext = `Scene:${scene}. Target:${target}. Mood:${userProfile.atmosphere}.`;
            addBubble(intro, 'ai');
            initRecognition();
        }

        function exitStory() {
            document.getElementById('chat-interface').classList.remove('flex');
            document.getElementById('chat-interface').classList.add('hidden');
            document.getElementById('scenario-selector').classList.remove('hidden');
            document.getElementById('chat-history').innerHTML = '';
            document.getElementById('global-nav').classList.remove('hidden');
        }

        async function continueStory() {
            const input = document.getElementById('story-input');
            const val = input.value.trim();
            if(!val) return;
            addBubble(val, 'user');
            input.value = '';
            
            const loadingId = addBubble('...', 'ai', true);
            const system = `ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”AIã€‚ç›®æ ‡æ€§åˆ«:${userProfile.orientation}ï¼ŒéŸ³è‰²:${currentVoice}ï¼Œæ°›å›´:${userProfile.atmosphere}ã€‚ç”¨ä¸­æ–‡å›å¤ï¼Œè¥é€ æ²‰æµ¸æ„Ÿå’Œæ„Ÿå®˜ä½“éªŒã€‚

é‡è¦è§„åˆ™ï¼š
- å›å¤å¿…é¡»æ§åˆ¶åœ¨100å­—ä»¥å†…
- è¯­è¨€è¦ç®€æ´æœ‰åŠ›ï¼Œå¯Œæœ‰å¼ åŠ›
- é‡ç‚¹æè¿°å½“ä¸‹çš„æ„Ÿå—å’Œæ°›å›´
- é¿å…å†—é•¿çš„æè¿°ï¼Œä¸“æ³¨äºå…³é”®æ—¶åˆ»`;
            const res = await callAI(`Context:${storyContext}\nAction:${val}`, system);
            
            document.getElementById(loadingId).remove();
            addBubble(res, 'ai');
            storyContext += `\nUser:${val}\nAI:${res}`;
            
            if(voiceEnabled) {
                // æ˜¾ç¤ºè¯­éŸ³æ’­æ”¾æŒ‡ç¤ºå™¨
                const btn = document.getElementById('tts-toggle');
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                btn.classList.add('animate-pulse');
                
                try {
                    await speakText(res.replace(/[*#]/g, ''), currentVoice);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.innerHTML = originalIcon;
                    btn.classList.remove('animate-pulse');
                }
            }
        }

        function addBubble(text, role, loading=false) {
            const div = document.createElement('div');
            div.className = `flex w-full ${role==='user'?'justify-end':'justify-start'}`;
            div.id = 'msg-' + Date.now();
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] px-4 py-3 rounded-2xl text-sm leading-relaxed ${role==='user'?'bg-muse-rose/20 text-white border border-muse-rose/30 rounded-tr-none':'bg-white/10 text-muse-gold border border-white/5 rounded-tl-none font-serif'}`;
            if(loading) bubble.classList.add('animate-pulse');
            bubble.innerHTML = loading ? text : marked.parse(text);
            div.appendChild(bubble);
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = document.getElementById('chat-history').scrollHeight;
            return div.id;
        }

        // Utils & Init
        function getApiKey(p=activeProvider) { 
            return p==='gemini' ? localStorage.getItem('muse_gemini_apikey') : localStorage.getItem('muse_dashscope_apikey'); 
        }
        function openApiKeySettings() { 
            document.getElementById('apikey-modal').classList.remove('hidden');
            document.getElementById('gemini-key-input').value = localStorage.getItem('muse_gemini_apikey')||'';
            document.getElementById('dashscope-key-input').value = localStorage.getItem('muse_dashscope_apikey')||'';
            
            // è®¾ç½®è°ƒè¯•æ¨¡å¼å¼€å…³çŠ¶æ€
            document.getElementById('debug-mode-toggle').checked = debugMode;
        }
        
        // æ‰“å¼€è°ƒè¯•é¡µé¢
        function openDebugPage() {
            window.open('debug-dashscope-tts.html', '_blank');
        }
        
        // æ·»åŠ è°ƒè¯•åŠŸèƒ½
        async function testDashScopeTTS() {
            debugLog('å¼€å§‹æµ‹è¯• DashScope TTS...');
            
            try {
                const service = await initTTSService();
                const engineInfo = service.getCurrentEngine();
                debugLog('å½“å‰å¼•æ“ä¿¡æ¯:', 'info', engineInfo);
                
                // è·å–å½“å‰é…ç½®
                const options = { 
                    voice: 'yushao'
                };
                debugLog(`æµ‹è¯•é€‰é¡¹:`, 'info', options);
                
                await service.synthesize('ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•', options);
                alert('DashScope TTS æµ‹è¯•æˆåŠŸï¼');
                debugLog('DashScope TTS æµ‹è¯•æˆåŠŸ');
            } catch (error) {
                debugLog('DashScope TTS æµ‹è¯•å¤±è´¥', 'error', error);
                
                let errorMessage = error.message;
                if (error.message.includes('Network error')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä½¿ç”¨è°ƒè¯•å·¥å…·è¿›è¡Œè¯¦ç»†è¯Šæ–­';
                } else if (error.message.includes('Invalid API key')) {
                    errorMessage = 'API å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥å¯†é’¥é…ç½®';
                }
                
                alert(`DashScope TTS æµ‹è¯•å¤±è´¥: ${errorMessage}\n\nå»ºè®®ï¼š\n1. ç‚¹å‡» "DEBUG TOOL" è¿›è¡Œè¯¦ç»†è¯Šæ–­\n2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†æ—¥å¿—\n3. ç¡®è®¤ API å¯†é’¥æ˜¯å¦æ­£ç¡®`);
            }
        }
        async function saveApiSettings() {
            const k1 = document.getElementById('gemini-key-input').value;
            const k2 = document.getElementById('dashscope-key-input').value;
            
            if(k1) localStorage.setItem('muse_gemini_apikey', k1);
            if(k2) {
                localStorage.setItem('muse_dashscope_apikey', k2);
                debugLog('ä¿å­˜ DashScope API å¯†é’¥');
                
                // é‡æ–°åˆå§‹åŒ– TTS æœåŠ¡
                if (ttsService) {
                    try {
                        debugLog('é‡æ–°é…ç½® TTS æœåŠ¡...');
                        const result = await ttsService.configureDashScopeApiKey(k2);
                        debugLog('DashScope é‡æ–°é…ç½®ç»“æœ:', 'info', result);
                        
                        if (result.success) {
                            await ttsService.switchEngine('dashscope');
                            debugLog('å·²åˆ‡æ¢åˆ° DashScope å¼•æ“');
                        } else {
                            debugLog('DashScope é…ç½®å¤±è´¥', 'warn', result.error);
                        }
                    } catch (error) {
                        debugLog('TTS æœåŠ¡é‡æ–°é…ç½®å¤±è´¥', 'error', error);
                    }
                }
            }
            document.getElementById('apikey-modal').classList.add('hidden');
        }
        function switchProvider(p) {
            activeProvider = p;
            localStorage.setItem('muse_ai_provider', p);
            document.getElementById('input-group-gemini').className = p==='gemini'?'':'hidden';
            document.getElementById('input-group-dashscope').className = p==='dashscope'?'':'hidden';
            document.getElementById('btn-gemini').className = p==='gemini'?'flex-1 py-2 text-xs rounded transition text-white bg-muse-rose':'flex-1 py-2 text-xs rounded transition text-stone-400';
            document.getElementById('btn-dashscope').className = p==='dashscope'?'flex-1 py-2 text-xs rounded transition text-white bg-muse-rose':'flex-1 py-2 text-xs rounded transition text-stone-400';
        }
        async function callAI(prompt, system, json=false) {
            const key = getApiKey();
            if(!key) { openApiKeySettings(); return "è¯·å…ˆé…ç½® Key"; }
            try {
                if(activeProvider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const body = { contents: [{parts:[{text: prompt}]}], systemInstruction:{parts:[{text:system}]} };
                    if(json) body.generationConfig = { responseMimeType: "application/json" };
                    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                } else {
                    const url = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
                    const res = await fetch(url, {
                        method:'POST', headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                        body: JSON.stringify({ model:'qwen-plus-2025-12-01', messages:[{role:'system',content:system},{role:'user',content:prompt}] })
                    });
                    const data = await res.json();
                    return data.choices?.[0]?.message?.content || "Error";
                }
            } catch(e) { return "Network Error"; }
        }
        
        async function generateScript() {
            const input = document.getElementById('script-prompt');
            const resDiv = document.getElementById('script-result');
            if(!input.value) return;
            document.getElementById('script-btn').innerText = "...";
            resDiv.classList.remove('hidden'); resDiv.innerHTML = "Thinking...";
            const text = await callAI(input.value, `åŸºäºç»™å®šçš„å…³é”®è¯ï¼Œåˆ›ä½œä¸€æ®µæ„Ÿå®˜ä¸°å¯Œçš„ç‹¬ç™½ã€‚è¦æ±‚ï¼š

1. ç”¨ä¸­æ–‡å†™ä½œï¼Œ200-300å­—
2. é‡ç‚¹æè¿°å£°éŸ³ã€æ°”å‘³ã€è§¦è§‰ç­‰æ„Ÿå®˜ç»†èŠ‚
3. è¥é€ ç§å¯†ã€æš§æ˜§çš„æ°›å›´
4. è¯­è¨€è¦ä¼˜ç¾ã€å¯Œæœ‰è¯—æ„
5. ä»ç¬¬ä¸€äººç§°è§†è§’å™è¿°
6. åŒ…å«æƒ…æ„Ÿçš„ç»†è…»å˜åŒ–

å…³é”®è¯ï¼š${input.value}`);
            resDiv.innerHTML = marked.parse(text);
            document.getElementById('script-btn').innerText = "GENERATE";
        }

        // ========== 4. Scene Selection Functions ==========
        let selectedSceneType = 'custom'; // é»˜è®¤é€‰æ‹©è‡ªå®šä¹‰
        let selectedScene = 'library';
        let sceneDescription = '';

        function selectSceneType(type) {
            selectedSceneType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('custom-btn').className = type === 'custom' 
                ? 'scene-type-btn active px-3 py-2 text-xs rounded border border-white/10 bg-muse-rose/20 text-white transition'
                : 'scene-type-btn px-3 py-2 text-xs rounded border border-white/10 bg-white/5 text-stone-400 transition';
            
            document.getElementById('preset-btn').className = type === 'preset'
                ? 'scene-type-btn active px-3 py-2 text-xs rounded border border-white/10 bg-muse-rose/20 text-white transition'
                : 'scene-type-btn px-3 py-2 text-xs rounded border border-white/10 bg-white/5 text-stone-400 transition';
            
            // æ˜¾ç¤º/éšè—ç›¸åº”çš„é€‰æ‹©åŒºåŸŸ
            if (type === 'custom') {
                document.getElementById('custom-scene').classList.remove('hidden');
                document.getElementById('preset-scenes').classList.add('hidden');
            } else {
                document.getElementById('custom-scene').classList.add('hidden');
                document.getElementById('preset-scenes').classList.remove('hidden');
            }
            
            // é‡ç½®åœºæ™¯æè¿°å’ŒæŒ‰é’®çŠ¶æ€
            sceneDescription = '';
            document.getElementById('scene-result').classList.add('hidden');
            document.getElementById('start-chat-btn').disabled = true;
            
            // å¦‚æœå½“å‰æ­£åœ¨èŠå¤©ç•Œé¢ï¼Œé€€å‡ºåˆ°åœºæ™¯é€‰æ‹©ç•Œé¢
            const chatInterface = document.getElementById('chat-interface');
            const scenarioSelector = document.getElementById('scenario-selector');
            if (!chatInterface.classList.contains('hidden')) {
                exitStory();
            }
        }

        function selectPresetScene(scene) {
            selectedScene = scene;
            
            // æ›´æ–°é¢„è®¾åœºæ™¯æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.preset-scene-btn').forEach(btn => {
                btn.classList.remove('border-muse-rose/50', 'bg-muse-rose/10');
                btn.classList.add('border-white/10', 'bg-white/5');
            });
            
            // é«˜äº®é€‰ä¸­çš„åœºæ™¯
            const selectedBtn = document.querySelector(`[onclick="selectPresetScene('${scene}')"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('border-white/10', 'bg-white/5');
                selectedBtn.classList.add('border-muse-rose/50', 'bg-muse-rose/10');
            }
            
            // é‡ç½®åœºæ™¯æè¿°å’ŒæŒ‰é’®çŠ¶æ€
            sceneDescription = '';
            document.getElementById('scene-result').classList.add('hidden');
            document.getElementById('start-chat-btn').disabled = true;
            
            // å¦‚æœå½“å‰æ­£åœ¨èŠå¤©ç•Œé¢ï¼Œé€€å‡ºåˆ°åœºæ™¯é€‰æ‹©ç•Œé¢
            const chatInterface = document.getElementById('chat-interface');
            if (!chatInterface.classList.contains('hidden')) {
                exitStory();
            }
        }

        async function generateSceneScript() {
            const btn = document.getElementById('scene-script-btn');
            const resultDiv = document.getElementById('scene-result');
            
            let prompt = '';
            if (selectedSceneType === 'preset') {
                const sceneNames = {
                    'library': 'æ·±å¤œå›¾ä¹¦é¦† - ä¹¦é¦™ä¸­çš„ç§˜å¯†é‚‚é€…',
                    'rooftop': 'å¤©å°å¤œæ™¯ - åŸå¸‚ç¯ç«ä¸‹çš„å¿ƒåŠ¨',
                    'cafe': 'åˆå¤œå’–å•¡å… - æ¸©æš–ç¯å…‰ä¸­çš„æ¸©æŸ”æ—¶å…‰',
                    'garden': 'æœˆä¸‹èŠ±å›­ - èŠ±é¦™ä¸æœˆå…‰çš„æµªæ¼«'
                };
                prompt = sceneNames[selectedScene] || 'æ·±å¤œå›¾ä¹¦é¦†';
            } else {
                const customInput = document.getElementById('custom-scene-input').value.trim();
                if (!customInput) {
                    alert('è¯·å…ˆæè¿°ä½ çš„è‡ªå®šä¹‰åœºæ™¯');
                    return;
                }
                prompt = customInput;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ç”Ÿæˆä¸­...';
            btn.disabled = true;
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> æ­£åœ¨æ„æ€åœºæ™¯...';
            
            try {
                const system = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åœºæ™¯æè¿°å¸ˆã€‚åŸºäºç»™å®šçš„åœºæ™¯å…³é”®è¯ï¼Œåˆ›ä½œä¸€æ®µå¯Œæœ‰æ„Ÿå®˜ç»†èŠ‚çš„åœºæ™¯æè¿°ã€‚è¦æ±‚ï¼š

1. ç”¨ä¸­æ–‡å†™ä½œï¼Œ200-300å­—
2. é‡ç‚¹æè¿°ç¯å¢ƒæ°›å›´ã€å…‰çº¿ã€å£°éŸ³ã€æ°”å‘³ç­‰æ„Ÿå®˜ç»†èŠ‚
3. è¥é€ æš§æ˜§ã€ç§å¯†çš„æ°›å›´
4. è¯­è¨€è¦ä¼˜ç¾ã€å¯Œæœ‰è¯—æ„
5. ä»ç¬¬äºŒäººç§°è§†è§’æè¿°ï¼ˆ"ä½ "ï¼‰
6. ä¸ºåç»­çš„è§’è‰²äº’åŠ¨åšå¥½é“ºå«

åœºæ™¯å…³é”®è¯ï¼š${prompt}`;
                
                sceneDescription = await callAI(prompt, system);
                resultDiv.innerHTML = marked.parse(sceneDescription);
                
                // å¯ç”¨å¼€å§‹å¯¹è¯æŒ‰é’®
                document.getElementById('start-chat-btn').disabled = false;
                
            } catch (error) {
                resultDiv.innerHTML = '<span class="text-red-400">åœºæ™¯ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</span>';
                console.error('Scene generation error:', error);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.innerHTML = 'ç”Ÿæˆåœºæ™¯æè¿°';
                btn.disabled = false;
            }
        }

        function startSceneChat() {
            if (!sceneDescription) {
                alert('è¯·å…ˆç”Ÿæˆåœºæ™¯æè¿°');
                return;
            }
            
            // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
            document.getElementById('scenario-selector').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('flex');
            document.getElementById('global-nav').classList.add('hidden');
            
            // åº”ç”¨ä¿å­˜çš„èŠå¤©èƒŒæ™¯
            const savedBackground = localStorage.getItem('muse_chat_background');
            if (savedBackground) {
                selectChatBackground(savedBackground, '');
            }
            
            // è®¾ç½®èŠå¤©æ ‡é¢˜
            const sceneNames = {
                'library': 'æ·±å¤œå›¾ä¹¦é¦†',
                'rooftop': 'å¤©å°å¤œæ™¯', 
                'cafe': 'åˆå¤œå’–å•¡å…',
                'garden': 'æœˆä¸‹èŠ±å›­'
            };
            
            const title = selectedSceneType === 'preset' 
                ? sceneNames[selectedScene] || 'è‡ªå®šä¹‰åœºæ™¯'
                : 'è‡ªå®šä¹‰åœºæ™¯';
            
            document.getElementById('chat-title').innerText = title;
            
            // è®¾ç½®æ•…äº‹ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«åœºæ™¯æè¿°
            const target = userProfile.orientation === 'feminine' ? 'å¥¹' : 'ä»–';
            storyContext = `Scene: ${title}. Target: ${target}. Mood: ${userProfile.atmosphere}. 
Scene Description: ${sceneDescription}`;
            
            // æ·»åŠ åœºæ™¯æè¿°ä½œä¸ºå¼€åœº
            addBubble(sceneDescription, 'ai');
            
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initRecognition();
        }

        // ========== 5. Background Image Selection ==========
        const chatBackgroundImages = [
            {
                name: 'ç»å…¸é»‘è‰²',
                url: '',
                preview: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjMGEwYTBhIi8+Cjwvc3ZnPgo='
            },
            {
                name: 'æš§æ˜§ç¯å…‰',
                url: 'https://picsum.photos/1920/1080?random=10&blur=2',
                preview: 'https://picsum.photos/100/80?random=10&blur=1'
            },
            {
                name: 'æ¸©æŸ”å¤œè‰²',
                url: 'https://picsum.photos/1920/1080?random=11&blur=2',
                preview: 'https://picsum.photos/100/80?random=11&blur=1'
            },
            {
                name: 'ç§å¯†ç©ºé—´',
                url: 'https://picsum.photos/1920/1080?random=12&blur=2',
                preview: 'https://picsum.photos/100/80?random=12&blur=1'
            },
            {
                name: 'æœ¦èƒ§æ°›å›´',
                url: 'https://picsum.photos/1920/1080?random=13&blur=2',
                preview: 'https://picsum.photos/100/80?random=13&blur=1'
            }
        ];

        let currentChatBackground = '';

        function selectChatBackground(imageUrl, imageName) {
            console.log('é€‰æ‹©èŠå¤©èƒŒæ™¯:', imageName, imageUrl);
            currentChatBackground = imageUrl;
            localStorage.setItem('muse_chat_background', imageUrl);
            
            // æ›´æ–°èŠå¤©ç•Œé¢èƒŒæ™¯
            const chatInterface = document.getElementById('chat-interface');
            if (!chatInterface) {
                console.warn('èŠå¤©ç•Œé¢å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // ç§»é™¤ç°æœ‰çš„èƒŒæ™¯é®ç½©
            const existingOverlay = chatInterface.querySelector('.chat-bg-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            if (imageUrl) {
                // é¢„åŠ è½½å›¾ç‰‡ä»¥ç¡®ä¿èƒ½æ­£å¸¸æ˜¾ç¤º
                const img = new Image();
                img.onload = () => {
                    console.log('èŠå¤©èƒŒæ™¯å›¾ç‰‡åŠ è½½æˆåŠŸ:', imageUrl);
                    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                    chatInterface.style.backgroundImage = `url(${imageUrl})`;
                    chatInterface.style.backgroundSize = 'cover';
                    chatInterface.style.backgroundPosition = 'center';
                    chatInterface.style.backgroundRepeat = 'no-repeat';
                    chatInterface.style.backgroundAttachment = 'fixed';
                    
                    // æ·»åŠ æ–°çš„é®ç½©å±‚ä»¥ç¡®ä¿æ–‡å­—å¯è¯»æ€§
                    const overlay = document.createElement('div');
                    overlay.className = 'chat-bg-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg, rgba(0, 0, 0, 0.75) 0%, rgba(0, 0, 0, 0.6) 50%, rgba(0, 0, 0, 0.8) 100%);
                        backdrop-filter: blur(0.5px);
                        pointer-events: none;
                        z-index: 1;
                    `;
                    
                    // ç¡®ä¿èŠå¤©ç•Œé¢æ˜¯ç›¸å¯¹å®šä½
                    chatInterface.style.position = 'relative';
                    
                    // å°†é®ç½©å±‚æ’å…¥åˆ°ç¬¬ä¸€ä¸ªä½ç½®
                    chatInterface.insertBefore(overlay, chatInterface.firstChild);
                    
                    // ç¡®ä¿å…¶ä»–å…ƒç´ åœ¨é®ç½©å±‚ä¹‹ä¸Š
                    const chatElements = chatInterface.querySelectorAll(':scope > *:not(.chat-bg-overlay)');
                    chatElements.forEach(element => {
                        if (element.style) {
                            element.style.position = 'relative';
                            element.style.zIndex = '10';
                        }
                    });
                };
                
                img.onerror = () => {
                    console.error('èŠå¤©èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', imageUrl);
                    // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¸å˜èƒŒæ™¯
                    chatInterface.style.backgroundImage = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
                    chatInterface.style.backgroundColor = '#0a0a0a';
                };
                
                img.src = imageUrl;
                
            } else {
                // ç§»é™¤èƒŒæ™¯å›¾ç‰‡ï¼Œä½¿ç”¨çº¯é»‘è‰²
                chatInterface.style.backgroundImage = '';
                chatInterface.style.backgroundSize = '';
                chatInterface.style.backgroundPosition = '';
                chatInterface.style.backgroundRepeat = '';
                chatInterface.style.backgroundAttachment = '';
                chatInterface.style.backgroundColor = '#0a0a0a';
            }
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.bg-option').forEach(option => {
                option.classList.remove('border-muse-rose', 'bg-muse-rose/20');
                option.classList.add('border-white/10');
            });
            
            // æŸ¥æ‰¾å¹¶é«˜äº®é€‰ä¸­çš„é€‰é¡¹
            const selectedOption = document.querySelector(`[onclick*="${imageUrl.replace(/['"]/g, '\\$&')}"]`);
            if (selectedOption) {
                selectedOption.classList.remove('border-white/10');
                selectedOption.classList.add('border-muse-rose', 'bg-muse-rose/20');
            } else if (!imageUrl) {
                // å¦‚æœæ˜¯ç»å…¸é»‘è‰²ï¼ˆç©ºURLï¼‰ï¼Œé«˜äº®ç¬¬ä¸€ä¸ªé€‰é¡¹
                const firstOption = document.querySelector('.bg-option');
                if (firstOption) {
                    firstOption.classList.remove('border-white/10');
                    firstOption.classList.add('border-muse-rose', 'bg-muse-rose/20');
                }
            }
            
            console.log(`å·²åˆ‡æ¢èŠå¤©èƒŒæ™¯: ${imageName || 'ç»å…¸é»‘è‰²'}`);
        }

        window.onload = () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            // è¿›å…¥é¡µé¢æ—¶å…ˆæŠŠâ€œé…ç½®é¡µä¿å­˜çš„éŸ³è‰²â€åŒæ­¥åˆ°å¯¹è¯é¡µä½¿ç”¨çš„å­—æ®µ
            syncVoicePreference(getSavedTtsVoice());
            
            // ä½¿ç”¨å›¾ç‰‡é¢„åŠ è½½ç³»ç»Ÿ
            preloadImages().then((results) => {
                console.log('å›¾ç‰‡é¢„åŠ è½½å®Œæˆï¼ŒæˆåŠŸåŠ è½½:', results.filter(r => r !== null).length, 'å¼ å›¾ç‰‡');
                initSlideshow();
            }).catch((error) => {
                console.error('å›¾ç‰‡é¢„åŠ è½½å‡ºé”™ï¼Œä½†ä»ç„¶åˆå§‹åŒ–è½®æ’­:', error);
                initSlideshow(); // å³ä½¿é¢„åŠ è½½å¤±è´¥ä¹Ÿè¦åˆå§‹åŒ–è½®æ’­
            });
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ3ç§’åè¿˜æ²¡æœ‰å›¾ç‰‡æ˜¾ç¤ºï¼Œå¼ºåˆ¶åˆå§‹åŒ–
            setTimeout(() => {
                const container = document.getElementById('slideshow-container');
                if (container && container.querySelectorAll('img').length === 0) {
                    console.log('å¤‡ç”¨æ–¹æ¡ˆï¼šå¼ºåˆ¶åˆå§‹åŒ–è½®æ’­');
                    initSlideshow();
                }
            }, 3000);
            
            initRecognition();
            initTTSService(); // åˆå§‹åŒ– TTS æœåŠ¡
            
            const saved = localStorage.getItem('muse_profile');
            if(saved) {
                userProfile = JSON.parse(saved);
                document.getElementById('setting-gender').value = userProfile.orientation || 'masculine';
                document.getElementById('setting-vibe').value = userProfile.atmosphere || 'tension';
                updateLiveSettings();
            }
            switchProvider(localStorage.getItem('muse_ai_provider')||'gemini');
            
            // æ¢å¤èŠå¤©èƒŒæ™¯è®¾ç½®
            const savedBackground = localStorage.getItem('muse_chat_background');
            if (savedBackground) {
                currentChatBackground = savedBackground;
            }
        };
    </script>
</body>
</html>
