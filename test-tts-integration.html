<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #2a2a2a;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #1a4a1a;
            border: 1px solid #2a6a2a;
            color: #4ade80;
        }
        .test-fail {
            background-color: #4a1a1a;
            border: 1px solid #6a2a2a;
            color: #f87171;
        }
        .test-info {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        button:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
        }
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .voice-card {
            background-color: #374151;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .voice-card:hover {
            border-color: #3b82f6;
        }
        .voice-card.selected {
            border-color: #10b981;
            background-color: #065f46;
        }
        .status-display {
            background-color: #1e293b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>TTS ç³»ç»Ÿé›†æˆæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ç³»ç»Ÿåˆå§‹åŒ–</h2>
        <button onclick="initializeSystem()">åˆå§‹åŒ– TTS ç³»ç»Ÿ</button>
        <div id="init-results"></div>
    </div>
    
    <div class="test-section">
        <h2>WebSpeechEngine é›†æˆæµ‹è¯•</h2>
        <button onclick="testWebSpeechIntegration()">æµ‹è¯• WebSpeech å¼•æ“é›†æˆ</button>
        <div id="webspeech-results"></div>
    </div>
    
    <div class="test-section">
        <h2>éŸ³è‰²æµ‹è¯•</h2>
        <div class="voice-grid">
            <div class="voice-card" onclick="testVoiceIntegration('yushao')">
                <h3>ğŸ· ä½æ²‰å¾¡å°‘éŸ³</h3>
                <p>ç£æ€§ Â· æˆç†Ÿ</p>
                <button onclick="event.stopPropagation(); playVoiceSample('yushao')">æ’­æ”¾æ ·æœ¬</button>
            </div>
            <div class="voice-card" onclick="testVoiceIntegration('shaonian')">
                <h3>â„ï¸ æ¸…å†·å°‘å¹´éŸ³</h3>
                <p>æ¸…è„† Â· ç¦æ¬²</p>
                <button onclick="event.stopPropagation(); playVoiceSample('shaonian')">æ’­æ”¾æ ·æœ¬</button>
            </div>
            <div class="voice-card" onclick="testVoiceIntegration('dashu')">
                <h3>ğŸ¥ƒ æ¸©æŸ”å¤§å”éŸ³</h3>
                <p>ä½æ²‰ Â· åŒ…å®¹</p>
                <button onclick="event.stopPropagation(); playVoiceSample('dashu')">æ’­æ”¾æ ·æœ¬</button>
            </div>
        </div>
        <div id="voice-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>ç³»ç»ŸçŠ¶æ€</h2>
        <button onclick="updateSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="stopAllPlayback()">åœæ­¢æ’­æ”¾</button>
        <div id="system-status" class="status-display">ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯</div>
    </div>
    
    <div class="test-section">
        <h2>åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testUnifiedInterface()">æµ‹è¯•ç»Ÿä¸€æ¥å£</button>
        <button onclick="testConfigurationPersistence()">æµ‹è¯•é…ç½®æŒä¹…åŒ–</button>
        <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        <div id="function-test-results"></div>
    </div>

    <!-- Include all TTS components -->
    <script src="js/tts/TTSConfig.js"></script>
    <script src="js/tts/WebSpeechEngine.js"></script>
    <script src="js/tts/DashScopeEngine.js"></script>
    <script src="js/tts/StreamingProcessor.js"></script>
    <script src="js/tts/ErrorHandler.js"></script>
    <script src="js/tts/TTSService.js"></script>
    <script src="js/tts/index.js"></script>
    
    <script>
        let ttsService = null;
        let testResults = [];
        
        // Initialize the TTS system
        async function initializeSystem() {
            const resultsDiv = document.getElementById('init-results');
            resultsDiv.innerHTML = '<p>æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</p>';
            
            try {
                ttsService = await window.TTSService.getTTSService();
                
                const status = await ttsService.getStatus();
                const engines = await ttsService.getAvailableEngines();
                
                let html = '<div class="test-result test-pass">âœ… TTS ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ</div>';
                html += `<div class="test-result test-info">å½“å‰å¼•æ“: ${status.currentEngine}</div>`;
                html += `<div class="test-result test-info">å¯ç”¨å¼•æ“: ${engines.map(e => e.name).join(', ')}</div>`;
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result test-fail">âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // Test WebSpeech engine integration
        async function testWebSpeechIntegration() {
            const resultsDiv = document.getElementById('webspeech-results');
            resultsDiv.innerHTML = '<p>æµ‹è¯• WebSpeech å¼•æ“é›†æˆ...</p>';
            
            const results = [];
            
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                // Test 1: Switch to WebSpeech engine
                await ttsService.switchEngine('web-speech');
                const currentEngine = ttsService.getCurrentEngine();
                
                if (currentEngine.id === 'web-speech') {
                    results.push({ name: 'å¼•æ“åˆ‡æ¢', passed: true });
                } else {
                    results.push({ name: 'å¼•æ“åˆ‡æ¢', passed: false, error: 'æœªèƒ½åˆ‡æ¢åˆ° WebSpeech å¼•æ“' });
                }
                
                // Test 2: Get available voices
                const voices = await ttsService.getAvailableVoices();
                if (voices.length === 3 && voices.every(v => v.engine === 'web-speech')) {
                    results.push({ name: 'è·å–éŸ³è‰²åˆ—è¡¨', passed: true });
                } else {
                    results.push({ name: 'è·å–éŸ³è‰²åˆ—è¡¨', passed: false, error: 'éŸ³è‰²åˆ—è¡¨ä¸æ­£ç¡®' });
                }
                
                // Test 3: Test synthesis
                await ttsService.synthesize('æµ‹è¯•æ–‡æœ¬', { voice: 'yushao' });
                results.push({ name: 'è¯­éŸ³åˆæˆ', passed: true });
                
                // Test 4: Test configuration
                await ttsService.updateConfiguration('voice', 'shaonian');
                const config = await ttsService.getConfiguration();
                
                if (config.voice === 'shaonian') {
                    results.push({ name: 'é…ç½®æ›´æ–°', passed: true });
                } else {
                    results.push({ name: 'é…ç½®æ›´æ–°', passed: false, error: 'é…ç½®æœªæ­£ç¡®ä¿å­˜' });
                }
                
            } catch (error) {
                results.push({ name: 'é›†æˆæµ‹è¯•', passed: false, error: error.message });
            }
            
            // Display results
            let html = '';
            results.forEach(result => {
                const className = result.passed ? 'test-pass' : 'test-fail';
                const status = result.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
                const errorMsg = result.error ? ` - ${result.error}` : '';
                html += `<div class="test-result ${className}">${result.name}: ${status}${errorMsg}</div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Test voice integration
        async function testVoiceIntegration(voiceType) {
            const resultsDiv = document.getElementById('voice-test-results');
            
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                // Update voice selection
                await ttsService.updateConfiguration('voice', voiceType);
                
                // Update UI
                document.querySelectorAll('.voice-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.voice-card').classList.add('selected');
                
                resultsDiv.innerHTML = `<div class="test-result test-pass">âœ… å·²é€‰æ‹© ${voiceType} éŸ³è‰²</div>`;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result test-fail">âŒ éŸ³è‰²é€‰æ‹©å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // Play voice sample
        async function playVoiceSample(voiceType) {
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                await window.TTSService.playSample(voiceType);
                
            } catch (error) {
                console.error('æ’­æ”¾æ ·æœ¬å¤±è´¥:', error);
            }
        }
        
        // Update system status
        async function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            try {
                if (!ttsService) {
                    statusDiv.innerHTML = 'ç³»ç»Ÿæœªåˆå§‹åŒ–';
                    return;
                }
                
                const status = await ttsService.getStatus();
                const config = await ttsService.getConfiguration();
                const engines = await ttsService.getAvailableEngines();
                
                let html = '<h3>ç³»ç»ŸçŠ¶æ€:</h3>';
                html += `<strong>åˆå§‹åŒ–çŠ¶æ€:</strong> ${status.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}<br>`;
                html += `<strong>å½“å‰å¼•æ“:</strong> ${status.currentEngine}<br>`;
                html += `<strong>å¼•æ“çŠ¶æ€:</strong> ${JSON.stringify(status.engineStatus, null, 2)}<br><br>`;
                
                html += '<h3>é…ç½®ä¿¡æ¯:</h3>';
                html += `<strong>é€‰æ‹©çš„éŸ³è‰²:</strong> ${config.voice}<br>`;
                html += `<strong>éŸ³é‡:</strong> ${config.volume}<br>`;
                html += `<strong>è¯­é€Ÿ:</strong> ${config.speed}<br>`;
                html += `<strong>æµå¼æ’­æ”¾:</strong> ${config.streamingEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}<br><br>`;
                
                html += '<h3>å¯ç”¨å¼•æ“:</h3>';
                engines.forEach(engine => {
                    html += `<strong>${engine.name}:</strong> ${engine.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}<br>`;
                });
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `é”™è¯¯: ${error.message}`;
            }
        }
        
        // Stop all playback
        async function stopAllPlayback() {
            try {
                await window.TTSService.stopTTS();
                document.getElementById('system-status').innerHTML += '<br><strong>å·²åœæ­¢æ‰€æœ‰æ’­æ”¾</strong>';
            } catch (error) {
                console.error('åœæ­¢æ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // Test unified interface
        async function testUnifiedInterface() {
            const resultsDiv = document.getElementById('function-test-results');
            resultsDiv.innerHTML = '<p>æµ‹è¯•ç»Ÿä¸€æ¥å£...</p>';
            
            const results = [];
            
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                // Test speakText function
                await window.TTSService.speakText('ç»Ÿä¸€æ¥å£æµ‹è¯•', { voice: 'yushao' });
                results.push({ name: 'speakText å‡½æ•°', passed: true });
                
                // Test playSample function
                await window.TTSService.playSample('shaonian');
                results.push({ name: 'playSample å‡½æ•°', passed: true });
                
                // Test configuration functions
                const originalVoice = (await window.TTSService.getTTSConfiguration()).voice;
                await window.TTSService.updateTTSConfiguration('voice', 'dashu');
                const newVoice = (await window.TTSService.getTTSConfiguration()).voice;
                
                if (newVoice === 'dashu') {
                    results.push({ name: 'é…ç½®ç®¡ç†', passed: true });
                    // Restore original voice
                    await window.TTSService.updateTTSConfiguration('voice', originalVoice);
                } else {
                    results.push({ name: 'é…ç½®ç®¡ç†', passed: false, error: 'é…ç½®æœªæ­£ç¡®æ›´æ–°' });
                }
                
            } catch (error) {
                results.push({ name: 'ç»Ÿä¸€æ¥å£æµ‹è¯•', passed: false, error: error.message });
            }
            
            // Display results
            let html = '';
            results.forEach(result => {
                const className = result.passed ? 'test-pass' : 'test-fail';
                const status = result.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
                const errorMsg = result.error ? ` - ${result.error}` : '';
                html += `<div class="test-result ${className}">${result.name}: ${status}${errorMsg}</div>`;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Test configuration persistence
        async function testConfigurationPersistence() {
            const resultsDiv = document.getElementById('function-test-results');
            resultsDiv.innerHTML += '<p>æµ‹è¯•é…ç½®æŒä¹…åŒ–...</p>';
            
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                // Save a test configuration
                await window.TTSService.updateTTSConfiguration('voice', 'dashu');
                await window.TTSService.updateTTSConfiguration('volume', 75);
                
                // Create a new service instance to test persistence
                await window.TTSService.resetTTSService();
                const newService = await window.TTSService.getTTSService();
                const config = await newService.getConfiguration();
                
                if (config.voice === 'dashu' && config.volume === 75) {
                    resultsDiv.innerHTML += '<div class="test-result test-pass">âœ… é…ç½®æŒä¹…åŒ–æµ‹è¯•é€šè¿‡</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="test-result test-fail">âŒ é…ç½®æŒä¹…åŒ–æµ‹è¯•å¤±è´¥</div>';
                }
                
                ttsService = newService; // Update reference
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-result test-fail">âŒ é…ç½®æŒä¹…åŒ–æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // Test error handling
        async function testErrorHandling() {
            const resultsDiv = document.getElementById('function-test-results');
            resultsDiv.innerHTML += '<p>æµ‹è¯•é”™è¯¯å¤„ç†...</p>';
            
            try {
                if (!ttsService) {
                    await initializeSystem();
                }
                
                // Test invalid voice
                try {
                    await ttsService.synthesize('æµ‹è¯•', { voice: 'invalid_voice' });
                    resultsDiv.innerHTML += '<div class="test-result test-fail">âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥ - åº”è¯¥æŠ›å‡ºé”™è¯¯</div>';
                } catch (error) {
                    resultsDiv.innerHTML += '<div class="test-result test-pass">âœ… æ— æ•ˆéŸ³è‰²é”™è¯¯å¤„ç†æ­£ç¡®</div>';
                }
                
                // Test invalid options
                const engine = ttsService.engines.get('web-speech');
                const validation = engine.validateOptions({ speed: 999 });
                
                if (!validation.isValid) {
                    resultsDiv.innerHTML += '<div class="test-result test-pass">âœ… é€‰é¡¹éªŒè¯é”™è¯¯å¤„ç†æ­£ç¡®</div>';
                } else {
                    resultsDiv.innerHTML += '<div class="test-result test-fail">âŒ é€‰é¡¹éªŒè¯åº”è¯¥å¤±è´¥</div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-result test-fail">âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('TTS Integration Test page loaded');
        });
    </script>
</body>
</html>