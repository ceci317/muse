<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muse | å¥¹çš„æƒ…æ¬²ç”»å»Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muse: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#121212',
                            rose: '#e11d48', 
                            gold: '#e5e5e5',
                            dim: '#525252',
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1.5s ease-out forwards',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(20px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* === Background Slideshow === */
        .hero-slideshow {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            overflow: hidden;
        }
        .slide-image {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 3s ease-in-out, transform 10s ease-out; 
            filter: contrast(1.1) brightness(0.7) saturate(1.1);
            transform: scale(1.05);
        }
        .slide-image.active {
            opacity: 0.6; 
            transform: scale(1);
        }

        /* === Typography & Effects === */
        .flow-text-container {
            position: relative;
            filter: url(#flow-filter);
            mix-blend-mode: overlay;
        }
        
        .flow-text-layer {
            font-family: "Playfair Display", serif; 
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 0 40px rgba(225, 29, 72, 0.5); 
            letter-spacing: 0.15em;
        }

        /* Glass & Utils */
        .glass-panel { background: rgba(20, 20, 20, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .card-inner { transition: transform 0.8s; transform-style: preserve-3d; }
        .card-front, .card-back { backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }
        .magic-btn { background: linear-gradient(90deg, rgba(225,29,72,0) 0%, rgba(225,29,72,0.2) 50%, rgba(225,29,72,0) 100%); background-size: 200% 100%; }
        .selected-option { background: rgba(225, 29, 72, 0.15); border-color: #e11d48; color: #e5e5e5; }
        
        /* Provider Toggle */
        .provider-btn.active { background-color: rgba(225, 29, 72, 0.2); border-color: #e11d48; color: white; }
    </style>
</head>
<body class="bg-muse-black text-muse-gold font-sans antialiased overflow-hidden selection:bg-muse-rose selection:text-white">

    <svg style="display: none;">
        <defs>
            <filter id="flow-filter">
                <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="1" result="noise" seed="0">
                    <animate attributeName="baseFrequency" dur="15s" values="0.01;0.005;0.01" repeatCount="indefinite" />
                </feTurbulence>
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="8" /> 
            </filter>
        </defs>
    </svg>

    <!-- 1. HERO SECTION -->
    <section id="landing-page" class="relative w-full h-screen overflow-hidden flex flex-col items-center justify-center z-50 bg-muse-black">
        
        <div class="hero-slideshow" id="slideshow-container">
            <div class="absolute inset-0 bg-gradient-to-b from-muse-black/40 via-transparent to-muse-black/90 z-10"></div>
            <div class="absolute inset-0 opacity-[0.08] z-10" style="background-image: url('https://grainy-gradients.vercel.app/noise.svg');"></div>
        </div>

        <div class="relative z-20 text-center px-6 flex flex-col items-center">
            <div class="flow-text-container mb-8 animate-fade-in">
                <h1 class="flow-text-layer text-8xl md:text-[11rem] font-black leading-none select-none">
                    MUSE
                </h1>
            </div>

            <p class="font-serif italic text-white/70 text-lg md:text-xl mb-12 animate-fade-in mix-blend-screen" style="animation-delay: 0.3s;">
                Your Narrative. Your Pleasure.
            </p>
            
            <div class="animate-fade-in" style="animation-delay: 0.6s;">
                <button onclick="enterPrism()" class="group relative px-12 py-4 overflow-hidden rounded-full border border-white/20 hover:border-muse-rose transition-all duration-500 bg-white/5 backdrop-blur-md">
                    <div class="absolute inset-0 w-0 bg-muse-rose/40 transition-all duration-500 ease-out group-hover:w-full"></div>
                    <span class="relative font-serif text-sm tracking-[0.25em] text-white group-hover:text-white transition-colors duration-300 uppercase">
                        ä»Šæ™šä½ ä¹Ÿç¡ä¸ç€å—ï¼Ÿ
                    </span>
                </button>
            </div>
        </div>

        <div class="absolute bottom-10 text-white/20 text-[10px] tracking-[0.5em] animate-fade-in z-20" style="animation-delay: 1s;">
            SCROLL TO ENTER
        </div>
    </section>

    <!-- 2. The Prism (Quiz) -->
    <section id="prism-modal" class="fixed inset-0 z-[60] hidden bg-muse-black/95 backdrop-blur-xl flex items-center justify-center p-6 transition-opacity duration-500">
        <div class="max-w-xl w-full">
            <div class="mb-8 flex justify-between items-end border-b border-white/10 pb-4">
                <h2 class="font-serif text-3xl text-muse-gold">The Prism</h2>
                <span class="text-xs text-muse-dim tracking-widest" id="prism-step-indicator">STEP 1 / 3</span>
            </div>
            <div id="question-container" class="min-h-[300px] flex flex-col justify-center animate-fade-in"></div>
            
            <div class="flex justify-between mt-8">
                <button onclick="prevQuestion()" id="prev-btn" class="text-muse-dim hover:text-white text-xs tracking-widest invisible flex items-center gap-2">
                    <span>â†</span> BACK
                </button>
            </div>
        </div>
    </section>

    <!-- 3. Main Dashboard -->
    <main id="main-content" class="fixed inset-0 top-0 w-full h-screen hidden flex-col md:flex-row z-40 bg-muse-black transition-opacity duration-1000 opacity-0">
        
        <div class="absolute top-6 right-6 z-50 flex gap-4 items-center">
            <button onclick="openOracle()" class="group flex items-center gap-2 text-xs text-muse-gold hover:text-white tracking-widest transition px-3 py-1 rounded-full border border-muse-gold/20 hover:border-muse-rose/50 bg-black/20 backdrop-blur-sm">
                <span class="text-lg group-hover:animate-pulse">ğŸ”®</span> THE ORACLE
            </button>
            <button onclick="openPrism()" class="text-xs text-muse-dim hover:text-white tracking-widest transition">PROFILE</button>
            <button onclick="openApiKeySettings()" class="text-xs text-muse-dim hover:text-white tracking-widest transition">API SETTINGS</button>
        </div>

        <!-- Left: AI Solo Fantasy -->
        <div class="relative w-full md:w-5/12 h-1/2 md:h-full border-b md:border-b-0 md:border-r border-white/5 flex flex-col bg-muse-panel">
            <div class="absolute inset-0 overflow-hidden">
                <div class="absolute -top-[20%] -left-[20%] w-[150%] h-[150%] bg-[url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop')] bg-cover opacity-10 blur-sm mix-blend-overlay"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-muse-panel via-muse-panel/90 to-transparent"></div>
            </div>
            <div class="relative z-10 flex-1 flex flex-col p-8 md:p-12 justify-center">
                <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-muse-rose animate-pulse"></span>Solo Fantasy
                </span>
                <h2 class="font-serif text-3xl md:text-4xl text-muse-gold mb-6">å¹»æƒ³ç¼–å‰§</h2>
                <p class="text-muse-dim text-sm mb-8 font-light leading-relaxed max-w-sm">
                    ä¸éœ€è¦å…·ä½“çš„å¯¹è±¡ï¼Œåªéœ€è¦ä¸€ä¸ªç¬é—´ã€‚<br>è¾“å…¥ä¸€ä¸ªå…³é”®è¯ï¼ŒMuse ä¸ºä½ ç”Ÿæˆä¸€æ®µå…³äºå£°éŸ³ã€æ°”å‘³ä¸è§¦è§‰çš„ç§å¯†ç‹¬ç™½ã€‚
                </p>
                <div class="space-y-4">
                    <input type="text" id="script-prompt" placeholder="ä¾‹å¦‚ï¼šæ·¡æ·¡çš„çƒŸè‰å‘³ã€è¢«é›¨æ·‹æ¹¿çš„è¡¬è¡«..." class="w-full bg-black/30 border border-white/10 rounded-lg p-4 text-muse-gold placeholder-muse-dim focus:outline-none focus:border-muse-rose transition backdrop-blur-sm text-sm">
                    <button onclick="generateScript()" id="script-btn" class="w-full py-3 bg-white/5 hover:bg-muse-rose text-white text-xs tracking-[0.2em] rounded-lg transition duration-500 border border-white/5 hover:border-transparent">GENERATE</button>
                    <div id="script-result" class="hidden mt-6 p-6 border-l border-muse-rose/30 bg-white/5 rounded-r-lg text-muse-gold/90 text-sm font-serif leading-loose italic max-h-[30vh] overflow-y-auto no-scrollbar animate-fade-in"></div>
                </div>
            </div>
        </div>

        <!-- Right: Interactive Story -->
        <div class="relative w-full md:w-7/12 h-1/2 md:h-full flex flex-col bg-muse-black">
            <!-- Scenario Selector -->
            <div id="scenario-selector" class="flex-1 p-8 md:p-12 overflow-y-auto no-scrollbar">
                <div class="mb-8">
                    <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 block">Interactive Roleplay</span>
                    <h2 class="font-serif text-3xl md:text-4xl text-muse-gold">é€‰æ‹©ä½ çš„åœºæ™¯</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div onclick="startStory('elevator')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1583324113626-70df0f4deaab?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">ç§äººç”µæ¢¯</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Tension Â· Confined</p>
                        </div>
                    </div>
                    <div onclick="startStory('office')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æ·±å¤œåŠå…¬å®¤</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Power Â· Taboo</p>
                        </div>
                    </div>
                    <div onclick="startStory('library')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">ç¦å¿Œå›¾ä¹¦é¦†</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Quiet Â· Secret</p>
                        </div>
                    </div>
                    <div onclick="startStory('car')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æš´é›¨è½¦å†…</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Intimate Â· Sound</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="hidden flex-col h-full relative bg-muse-black">
                <div class="p-4 border-b border-white/5 flex justify-between items-center bg-muse-panel/50 backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <button onclick="exitStory()" class="text-muse-dim hover:text-white transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg></button>
                        <div>
                            <h3 class="font-serif text-lg text-white" id="chat-title">Story Title</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Interactive Mode</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="hearThoughts()" class="flex items-center gap-1 text-[10px] text-muse-dim hover:text-muse-rose border border-white/10 hover:border-muse-rose/50 rounded px-2 py-1 transition" title="çª¥æ¢ä»–çš„å¿ƒå£°">
                            <span>âœ¨</span> çª¥æ¢å¿ƒå£°
                        </button>
                        <div class="text-[10px] text-muse-dim px-2 py-1 border border-white/10 rounded" id="user-pref-badge">HETERO</div>
                    </div>
                </div>
                <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6 no-scrollbar"></div>
                <div class="p-4 bg-muse-black border-t border-white/5">
                    <div class="relative max-w-2xl mx-auto">
                        <input type="text" id="story-input" placeholder="æè¿°ä½ çš„åŠ¨ä½œæˆ–è¨€è¯­..." class="w-full bg-white/5 border border-white/10 rounded-full pl-6 pr-12 py-3 text-sm text-muse-gold focus:outline-none focus:border-muse-rose focus:bg-white/10 transition" onkeypress="if(event.key==='Enter') continueStory()">
                        <button onclick="continueStory()" class="absolute right-2 top-2 p-1.5 text-muse-dim hover:text-muse-rose transition bg-white/5 rounded-full hover:bg-white/10"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Oracle Modal -->
    <div id="oracle-modal" class="fixed inset-0 z-[80] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="max-w-md w-full text-center">
            <h3 class="font-serif text-3xl text-muse-gold mb-2">The Oracle</h3>
            <p class="text-xs text-muse-dim tracking-widest mb-8">è®© Gemini çª¥æ¢ä½ çš„æ½œæ„è¯†...</p>
            <div id="oracle-card-container" class="relative w-64 h-96 mx-auto mb-8 cursor-pointer perspective-1000 hidden" onclick="flipCard()">
                <div class="card-inner relative w-full h-full shadow-2xl transition-transform duration-700 transform-style-3d">
                    <div class="card-front absolute inset-0 bg-muse-panel border border-muse-rose/30 rounded-xl flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180" style="transform: rotateY(180deg);">
                        <div class="text-6xl mb-4" id="oracle-icon">ğŸ”®</div>
                        <h4 class="font-serif text-xl text-muse-rose mb-4" id="oracle-title">...</h4>
                        <p class="text-sm text-muse-gold/80 italic leading-relaxed" id="oracle-desc">...</p>
                    </div>
                    <div class="card-back absolute inset-0 bg-gradient-to-br from-stone-900 to-black border border-white/10 rounded-xl flex items-center justify-center backface-hidden">
                        <div class="text-muse-dim/20 text-6xl font-serif">M</div>
                        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                    </div>
                </div>
            </div>
            <div id="oracle-controls">
                <button onclick="consultOracle()" id="oracle-btn" class="magic-btn animate-shimmer text-white px-8 py-3 rounded-full text-xs tracking-[0.2em] transition border border-white/10 hover:border-muse-rose">æŠ½ä¸€å¼ ç‰Œ</button>
            </div>
            <button onclick="closeOracle()" class="mt-8 text-xs text-muse-dim hover:text-white underline">ç¦»å¼€</button>
        </div>
    </div>

    <!-- API Key Modal (Updated for Multi-Provider) -->
    <div id="apikey-modal" class="fixed inset-0 z-[70] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel max-w-md w-full p-8 rounded-lg">
            <h3 class="font-serif text-xl text-muse-gold mb-2">AI Settings</h3>
            <p class="text-xs text-muse-dim mb-6">é€‰æ‹©ä½ çš„çµæ„Ÿå¼•æ“</p>
            
            <!-- Provider Toggle -->
            <div class="flex p-1 bg-white/5 rounded-lg mb-6">
                <button onclick="switchProvider('gemini')" id="btn-gemini" class="provider-btn flex-1 py-2 text-xs tracking-widest rounded transition-all text-muse-dim hover:text-white active">
                    GOOGLE GEMINI
                </button>
                <button onclick="switchProvider('dashscope')" id="btn-dashscope" class="provider-btn flex-1 py-2 text-xs tracking-widest rounded transition-all text-muse-dim hover:text-white">
                    ALIYUN DASHSCOPE
                </button>
            </div>

            <!-- Gemini Input -->
            <div id="input-group-gemini" class="space-y-2">
                <label class="text-[10px] text-muse-dim uppercase tracking-widest">Gemini API Key</label>
                <input type="password" id="gemini-key-input" placeholder="Start with AI..." class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-muse-gold focus:border-muse-rose focus:outline-none text-sm transition-colors">
                <div class="text-right"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-muse-dim underline hover:text-muse-rose">Get Gemini Key</a></div>
            </div>

            <!-- DashScope Input -->
            <div id="input-group-dashscope" class="space-y-2 hidden">
                <label class="text-[10px] text-muse-dim uppercase tracking-widest">DashScope API Key</label>
                <input type="password" id="dashscope-key-input" placeholder="sk-..." class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-muse-gold focus:border-muse-rose focus:outline-none text-sm transition-colors">
                <div class="text-right"><a href="https://bailian.console.aliyun.com/" target="_blank" class="text-[10px] text-muse-dim underline hover:text-muse-rose">Get DashScope Key</a></div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="saveApiSettings()" class="flex-1 bg-muse-rose hover:bg-muse-rose/80 text-white py-2 rounded-lg transition text-xs tracking-widest">SAVE & CONNECT</button>
                <button onclick="document.getElementById('apikey-modal').classList.add('hidden')" class="flex-1 border border-white/10 text-muse-dim py-2 rounded-lg hover:text-white transition text-xs tracking-widest">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // ========== 1. Dynamic Slideshow Logic ==========
        const backgroundImages = [
            "https://images.unsplash.com/photo-1605810230434-7631ac76ec81?q=80&w=1920&auto=format&fit=crop", 
            "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1920&auto=format&fit=crop",     
            "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1920&auto=format&fit=crop",     
            "https://images.unsplash.com/photo-1504333638930-c8787321eee0?q=80&w=1920&auto=format&fit=crop"      
        ];

        let currentSlide = 0;

        function initSlideshow() {
            const container = document.getElementById('slideshow-container');
            
            // é¢„åŠ è½½å¹¶åˆ›å»º DOM å…ƒç´ 
            backgroundImages.forEach((src, index) => {
                const img = document.createElement('img');
                img.src = src;
                img.className = `slide-image ${index === 0 ? 'active' : ''}`;
                container.prepend(img); // Prepend to be behind the overlays
            });

            // å¯åŠ¨å®šæ—¶å™¨
            setInterval(() => {
                const images = document.querySelectorAll('.slide-image');
                images[currentSlide].classList.remove('active');
                
                currentSlide = (currentSlide + 1) % backgroundImages.length;
                
                images[currentSlide].classList.add('active');
            }, 6000); // æ¯ 6 ç§’åˆ‡æ¢ä¸€æ¬¡
        }

        document.addEventListener('DOMContentLoaded', initSlideshow);


        // ========== 2. The Prism (Quiz Logic - Updated Auto Advance) ==========
        const quizData = [
            { id: 'orientation', question: "ä½ çš„å¿ƒï¼Œè¢«ä»€ä¹ˆå¸å¼•ï¼Ÿ", options: [{ label: "ç”·æ€§ (Hetero)", value: "hetero_male", desc: "æ¸´æœ›ç”·æ€§çš„å¼ åŠ›ä¸ä½“æ¸©" }, { label: "å¥³æ€§ (Lesbian/GL)", value: "lesbian", desc: "æ²‰æººäºå¥³æ€§çš„ç»†è…»ä¸æŸ”ç¾" }, { label: "Dom/å››çˆ± (Femdom)", value: "femdom", desc: "äº«å—æŒæ§ä¸ä¸»å¯¼çš„å¿«æ„Ÿ" }, { label: "ä¸è¢«å®šä¹‰ (Fluid)", value: "fluid", desc: "çµé­‚çš„å…±é¸£é«˜äºæ€§åˆ«" }] },
            { id: 'atmosphere', question: "ä½ åçˆ±æ€æ ·çš„æ°›å›´ï¼Ÿ", options: [{ label: "æš§æ˜§æ‹‰æ‰¯", value: "tension", desc: "è‹¥å³è‹¥ç¦»ï¼Œçœ¼ç¥äº¤æ±‡" }, { label: "ç¦å¿Œåˆºæ¿€", value: "taboo", desc: "èƒŒå¾·æ„Ÿä¸å±é™©çš„è¾¹ç¼˜" }, { label: "æ¸©æŸ”æ²»æ„ˆ", value: "gentle", desc: "ç¼“æ…¢çš„æ‹¥æŠ±ä¸ä½è¯­" }, { label: "ç»å¯¹æœä»", value: "submission", desc: "æƒåŠ›çš„è®©æ¸¡ä¸æ¥ç®¡" }] },
            { id: 'style', question: "ä½ å¸Œæœ›çš„å‰§æœ¬é£æ ¼ï¼Ÿ", options: [{ label: "å”¯ç¾å«è“„", value: "poetic", desc: "æ³¨é‡äº”æ„Ÿæå†™ï¼Œç•™æœ‰æƒ³è±¡ç©ºé—´" }, { label: "ç›´ç™½ç‚½çƒ­", value: "intense", desc: "æ›´ç›´æ¥çš„æ„Ÿå®˜åˆºæ¿€ä¸æå†™" }] }
        ];
        let currentStep = 0;
        let userProfile = {};

        function enterPrism() { 
            const landing = document.getElementById('landing-page');
            landing.style.transition = 'opacity 1s';
            landing.style.opacity = '0';
            setTimeout(() => {
                landing.style.display = 'none';
                document.getElementById('prism-modal').classList.remove('hidden');
                renderQuestion();
            }, 1000);
        }
        function openPrism() { document.getElementById('main-content').classList.remove('flex'); document.getElementById('main-content').classList.add('hidden'); document.getElementById('prism-modal').classList.remove('hidden'); currentStep = 0; renderQuestion(); }
        
        function renderQuestion() {
            const q = quizData[currentStep];
            const container = document.getElementById('question-container');
            document.getElementById('prism-step-indicator').innerText = `STEP ${currentStep + 1} / ${quizData.length}`;
            let html = `<h3 class="text-2xl font-serif text-white mb-8 animate-fade-in">${q.question}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in">`;
            q.options.forEach(opt => {
                const isSelected = userProfile[q.id] === opt.value;
                html += `<div onclick="selectOption('${q.id}', '${opt.value}')" class="cursor-pointer border border-white/10 rounded-lg p-4 transition-all hover:bg-white/5 hover:border-muse-rose/50 ${isSelected ? 'selected-option' : ''}"><div class="font-serif text-lg mb-1">${opt.label}</div><div class="text-xs text-muse-dim">${opt.desc}</div></div>`;
            });
            container.innerHTML = html + `</div>`;
            
            // Back Button Visibility
            document.getElementById('prev-btn').style.visibility = currentStep > 0 ? 'visible' : 'hidden';
        }

        function selectOption(key, value) { 
            userProfile[key] = value; 
            renderQuestion(); // Re-render to show selection highlight
            
            // Auto Advance with a slight delay for visual feedback
            setTimeout(() => {
                nextQuestion();
            }, 400); 
        }

        function prevQuestion() { if(currentStep>0) { currentStep--; renderQuestion(); } }
        function nextQuestion() { if(currentStep<quizData.length-1) { currentStep++; renderQuestion(); } else finishPrism(); }
        function finishPrism() {
            localStorage.setItem('muse_profile', JSON.stringify(userProfile));
            document.getElementById('prism-modal').classList.add('hidden');
            const main = document.getElementById('main-content');
            main.classList.remove('hidden'); main.classList.add('flex');
            setTimeout(() => main.classList.remove('opacity-0'), 50);
            document.getElementById('user-pref-badge').innerText = userProfile.orientation.toUpperCase();
        }

        // ========== 3. Dual AI Logic (Gemini & DashScope) ==========
        let activeProvider = localStorage.getItem('muse_ai_provider') || 'gemini';

        function switchProvider(provider) {
            activeProvider = provider;
            // UI Toggle
            document.querySelectorAll('.provider-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${provider}`).classList.add('active');
            
            // Show inputs
            document.getElementById('input-group-gemini').classList.add('hidden');
            document.getElementById('input-group-dashscope').classList.add('hidden');
            document.getElementById(`input-group-${provider}`).classList.remove('hidden');
        }

        function getApiKey(provider = activeProvider) {
            if (provider === 'gemini') return localStorage.getItem('muse_gemini_apikey');
            if (provider === 'dashscope') return localStorage.getItem('muse_dashscope_apikey');
            return null;
        }

        function saveApiSettings() {
            const geminiKey = document.getElementById('gemini-key-input').value.trim();
            const dashKey = document.getElementById('dashscope-key-input').value.trim();
            
            if (geminiKey) localStorage.setItem('muse_gemini_apikey', geminiKey);
            if (dashKey) localStorage.setItem('muse_dashscope_apikey', dashKey);
            
            localStorage.setItem('muse_ai_provider', activeProvider);
            
            document.getElementById('apikey-modal').classList.add('hidden');
            if(window.pendingAction) window.pendingAction();
        }

        function openApiKeySettings() {
            // Load saved state
            const savedProvider = localStorage.getItem('muse_ai_provider') || 'gemini';
            switchProvider(savedProvider);
            
            document.getElementById('gemini-key-input').value = localStorage.getItem('muse_gemini_apikey') || '';
            document.getElementById('dashscope-key-input').value = localStorage.getItem('muse_dashscope_apikey') || '';
            
            document.getElementById('apikey-modal').classList.remove('hidden');
        }

        function requireApiKey(cb) {
            if(!getApiKey()){
                window.pendingAction = cb;
                openApiKeySettings();
                return false;
            }
            return true;
        }

        function getSystemPrompt(type) {
            const p = userProfile;
            let persona = "";
            if (p.orientation === 'hetero_male') persona = "äº’åŠ¨å¯¹è±¡ï¼šå…·æœ‰æ€§å¼ åŠ›çš„ç”·æ€§ã€‚";
            else if (p.orientation === 'lesbian') persona = "äº’åŠ¨å¯¹è±¡ï¼šç»†è…»ã€æŸ”ç¾çš„å¥³æ€§ã€‚";
            else if (p.orientation === 'femdom') persona = "äº’åŠ¨å¯¹è±¡ï¼šé¡ºä»çš„ç”·æ€§ï¼ˆMå±æ€§ï¼‰ã€‚";
            else persona = "äº’åŠ¨å¯¹è±¡ï¼šæ€§åˆ«æ¨¡ç³Šï¼Œçµé­‚å…±é¸£ã€‚";

            if (p.atmosphere === 'taboo') persona += " æ°›å›´ï¼šç¦å¿Œã€å±é™©ã€‚";
            else if (p.atmosphere === 'gentle') persona += " æ°›å›´ï¼šæ¸©æŸ”ã€æ²»æ„ˆã€‚";
            else if (p.atmosphere === 'submission') persona += " æ°›å›´ï¼šæƒåŠ›äº¤æ¢ã€æŒæ§ã€‚";
            else persona += " æ°›å›´ï¼šæš§æ˜§æ‹‰æ‰¯ã€‚";

            return `ä½ æ˜¯ä¸€ä¸ªå¥³æ€§å‘æƒ…è‰²æ–‡å­¦åŠ©æ‰‹ã€‚${persona} 
            è¯·é€šè¿‡äº”æ„Ÿæå†™æ„å»ºæ²‰æµ¸æ„Ÿã€‚
            å¯¹äº"äº’åŠ¨æ•…äº‹"ï¼Œè¯·ä»¥ç¬¬äºŒäººç§°ï¼ˆä½ ï¼‰è¿›è¡Œæ²‰æµ¸å¼è§’è‰²æ‰®æ¼”ã€‚
            ç¦æ­¢ç”Ÿæˆéæ³•ã€æœªæˆå¹´ã€æš´åŠ›è¡€è…¥å†…å®¹ã€‚`;
        }

        // --- Core AI Call Function ---
        async function callAI(prompt, systemPrompt, jsonMode = false) {
            if (activeProvider === 'dashscope') {
                return await callDashScope(prompt, systemPrompt, jsonMode);
            } else {
                return await callGemini(prompt, systemPrompt, jsonMode);
            }
        }

        // Gemini Implementation
        async function callGemini(prompt, systemPrompt, jsonMode) {
            const apiKey = getApiKey('gemini');
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{parts: [{text: prompt}]}], systemInstruction: {parts: [{text: systemPrompt}]} };
            if(jsonMode) payload.generationConfig = { responseMimeType: "application/json" };

            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Muse æš‚æ—¶å¤±è”...";
            } catch(e) { console.error(e); return "ç½‘ç»œè¿æ¥é”™è¯¯ (Gemini)"; }
        }

        // DashScope Implementation (OpenAI Compatible)
        async function callDashScope(prompt, systemPrompt, jsonMode) {
            const apiKey = getApiKey('dashscope');
            const url = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
            
            // Build messages array
            const messages = [
                { role: "system", content: systemPrompt },
                { role: "user", content: prompt }
            ];

            const payload = {
                model: "qwen-plus",
                messages: messages,
            };
            
            // DashScope doesn't strictly support response_format: "json_object" in the same way for all models, 
            // but prompt engineering usually works. We'll rely on the prompt.

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    console.error("DashScope Error:", err);
                    return `API Error: ${err.message || res.status}`;
                }

                const data = await res.json();
                return data.choices?.[0]?.message?.content || "Muse æš‚æ—¶å¤±è”...";
            } catch(e) {
                console.error(e);
                return "ç½‘ç»œè¿æ¥é”™è¯¯ (DashScope)";
            }
        }

        async function generateScript() {
            if(!requireApiKey(generateScript)) return;
            const input = document.getElementById('script-prompt');
            const btn = document.getElementById('script-btn');
            const resDiv = document.getElementById('script-result');
            if(!input.value) return;
            btn.innerText = "WRITING..."; btn.disabled = true;
            resDiv.classList.remove('hidden'); resDiv.innerHTML = '<span class="animate-pulse">æ­£åœ¨ç¼–ç»‡æ¢¦å¢ƒ...</span>';
            const system = getSystemPrompt('script') + " ä»»åŠ¡ï¼šæ ¹æ®å…³é”®è¯ç”Ÿæˆä¸€æ®µ100å­—å·¦å³çš„ç‹¬ç™½ã€‚";
            
            // Use Unified Call
            const text = await callAI(input.value, system);
            
            resDiv.innerHTML = marked.parse(text); btn.innerText = "GENERATE"; btn.disabled = false;
        }

        let storyContext = "";
        function startStory(scenario) {
            const selector = document.getElementById('scenario-selector');
            const ui = document.getElementById('chat-interface');
            const title = document.getElementById('chat-title');
            const history = document.getElementById('chat-history');
            selector.classList.add('hidden'); ui.classList.remove('hidden'); ui.classList.add('flex'); history.innerHTML = ''; 
            const p = userProfile;
            let intro = "", target = p.orientation === 'lesbian' ? 'å¥¹' : 'ä»–';
            if (scenario === 'elevator') {
                title.innerText = "ç§äººç”µæ¢¯"; storyContext = "åœºæ™¯ï¼šæ•…éšœç”µæ¢¯ã€‚";
                intro = p.orientation === 'femdom' ? `ç”µæ¢¯æ•…éšœã€‚${target}è·ªåœ¨è§’è½ï¼ŒæŠ¬å¤´çœ‹ä½ ï¼Œçœ¼ç¥å……æ»¡æ¸´æœ›ã€‚"ä¸»äºº..."` : `ç”µæ¢¯ç¯å…‰é—ªçƒï¼Œ${target}æ¾å¼€é¢†å¸¦ï¼Œçœ¼ç¥æ·±é‚ƒåœ°çœ‹ç€ä½ ã€‚`;
            } else if (scenario === 'office') {
                title.innerText = "æ·±å¤œåŠå…¬å®¤"; storyContext = "åœºæ™¯ï¼šæ·±å¤œåŠå…¬å®¤ã€‚";
                intro = `å¤§å®¶éƒ½ä¸‹ç­äº†ã€‚${target}èµ°è¿›ä½ çš„åŠå…¬å®¤ï¼Œåæ‰‹é”é—¨ã€‚"è¿˜åœ¨å¿™å—ï¼Ÿ"`;
            } else if (scenario === 'library') {
                title.innerText = "ç¦å¿Œå›¾ä¹¦é¦†"; storyContext = "åœºæ™¯ï¼šå›¾ä¹¦é¦†æ­»è§’ã€‚";
                intro = `ä¹¦æ¶æ·±å¤„ï¼Œ${target}çš„æ‰‹æŒ‡åˆ’è¿‡ä¹¦è„Šï¼Œåœåœ¨ä½ æ‰‹èƒŒä¸Šã€‚`;
            } else if (scenario === 'car') {
                title.innerText = "æš´é›¨è½¦å†…"; storyContext = "åœºæ™¯ï¼šæš´é›¨è½¦å†…ã€‚";
                intro = `é›¨å£°å¾ˆå¤§ï¼Œè½¦çª—å…¨æ˜¯é›¾æ°”ã€‚${target}è°ƒä½åº§æ¤…ï¼Œä¾§èº«çœ‹ä½ ã€‚`;
            }
            addBubble(intro, 'ai');
        }
        function exitStory() { document.getElementById('chat-interface').classList.remove('flex'); document.getElementById('chat-interface').classList.add('hidden'); document.getElementById('scenario-selector').classList.remove('hidden'); }
        async function continueStory() {
            if(!requireApiKey(continueStory)) return;
            const input = document.getElementById('story-input');
            const val = input.value.trim();
            if(!val) return;
            addBubble(val, 'user'); input.value = '';
            const loadingId = addBubble('...', 'ai', true);
            const system = getSystemPrompt('story');
            const fullPrompt = `å½“å‰å‰§æƒ…ï¼š${storyContext}\nä¸Šæ–‡ï¼š...\nç”¨æˆ·è¡ŒåŠ¨ï¼š${val}\nè¯·ä»¥ç¬¬äºŒäººç§°ï¼ˆä½ ï¼‰ç»­å†™å‰§æƒ…ã€‚`;
            
            // Use Unified Call
            const reply = await callAI(fullPrompt, system);
            
            document.getElementById(loadingId).remove();
            addBubble(reply, 'ai');
            storyContext += `\nç”¨æˆ·ï¼š${val}\nAIï¼š${reply}`;
        }
        function addBubble(text, role, isLoading=false) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'text-right' : 'text-left';
            div.id = 'msg-' + Date.now();
            const bubble = document.createElement('div');
            bubble.className = `inline-block max-w-[85%] px-5 py-3 rounded-2xl text-sm leading-relaxed ${role === 'user' ? 'bg-muse-rose/20 text-white border border-muse-rose/30 rounded-br-none' : 'bg-white/10 text-muse-gold border border-white/5 rounded-bl-none font-serif'}`;
            if(isLoading) bubble.classList.add('animate-pulse');
            bubble.innerHTML = isLoading ? text : marked.parse(text);
            div.appendChild(bubble); history.appendChild(div); history.scrollTop = history.scrollHeight;
            return div.id;
        }

        async function hearThoughts() {
            if(!requireApiKey(hearThoughts)) return;
            if(!storyContext) { alert("è¯·å…ˆå¼€å§‹ä¸€ä¸ªæ•…äº‹"); return; }
            const loadingId = addBubble('âœ¨ æ­£åœ¨çª¥æ¢...', 'ai', true);
            const system = getSystemPrompt('story');
            const prompt = `åŸºäºæ­¤å‰§æƒ…ï¼š${storyContext}\n\nè¯·ç”Ÿæˆä¸€æ®µè§’è‰²çš„"å†…å¿ƒç‹¬ç™½"ï¼ˆMind Voiceï¼‰ã€‚è¿™æ˜¯ä»–/å¥¹æ²¡æœ‰è¯´å‡ºå£ï¼Œä½†å†…å¿ƒæåº¦æ¸´æœ›ã€å‹æŠ‘æˆ–å¯¹"ä½ "çš„çœŸå®æ¬²æœ›ã€‚å†…å®¹è¦ç®€çŸ­ã€æœ‰åŠ›ã€å……æ»¡å¼ åŠ›ã€‚ç”¨æ‹¬å·ï¼ˆï¼‰åŒ…è£¹ã€‚`;
            
            // Use Unified Call
            const thoughts = await callAI(prompt, system);
            
            document.getElementById(loadingId).remove();
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'text-center my-4';
            div.innerHTML = `<div class="inline-block px-4 py-2 bg-muse-dim/20 border border-muse-dim/40 rounded-lg text-xs text-muse-gold/70 italic tracking-widest animate-pulse">${marked.parse(thoughts)}</div>`;
            history.appendChild(div); history.scrollTop = history.scrollHeight;
        }

        function openOracle() { document.getElementById('oracle-modal').classList.remove('hidden'); document.getElementById('oracle-card-container').classList.add('hidden'); document.getElementById('oracle-controls').classList.remove('hidden'); }
        function closeOracle() { document.getElementById('oracle-modal').classList.add('hidden'); resetCard(); }
        function resetCard() { const card = document.querySelector('.card-inner'); if(card) { card.style.transform = ''; card.classList.remove('flipped'); } }
        function flipCard() { const card = document.querySelector('.card-inner'); card.classList.toggle('flipped'); card.style.transform = card.classList.contains('flipped') ? 'rotateY(180deg)' : ''; }
        async function consultOracle() {
            if(!requireApiKey(consultOracle)) return;
            const btn = document.getElementById('oracle-btn');
            btn.innerText = "COMMUNING..."; btn.disabled = true;
            const system = "You are a mystical Oracle. Based on the user's profile, create a metaphorical 'Tarot Card' for them. Output JSON: { \"title\": \"Card Name (Chinese)\", \"icon\": \"Emoji\", \"desc\": \"Short poetic interpretation (Chinese)\" }";
            const prompt = `User Profile: ${JSON.stringify(userProfile)}. Draw a card representing their current hidden desire.`;
            try {
                // Use Unified Call with jsonMode (handled via prompt for DashScope mostly)
                const text = await callAI(prompt, system, true); 
                if (text.startsWith("Muse") || text.startsWith("ç½‘ç»œ") || text.startsWith("API")) throw new Error("API Request Failed");
                const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(cleanText);
                document.getElementById('oracle-title').innerText = data.title;
                document.getElementById('oracle-icon').innerText = data.icon;
                document.getElementById('oracle-desc').innerText = data.desc;
                document.getElementById('oracle-controls').classList.add('hidden');
                document.getElementById('oracle-card-container').classList.remove('hidden');
                setTimeout(flipCard, 500);
            } catch(e) { console.error(e); alert("The stars are silent. (Check your API Key)"); }
            finally { btn.innerText = "æŠ½ä¸€å¼ ç‰Œ"; btn.disabled = false; }
        }

        window.addEventListener('load', () => {
            const savedProfile = localStorage.getItem('muse_profile');
            if(savedProfile) userProfile = JSON.parse(savedProfile);
        });
    </script>
</body>
</html>