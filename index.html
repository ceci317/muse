<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muse | å¥¹çš„æƒ…æ¬²ç”»å»Š</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muse: {
                            dark: '#0c0a09',
                            panel: '#1c1917',
                            accent: '#e7e5e4',
                            rose: '#9f1239',
                            gold: '#d6d3d1',
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .playing-animation::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(159, 18, 57, 0.3);
            border-radius: 50%;
            z-index: -1;
            animation: pulse-ring 2s infinite;
        }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose strong { color: #d6d3d1; font-weight: normal; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.4); }
            50% { transform: scaleY(1); }
        }
        .wave-bar {
            animation: wave 1.2s ease-in-out infinite;
        }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body class="bg-muse-dark text-muse-accent font-sans antialiased selection:bg-muse-rose selection:text-white pb-32">

    <!-- 0. å‡†å…¥æµ‹è¯•æ¨¡æ€æ¡† (The Gate) -->
    <div id="gate-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-stone-800 rounded-lg max-w-2xl w-full p-8 md:p-12 fade-in">
                <h2 class="font-serif text-3xl text-muse-gold mb-2 text-center">The Gate</h2>
                <p class="text-center text-stone-400 text-sm mb-8">å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼Œæ‰¾åˆ°ä½ çš„å…±é¸£</p>
                
                <div id="gate-questions" class="space-y-6">
                    <!-- é—®é¢˜ä¼šåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div id="gate-result" class="hidden text-center">
                    <p class="font-serif text-xl text-muse-gold mb-4" id="gate-result-text"></p>
                    <button onclick="proceedToMasquerade()" class="bg-muse-rose hover:bg-muse-rose/80 text-white px-8 py-3 rounded-full transition">
                        ç»§ç»­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 0.1 èº«ä»½ç”Ÿæˆæ¨¡æ€æ¡† (The Masquerade) -->
    <div id="masquerade-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-muse-rose/30 rounded-lg max-w-md w-full p-12 text-center fade-in">
                <div class="mb-6">
                    <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-muse-rose/20 to-muse-gold/20 flex items-center justify-center border-2 border-muse-rose/50">
                        <span class="text-4xl font-serif text-muse-gold" id="persona-symbol">âœ¨</span>
                    </div>
                    <h2 class="font-serif text-2xl text-muse-gold mb-2">Welcome</h2>
                    <p class="text-3xl font-serif text-muse-rose mb-2" id="persona-name"></p>
                    <p class="text-sm text-stone-400">è¿™æ˜¯ä½ åœ¨ Muse çš„èº«ä»½</p>
                </div>
                <button onclick="enterGallery()" class="bg-muse-rose hover:bg-muse-rose/80 text-white px-8 py-3 rounded-full transition">
                    è¿›å…¥ç”»å»Š
                </button>
            </div>
        </div>
    </div>

    <!-- 1. é¡¶éƒ¨å¯¼èˆª -->
    <nav class="fixed top-0 w-full z-40 transition-all duration-300 bg-gradient-to-b from-muse-dark via-muse-dark/80 to-transparent backdrop-blur-[2px] pt-6 pb-12 px-6">
        <div class="max-w-screen-xl mx-auto flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-serif tracking-[0.2em] text-muse-gold">MUSE</h1>
                <p class="text-xs text-stone-500 tracking-widest mt-1 uppercase">Your Narrative. Your Pleasure.</p>
            </div>
            <div class="hidden md:flex gap-6 text-xs tracking-widest text-stone-500">
                <span class="hover:text-muse-gold cursor-pointer transition border-b border-transparent hover:border-muse-gold" onclick="filterContent('all')">ALL</span>
                <span class="hover:text-muse-gold cursor-pointer transition border-b border-transparent hover:border-muse-gold" onclick="openSanctuary()">SANCTUARY</span>
                <span class="hover:text-muse-gold cursor-pointer transition border-b border-transparent hover:border-muse-gold" onclick="openCompanion()">COMPANION</span>
            </div>
            <div class="flex gap-3">
                <button onclick="openSpectrumSettings()" class="text-xs border border-stone-600 px-4 py-2 rounded-full hover:bg-stone-800 hover:border-stone-400 transition duration-500">
                    SPECTRUM
                </button>
                <button onclick="openApiKeySettings()" class="text-xs border border-stone-600 px-4 py-2 rounded-full hover:bg-stone-800 hover:border-stone-400 transition duration-500" title="é…ç½® API Key">
                    API KEY
                </button>
                <button onclick="scrollToJoin()" class="text-xs border border-stone-600 px-5 py-2 rounded-full hover:bg-stone-800 hover:border-stone-400 transition duration-500">
                    REQUEST ACCESS
                </button>
            </div>
        </div>
    </nav>

    <!-- 2. ä¸»è¦å†…å®¹åŒº -->
    <main id="main-gallery" class="container mx-auto px-4 pt-32 max-w-4xl">
        
        <div class="text-center mb-12 opacity-80">
            <p class="font-serif italic text-xl text-stone-400">"æˆ´ä¸Šè€³æœºï¼Œé—­ä¸Šçœ¼ç›ï¼Œ<br>æˆ–è€…æ˜¯çœ‹ç€å…‰å½±æµåŠ¨ã€‚"</p>
        </div>

        <div id="gallery-grid" class="columns-2 md:columns-3 gap-4 space-y-4">

            <!-- 1. è§†è§‰å¡ç‰‡ï¼šå…‰å½±çš„æŠšæ‘¸ -->
            <div class="break-inside-avoid relative group rounded-lg overflow-hidden cursor-pointer" data-tags="all,demisexual">
                <img src="https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?q=80&w=600&auto=format&fit=crop" alt="Sensual Light" class="w-full h-auto object-cover grayscale brightness-75 group-hover:grayscale-0 group-hover:brightness-100 transition duration-1000 ease-in-out">
                <div class="absolute bottom-0 left-0 right-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 z-10 pointer-events-none">
                    <p class="font-serif text-sm italic text-white">å…‰å½±çš„æŠšæ‘¸</p>
                </div>
            </div>

            <!-- 2. éŸ³é¢‘å¡ç‰‡ï¼šé›¨å¤©çš„ä¹¦æˆ¿ -->
            <div class="break-inside-avoid relative rounded-lg overflow-hidden bg-muse-panel group cursor-pointer" onclick="togglePlay(this)" data-tags="all,demisexual">
                <div class="relative">
                    <img src="https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=600&auto=format&fit=crop" class="w-full h-64 object-cover opacity-60 group-hover:opacity-40 transition duration-700">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="play-btn w-12 h-12 rounded-full border border-white/30 flex items-center justify-center backdrop-blur-sm transition duration-300 group-hover:bg-white/10 group-hover:scale-110">
                            <svg class="w-5 h-5 text-white ml-1 play-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="w-5 h-5 text-white hidden pause-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] tracking-widest text-stone-500 uppercase">Audio Â· 3:20</span>
                        <span class="text-[10px] text-muse-rose">ASMR</span>
                    </div>
                    <h3 class="font-serif text-lg leading-tight text-muse-gold">é›¨å¤©çš„ä¹¦æˆ¿ä¸ä½è¯­</h3>
                </div>
                <audio src="https://www.soundjay.com/nature/sounds/rain-01.mp3" loop></audio> 
            </div>

            <!-- 3. äº’åŠ¨æ•…äº‹ï¼šç§äººç”µæ¢¯ -->
            <div class="break-inside-avoid bg-stone-900 rounded-lg overflow-hidden border border-stone-800 hover:border-muse-rose/30 transition duration-500 cursor-pointer group" onclick="openStoryModal()" data-tags="all">
                <div class="relative h-48 overflow-hidden">
                    <img src="https://images.unsplash.com/photo-1473181488821-2d23949a045a?q=80&w=600&auto=format&fit=crop" class="w-full h-full object-cover opacity-80 group-hover:scale-105 transition duration-1000 grayscale group-hover:grayscale-0">
                    <div class="absolute inset-0 bg-gradient-to-t from-stone-900 to-transparent"></div>
                    <span class="absolute top-3 right-3 text-[10px] bg-black/50 backdrop-blur text-muse-rose tracking-widest border border-muse-rose/50 px-2 py-0.5 rounded-full flex items-center">
                        <span class="mr-1">âœ¨</span> INTERACTIVE
                    </span>
                </div>
                <div class="p-5 relative">
                    <h3 class="font-serif text-xl mb-1 text-stone-200 group-hover:text-muse-rose transition">ç§äººç”µæ¢¯</h3>
                    <p class="text-xs text-stone-400 leading-relaxed line-clamp-2 mb-3">ç”µæ¢¯æ•…éšœåœåœ¨äº†22å±‚ã€‚ç¯å…‰é—ªçƒï¼Œåªæœ‰ä½ å’Œä»–ä¸¤ä¸ªäºº...</p>
                    <div class="flex items-center text-xs text-stone-500 group-hover:text-stone-300 transition">
                        <span>Continue Story</span>
                        <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </div>
                </div>
            </div>

            <!-- 4. AI å‰§æœ¬ç”Ÿæˆå™¨ -->
            <div class="break-inside-avoid relative rounded-lg border border-stone-800 overflow-hidden flex flex-col group min-h-[240px]" data-tags="all">
                <div class="absolute inset-0">
                    <img src="https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=600&auto=format&fit=crop" alt="Abstract Ink" class="w-full h-full object-cover opacity-30 grayscale transition duration-1000 group-hover:opacity-50 group-hover:grayscale-0">
                    <div class="absolute inset-0 bg-gradient-to-t from-stone-900 via-stone-900/90 to-stone-900/40"></div>
                </div>
                <div class="relative p-5 flex-1 flex flex-col justify-between">
                    <div>
                        <span class="text-[10px] text-muse-rose tracking-widest border border-muse-rose/50 px-2 py-0.5 rounded-full flex items-center w-fit backdrop-blur-sm">
                            <span class="mr-1">âœ¨</span> AI SCRIPTER
                        </span>
                        <h3 class="font-serif text-xl mt-3 text-stone-200">å¹»æƒ³å‰§æœ¬</h3>
                        <p class="text-xs text-stone-400 mt-2">è¾“å…¥å…³é”®è¯ï¼Œç”Ÿæˆä½ çš„ä¸“å±ç‹¬ç™½ã€‚</p>
                    </div>
                    
                    <div class="space-y-3 mt-4">
                        <input type="text" id="script-prompt" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”çš„å¸è¡€é¬¼..." class="w-full bg-black/40 border border-stone-700 rounded p-2 text-sm focus:border-muse-rose focus:outline-none text-stone-300 placeholder-stone-500 backdrop-blur-sm transition focus:bg-black/60">
                        <button onclick="generateScript()" id="script-btn" class="w-full bg-stone-700/80 hover:bg-muse-rose text-white text-xs py-2 rounded transition tracking-widest backdrop-blur-sm border border-stone-600 hover:border-muse-rose">
                            ç”Ÿæˆå‰§æœ¬
                        </button>
                    </div>
                </div>
                <div id="script-result" class="relative hidden p-5 bg-black/40 text-xs text-stone-300 font-serif leading-relaxed border-t border-stone-800 min-h-[80px] prose backdrop-blur-md">
                    <button onclick="speakScript()" id="speak-btn" class="hidden absolute top-2 right-2 text-muse-rose hover:text-muse-rose/80 text-xs">
                        ğŸ”Š æœ—è¯»
                    </button>
                </div>
            </div>

            <!-- 5. è§†è§‰å¡ç‰‡ï¼šè„ŠèƒŒ -->
            <div class="break-inside-avoid relative group rounded-lg overflow-hidden cursor-pointer" data-tags="all,gl">
                <img src="https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=600&auto=format&fit=crop" alt="Back" class="w-full h-auto object-cover grayscale brightness-75 group-hover:grayscale-0 group-hover:brightness-90 transition duration-700" loading="lazy" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=600&auto=format&fit=crop'">
                <div class="absolute bottom-0 left-0 right-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 z-10 pointer-events-none">
                    <p class="font-serif text-sm italic text-white">è„ŠèƒŒ</p>
                </div>
            </div>

            <!-- 6. éŸ³é¢‘å¡ç‰‡ï¼šä»Šæ™šä¸æƒ³ç¡ -->
            <div class="break-inside-avoid relative rounded-lg overflow-hidden bg-muse-panel group cursor-pointer" onclick="togglePlay(this)" data-tags="all,femdom">
                <div class="relative">
                    <img src="https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=600&auto=format&fit=crop" alt="Ambient Mood" class="w-full h-48 object-cover opacity-70 group-hover:opacity-50 transition duration-700">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="play-btn w-12 h-12 rounded-full border border-white/30 flex items-center justify-center backdrop-blur-sm transition duration-300 group-hover:bg-white/10 group-hover:scale-110">
                            <svg class="w-5 h-5 text-white ml-1 play-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="w-5 h-5 text-white hidden pause-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] tracking-widest text-stone-500 uppercase">Roleplay Â· 5:10</span>
                    </div>
                    <h3 class="font-serif text-lg leading-tight text-muse-gold">å¦‚æœä½ ä»Šæ™šä¸æƒ³ç¡...</h3>
                </div>
                <audio src="https://www.soundjay.com/nature/sounds/night-ambience-1.mp3" loop></audio> 
            </div>

            <!-- 7. æ–‡æœ¬å¡ç‰‡ï¼šå¼•è¨€ -->
            <div class="break-inside-avoid bg-stone-900 p-6 rounded-lg text-center border border-stone-800 flex flex-col justify-center items-center min-h-[160px]" data-tags="all,demisexual">
                <p class="font-serif italic text-stone-400 text-lg leading-relaxed">
                    "èº«ä½“æ˜¯è¯šå®çš„ï¼Œ<br>ä½†æƒ³è±¡åŠ›æ‰æ˜¯é«˜æ½®çš„èµ·æºã€‚"
                </p>
                <div class="w-8 h-[1px] bg-stone-700 mt-4"></div>
            </div>

            <!-- 8. è§†è§‰ï¼šæµ´å®¤æ°´æ±½ -->
            <div class="break-inside-avoid relative group rounded-lg overflow-hidden cursor-pointer" data-tags="all,gl">
                <img src="https://images.unsplash.com/photo-1515463138280-67d1dcbf3175?q=80&w=600&auto=format&fit=crop" alt="Steam" class="w-full h-64 object-cover grayscale brightness-50 group-hover:grayscale-0 transition duration-1000" loading="lazy" onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1517841905240-472988babdf9?q=80&w=600&auto=format&fit=crop'">
                <div class="absolute bottom-0 left-0 right-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 z-10 pointer-events-none">
                    <p class="font-serif text-sm italic text-white">æ°´æ±½</p>
                </div>
            </div>

            <!-- 9. éŸ³é¢‘ï¼šæ™¨é—´å’–å•¡ -->
            <div class="break-inside-avoid relative rounded-lg overflow-hidden bg-muse-panel group cursor-pointer" onclick="togglePlay(this)" data-tags="all">
                <div class="relative">
                    <img src="https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?q=80&w=600&auto=format&fit=crop" class="w-full h-40 object-cover opacity-60 group-hover:opacity-40 transition duration-700">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="play-btn w-10 h-10 rounded-full border border-white/30 flex items-center justify-center backdrop-blur-sm transition duration-300 group-hover:bg-white/10">
                            <svg class="w-4 h-4 text-white ml-1 play-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg class="w-4 h-4 text-white hidden pause-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] tracking-widest text-stone-500 uppercase">Morning Â· 2:15</span>
                    </div>
                    <h3 class="font-serif text-base leading-tight text-muse-gold">ç¬¬ä¸€å£çƒ­å’–å•¡</h3>
                </div>
                <audio src="https://www.soundjay.com/misc/sounds/restaurant-ambience-1.mp3" loop></audio>
            </div>

            <!-- 10. æ–‡æœ¬ï¼šå¾®é†º -->
            <div class="break-inside-avoid bg-stone-950 p-6 rounded-lg border border-stone-800 hover:border-muse-rose/20 transition duration-500 group" data-tags="all">
                <span class="text-[10px] text-stone-600 uppercase tracking-widest">Story Snippet</span>
                <p class="font-serif text-stone-300 mt-3 text-sm leading-7">
                    ç¬¬äºŒæ¯çº¢é…’ä¸‹è‚šåï¼Œä¸–ç•Œå˜å¾—æŸ”è½¯äº†ã€‚ä»–æ²¡æœ‰çœ‹ä½ ï¼Œåªæ˜¯æ‰‹æŒ‡è½»è½»æ•²æ‰“ç€é«˜è„šæ¯çš„æ¯å£ã€‚é‚£å£°éŸ³åƒå¿ƒè·³ä¸€æ ·ï¼Œä¸€ä¸‹ï¼Œä¸¤ä¸‹ã€‚
                </p>
                <div class="mt-4 text-[10px] text-muse-rose opacity-0 group-hover:opacity-100 transition">READ MORE</div>
            </div>

            <!-- 11. è§†è§‰ï¼šæ‰‹éƒ¨ç‰¹å†™ -->
            <div class="break-inside-avoid relative group rounded-lg overflow-hidden cursor-pointer" data-tags="all,gl">
                <img src="https://images.unsplash.com/photo-1596704017254-9b121068fb31?q=80&w=600&auto=format&fit=crop" class="w-full h-auto object-cover grayscale brightness-75 group-hover:grayscale-0 group-hover:brightness-90 transition duration-700">
                 <div class="absolute bottom-0 left-0 right-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition duration-500 z-10 pointer-events-none">
                    <p class="font-serif text-sm italic text-white">è§¦è§‰</p>
                </div>
            </div>

            <!-- 12. äº’åŠ¨æ•…äº‹ï¼šå›¾ä¹¦é¦† -->
            <div class="break-inside-avoid bg-stone-900 rounded-lg overflow-hidden border border-stone-800 hover:border-muse-rose/30 transition duration-500 cursor-pointer group" onclick="openStoryModal('library')" data-tags="all,gl">
                <div class="relative h-40 overflow-hidden">
                    <img src="https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?q=80&w=600&auto=format&fit=crop" class="w-full h-full object-cover opacity-60 group-hover:scale-105 transition duration-1000 grayscale">
                    <div class="absolute inset-0 bg-gradient-to-t from-stone-900 to-transparent"></div>
                    <span class="absolute top-3 right-3 text-[10px] bg-black/50 backdrop-blur text-muse-rose tracking-widest border border-muse-rose/50 px-2 py-0.5 rounded-full flex items-center">
                        <span class="mr-1">âœ¨</span> INTERACTIVE
                    </span>
                </div>
                <div class="p-4 relative">
                    <h3 class="font-serif text-lg mb-1 text-stone-200 group-hover:text-muse-rose transition">ç¦å¿Œå›¾ä¹¦é¦†</h3>
                    <p class="text-xs text-stone-400 leading-relaxed line-clamp-2">åœ¨è¿™æ’ä¹¦æ¶çš„æœ€æ·±å¤„ï¼Œæ²¡æœ‰äººä¼šæ¥...</p>
                </div>
            </div>

        </div>

        <div class="text-center mt-12 mb-20">
            <p class="text-stone-600 text-xs tracking-widest">More content loading...</p>
        </div>
    </main>

    <!-- 3. Waitlist Footer -->
    <footer id="join-section" class="fixed bottom-0 w-full z-40">
        <div class="h-12 bg-gradient-to-t from-muse-dark to-transparent"></div>
        <div class="bg-stone-900/90 backdrop-blur-md border-t border-stone-800 pb-8 pt-6 px-6 rounded-t-3xl shadow-2xl">
            <div class="max-w-md mx-auto text-center">
                <h2 class="font-serif text-xl text-muse-gold mb-1">Join the Private Circle</h2>
                <p class="text-xs text-stone-400 mb-5 font-light">åŒ¿åç¤¾åŒº Â· é‚€è¯·åˆ¶ Â· ä»…é™å¥³æ€§</p>
                <form class="flex gap-2 relative" onsubmit="submitForm(event)">
                    <input type="email" required placeholder="Enter your email for invite code..." 
                           class="w-full bg-stone-950 border border-stone-700 text-stone-300 text-sm rounded-lg px-4 py-3 focus:outline-none focus:border-muse-rose focus:ring-1 focus:ring-muse-rose transition placeholder-stone-600">
                    <button type="submit" 
                            class="absolute right-1 top-1 bottom-1 bg-stone-800 hover:bg-muse-rose text-stone-300 hover:text-white px-4 rounded-md text-xs tracking-widest transition duration-300 font-bold">
                        JOIN
                    </button>
                </form>
                <p id="success-msg" class="hidden text-xs text-green-400 mt-2 tracking-wide">é‚€è¯·å·²å‘é€ï¼Œè¯·ç•™æ„ä½ çš„æ”¶ä»¶ç®±ã€‚</p>
            </div>
        </div>
    </footer>

    <!-- 4. äº’åŠ¨æ•…äº‹ Modal (AI Overlay) -->
    <div id="story-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm transition-opacity" onclick="closeStoryModal()"></div>
        <div class="absolute inset-x-0 bottom-0 md:top-20 md:bottom-20 md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-[600px] bg-muse-panel md:rounded-lg shadow-2xl flex flex-col border border-stone-800 max-h-[90vh]">
            <div class="p-6 border-b border-stone-800 flex justify-between items-center bg-gradient-to-r from-stone-900 to-muse-panel">
                <div>
                    <span class="text-[10px] text-muse-rose tracking-widest uppercase">Muse AI Storyteller</span>
                    <h3 class="text-2xl font-serif text-muse-gold mt-1" id="story-title">ç§äººç”µæ¢¯</h3>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleStoryVoice()" id="voice-toggle-btn" class="text-stone-500 hover:text-muse-rose p-2" title="è¯­éŸ³å¼€å…³">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                    </button>
                    <button onclick="closeStoryModal()" class="text-stone-500 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div id="story-content" class="flex-1 overflow-y-auto p-6 space-y-6 text-stone-300 font-serif leading-relaxed text-lg no-scrollbar">
                <!-- å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="p-4 bg-stone-900 border-t border-stone-800">
                <div class="relative">
                    <input type="text" id="story-input" placeholder="è¾“å…¥ä½ çš„åŠ¨ä½œæˆ–å›åº” (ä¾‹å¦‚: æˆ‘å‘ä»–è¿ˆè¿‘ä¸€æ­¥...)" 
                           class="w-full bg-black/50 border border-stone-700 rounded-lg pl-4 pr-12 py-3 text-sm focus:border-muse-rose focus:ring-1 focus:ring-muse-rose focus:outline-none text-stone-200"
                           onkeypress="if(event.key==='Enter') continueStory()">
                    <button onclick="continueStory()" id="story-send-btn" class="absolute right-2 top-2 p-1.5 bg-stone-700 rounded hover:bg-muse-rose text-white transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </div>
                <p class="text-[10px] text-stone-600 mt-2 text-center">AI generated content. Explore responsibly.</p>
            </div>
        </div>
    </div>

    <!-- 5. æ ‘æ´ä¿¡ç®±æ¨¡æ€æ¡† (The Sanctuary) -->
    <div id="sanctuary-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeSanctuary()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-muse-panel border border-stone-800 rounded-lg max-w-2xl w-full my-8 fade-in">
                <!-- å†™ä¿¡ç•Œé¢ -->
                <div id="sanctuary-write" class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-serif text-2xl text-muse-gold">The Sanctuary</h2>
                        <button onclick="closeSanctuary()" class="text-stone-500 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <p class="text-sm text-stone-400 mb-6">å†™ä¸‹ä½ çš„å¿ƒæƒ…ï¼Œè®©å®ƒæ¼‚æµåˆ°å¦ä¸€ä¸ªäººçš„ä¿¡ç®±</p>
                    <textarea id="sanctuary-text" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³è¯´çš„è¯..." 
                              class="w-full bg-black/40 border border-stone-700 rounded-lg p-4 text-stone-300 font-serif min-h-[300px] focus:border-muse-rose focus:outline-none resize-none placeholder-stone-600 leading-relaxed"></textarea>
                    <div class="flex gap-3 mt-4">
                        <button onclick="sendSanctuaryLetter()" class="flex-1 bg-muse-rose hover:bg-muse-rose/80 text-white py-3 rounded-lg transition">
                            æŠ•é€’
                        </button>
                        <button onclick="pickSanctuaryLetter()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-stone-300 py-3 rounded-lg transition border border-stone-700">
                            æ‹¾å–ä¸€å°ä¿¡
                        </button>
                    </div>
                </div>
                <!-- è¯»ä¿¡ç•Œé¢ -->
                <div id="sanctuary-read" class="hidden p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-serif text-2xl text-muse-gold">ä¸€å°ä¿¡</h2>
                        <button onclick="closeSanctuaryRead()" class="text-stone-500 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                    <div id="sanctuary-letter-content" class="bg-black/20 border border-stone-800 rounded-lg p-6 font-serif text-stone-300 leading-relaxed min-h-[200px]">
                        <!-- ä¿¡ä»¶å†…å®¹ -->
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="replySanctuaryLetter()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-stone-300 py-3 rounded-lg transition border border-stone-700">
                            å†™å›ä¿¡
                        </button>
                        <button onclick="pickSanctuaryLetter()" class="flex-1 bg-muse-rose/20 hover:bg-muse-rose/30 text-muse-rose py-3 rounded-lg transition border border-muse-rose/50">
                            ä¸‹ä¸€å°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. AI ä¼´ä¾£æ¨¡æ€æ¡† (The Companion) -->
    <div id="companion-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeCompanion()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-stone-800 rounded-lg max-w-2xl w-full h-[80vh] flex flex-col fade-in">
                <div class="p-6 border-b border-stone-800 flex justify-between items-center">
                    <div>
                        <h2 class="font-serif text-2xl text-muse-gold">The Companion</h2>
                        <p class="text-xs text-stone-400 mt-1">AI ä¼´ä¾£ Â· æœ‰è®°å¿†çš„å¯¹è¯</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openVoiceSettings()" class="text-stone-500 hover:text-muse-rose p-2" title="å£°çº¿è®¾ç½®">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <button onclick="closeCompanion()" class="text-stone-500 hover:text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="companion-chat" class="flex-1 overflow-y-auto p-6 space-y-4 no-scrollbar">
                    <div class="text-center text-stone-500 text-sm mb-4">
                        <p>å¼€å§‹ä¸ä½ çš„ AI ä¼´ä¾£å¯¹è¯</p>
                    </div>
                </div>
                <div class="p-4 bg-stone-900 border-t border-stone-800">
                    <div class="relative">
                        <input type="text" id="companion-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." 
                               class="w-full bg-black/50 border border-stone-700 rounded-lg pl-4 pr-12 py-3 text-sm focus:border-muse-rose focus:ring-1 focus:ring-muse-rose focus:outline-none text-stone-200"
                               onkeypress="if(event.key==='Enter') sendCompanionMessage()">
                        <button onclick="sendCompanionMessage()" class="absolute right-2 top-2 p-1.5 bg-stone-700 rounded hover:bg-muse-rose text-white transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. å£°çº¿è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="voice-settings-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/80" onclick="closeVoiceSettings()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-stone-800 rounded-lg max-w-md w-full p-8 fade-in">
                <h3 class="font-serif text-xl text-muse-gold mb-6">å£°çº¿è®¾ç½®</h3>
                <div class="space-y-4">
                    <label class="block">
                        <input type="radio" name="voice-type" value="deep-sister" class="mr-3" onchange="updateVoiceSettings()">
                        <span class="text-stone-300">Deep Sister (ä½éŸ³/æ…¢é€Ÿ)</span>
                    </label>
                    <label class="block">
                        <input type="radio" name="voice-type" value="cool-maiden" class="mr-3" checked class="mr-3" onchange="updateVoiceSettings()">
                        <span class="text-stone-300">Cool Maiden (é«˜éŸ³/å¸¸é€Ÿ)</span>
                    </label>
                    <label class="block">
                        <input type="radio" name="voice-type" value="gentle-uncle" class="mr-3" onchange="updateVoiceSettings()">
                        <span class="text-stone-300">Gentle Uncle (ä½éŸ³/ä¸­é€Ÿ)</span>
                    </label>
                </div>
                <button onclick="closeVoiceSettings()" class="mt-6 w-full bg-muse-rose hover:bg-muse-rose/80 text-white py-3 rounded-lg transition">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>

    <!-- 8. å¤šå…ƒæ¬²æœ›æ¿å—è®¾ç½® (The Spectrum) -->
    <div id="spectrum-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeSpectrumSettings()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-stone-800 rounded-lg max-w-md w-full p-8 fade-in">
                <h3 class="font-serif text-2xl text-muse-gold mb-2">The Spectrum</h3>
                <p class="text-sm text-stone-400 mb-6">é€‰æ‹©ä½ çš„åå¥½ï¼Œæˆ‘ä»¬å°†ä¸ºä½ å®šåˆ¶å†…å®¹</p>
                <div class="space-y-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" value="gl" class="mr-3 w-5 h-5 text-muse-rose focus:ring-muse-rose" onchange="updateSpectrumFilter()">
                        <span class="text-stone-300">GL / Lesbian (å¥³æ€§åŒæ€§æ‹)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" value="femdom" class="mr-3 w-5 h-5 text-muse-rose focus:ring-muse-rose" onchange="updateSpectrumFilter()">
                        <span class="text-stone-300">Femdom / Fourth Love (å››çˆ±)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" value="demisexual" class="mr-3 w-5 h-5 text-muse-rose focus:ring-muse-rose" onchange="updateSpectrumFilter()">
                        <span class="text-stone-300">Demisexual (æ™ºæ€§/æƒ…æ„Ÿå‘)</span>
                    </label>
                </div>
                <button onclick="closeSpectrumSettings()" class="mt-6 w-full bg-muse-rose hover:bg-muse-rose/80 text-white py-3 rounded-lg transition">
                    åº”ç”¨
                </button>
            </div>
        </div>
    </div>

    <!-- 9. API Key é…ç½®æ¨¡æ€æ¡† -->
    <div id="apikey-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-sm"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-muse-panel border border-muse-rose/30 rounded-lg max-w-lg w-full p-8 fade-in">
                <h3 class="font-serif text-2xl text-muse-gold mb-2">é…ç½® Gemini API Key</h3>
                <p class="text-sm text-stone-400 mb-4">ä¸ºäº†ä½¿ç”¨ AI åŠŸèƒ½ï¼Œè¯·é…ç½®ä½ çš„ Gemini API Key</p>
                <div class="mb-4">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-muse-rose hover:text-muse-rose/80 text-sm underline">
                        ç‚¹å‡»è¿™é‡Œè·å– API Key â†’
                    </a>
                </div>
                <div class="mb-6">
                    <input type="password" id="apikey-input" placeholder="ç²˜è´´ä½ çš„ Gemini API Key" 
                           class="w-full bg-black/40 border border-stone-700 rounded-lg p-3 text-stone-300 focus:border-muse-rose focus:outline-none focus:ring-1 focus:ring-muse-rose placeholder-stone-600"
                           onkeypress="if(event.key==='Enter') saveApiKey()">
                    <p class="text-xs text-stone-500 mt-2">API Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveApiKey()" class="flex-1 bg-muse-rose hover:bg-muse-rose/80 text-white py-3 rounded-lg transition">
                        ä¿å­˜
                    </button>
                    <button onclick="skipApiKey()" class="flex-1 bg-stone-800 hover:bg-stone-700 text-stone-300 py-3 rounded-lg transition border border-stone-700">
                        ç¨åé…ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== API Key ç®¡ç† ==========
        function getApiKey() {
            return localStorage.getItem('muse_gemini_apikey') || '';
        }

        function saveApiKey() {
            const input = document.getElementById('apikey-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('muse_gemini_apikey', key);
                document.getElementById('apikey-modal').classList.add('hidden');
                // å¦‚æœç”¨æˆ·æ­£åœ¨å°è¯•ä½¿ç”¨ AI åŠŸèƒ½ï¼Œæç¤ºå¯ä»¥é‡è¯•
                if (window.pendingAiAction) {
                    window.pendingAiAction();
                    window.pendingAiAction = null;
                }
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
            }
        }

        function skipApiKey() {
            localStorage.setItem('muse_apikey_skipped', 'true');
            document.getElementById('apikey-modal').classList.add('hidden');
        }

        function checkApiKey() {
            return !!getApiKey();
        }

        function showApiKeyPrompt(callback) {
            const apiKey = getApiKey();
            if (!apiKey) {
                window.pendingAiAction = callback;
                document.getElementById('apikey-modal').classList.remove('hidden');
                document.getElementById('apikey-input').focus();
                return false;
            }
            return true;
        }

        function openApiKeySettings() {
            const apiKey = getApiKey();
            document.getElementById('apikey-input').value = apiKey || '';
            document.getElementById('apikey-modal').classList.remove('hidden');
            document.getElementById('apikey-input').focus();
        }
        
        // ========== å‡†å…¥ç³»ç»Ÿ ==========
        const gateQuestions = [
            {
                q: "åœ¨äº²å¯†å…³ç³»ä¸­ï¼Œä½ æ›´æ¸´æœ›ï¼š",
                options: [
                    { text: "è¢«å¾æœ", score: 0 },
                    { text: "è¢«çœ‹è§", score: 1 },
                    { text: "ç›¸äº’æ¢ç´¢", score: 1 }
                ]
            },
            {
                q: "ä»€ä¹ˆæ ·çš„åœºæ™¯æœ€èƒ½æ¿€å‘ä½ çš„æƒ³è±¡ï¼Ÿ",
                options: [
                    { text: "ç›´ç™½çš„è§†è§‰åˆºæ¿€", score: 0 },
                    { text: "æ°›å›´ä¸å¼ åŠ›", score: 1 },
                    { text: "æ–‡å­—ä¸å¯¹è¯", score: 1 }
                ]
            },
            {
                q: "ä½ å¦‚ä½•çœ‹å¾…æ¬²æœ›ï¼Ÿ",
                options: [
                    { text: "éœ€è¦éšè—çš„ç¾è€»", score: 0 },
                    { text: "è‡ªç„¶çš„ç”Ÿå‘½åŠ›", score: 1 },
                    { text: "è‰ºæœ¯ä¸ç¾", score: 1 }
                ]
            }
        ];

        const personaNames = [
            "å‘¨äºŒçš„ç™¾åˆ", "é›¨å¤œçš„å¾®å…‰", "æ²‰é»˜çš„è¯—", "è¿·é€”çš„é¹¿", 
            "åˆåçš„é˜´å½±", "æ™¨é—´çš„éœ²ç ", "å¤œåŠçš„é’Ÿå£°", "æ·±æµ·çš„çç ",
            "é£ä¸­çš„ç¾½æ¯›", "ä¹¦é¡µçš„å¢¨é¦™"
        ];

        const personaSymbols = ["âœ¨", "ğŸŒ™", "ğŸŒ¹", "ğŸ¦Œ", "ğŸ“–", "ğŸ’«", "ğŸ•¯ï¸", "ğŸŒŠ", "ğŸ·", "ğŸ­"];

        function initGate() {
            const questionsDiv = document.getElementById('gate-questions');
            let currentQ = 0;
            let totalScore = 0;

            function showQuestion(index) {
                if (index >= gateQuestions.length) {
                    // å®Œæˆæ‰€æœ‰é—®é¢˜
                    const resultDiv = document.getElementById('gate-result');
                    const questionsDiv = document.getElementById('gate-questions');
                    questionsDiv.classList.add('hidden');
                    resultDiv.classList.remove('hidden');
                    
                    if (totalScore >= 2) {
                        document.getElementById('gate-result-text').textContent = "ä½ é€šè¿‡äº†å…±é¸£æµ‹è¯•";
                    } else {
                        document.getElementById('gate-result-text').textContent = "æ„Ÿè°¢ä½ çš„å‚ä¸";
                    }
                    return;
                }

                const q = gateQuestions[index];
                questionsDiv.innerHTML = `
                    <div class="fade-in">
                        <p class="font-serif text-lg text-muse-gold mb-6">${q.q}</p>
                        <div class="space-y-3">
                            ${q.options.map((opt, i) => `
                                <button onclick="selectGateOption(${index}, ${i}, ${opt.score})" 
                                        class="w-full text-left p-4 bg-stone-800 hover:bg-stone-700 border border-stone-700 hover:border-muse-rose/50 rounded-lg transition">
                                    ${opt.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            window.selectGateOption = function(qIndex, optIndex, score) {
                totalScore += score;
                showQuestion(qIndex + 1);
            };

            showQuestion(0);
        }

        function proceedToMasquerade() {
            if (localStorage.getItem('muse_persona')) {
                // å·²æœ‰èº«ä»½ï¼Œç›´æ¥è¿›å…¥
                enterGallery();
                return;
            }

            document.getElementById('gate-modal').classList.add('hidden');
            const persona = generatePersona();
            document.getElementById('persona-name').textContent = persona.name;
            document.getElementById('persona-symbol').textContent = persona.symbol;
            document.getElementById('masquerade-modal').classList.remove('hidden');
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('muse_persona', JSON.stringify(persona));
            localStorage.setItem('muse_gate_passed', 'true');
        }

        function generatePersona() {
            const nameIndex = Math.floor(Math.random() * personaNames.length);
            return {
                name: personaNames[nameIndex],
                symbol: personaSymbols[nameIndex]
            };
        }

        function enterGallery() {
            document.getElementById('masquerade-modal').classList.add('hidden');
            document.getElementById('gate-modal').classList.add('hidden');
            // ä¸»ç”»å»Šå·²æ˜¾ç¤º
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå‡†å…¥æµ‹è¯•
        window.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('muse_gate_passed')) {
                document.getElementById('gate-modal').classList.remove('hidden');
                initGate();
            }
        });

        // ========== éŸ³é¢‘æ’­æ”¾é€»è¾‘ ==========
        function togglePlay(element) {
            const playIcon = element.querySelector('.play-icon');
            const pauseIcon = element.querySelector('.pause-icon');
            const playBtn = element.querySelector('.play-btn');
            const audio = element.querySelector('audio');

            const isPlaying = playIcon.classList.contains('hidden');

            // é‡ç½®å…¶ä»–æ’­æ”¾å™¨
            document.querySelectorAll('audio').forEach(a => {
                if (a !== audio) {
                    a.pause();
                    a.currentTime = 0;
                }
            });
            document.querySelectorAll('.pause-icon').forEach(icon => icon.classList.add('hidden'));
            document.querySelectorAll('.play-icon').forEach(icon => icon.classList.remove('hidden'));
            document.querySelectorAll('.play-btn').forEach(btn => btn.classList.remove('playing-animation', 'border-muse-rose', 'bg-white/10'));

            if (!isPlaying) {
                audio.play().then(() => {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    playBtn.classList.add('playing-animation', 'border-muse-rose', 'bg-white/10');
                }).catch(e => {
                    console.error("Playback failed:", e);
                });
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playBtn.classList.remove('playing-animation', 'border-muse-rose', 'bg-white/10');
            }
        }

        // ========== Gemini API ==========
        async function callGemini(prompt, systemInstruction = "", useHistory = false) {
            const apiKey = getApiKey();
            if (!apiKey) {
                return "è¯·é…ç½® Gemini API Key";
            }

            let contents = [{ parts: [{ text: prompt }] }];
            
            // å¦‚æœä½¿ç”¨å†å²è®°å½•ï¼ˆç”¨äº Companionï¼‰
            if (useHistory) {
                const history = getCompanionHistory();
                if (history.length > 0) {
                    contents = history.slice(-5).concat(contents); // åªå–æœ€å5æ¡
                }
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Muse æ­£åœ¨ä¼‘æ¯...";
            } catch (error) {
                console.error("API Error:", error);
                return "è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚";
            }
        }

        // ========== AI å‰§æœ¬ç”Ÿæˆ ==========
        async function generateScript() {
            if (!showApiKeyPrompt(generateScript)) return;
            
            const input = document.getElementById('script-prompt');
            const resultDiv = document.getElementById('script-result');
            const btn = document.getElementById('script-btn');
            
            if (!input.value.trim()) return;

            const originalBtnText = btn.innerText;
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<span class="animate-pulse">Muse æ­£åœ¨ç¼–ç»‡æ¢¦å¢ƒ...</span>';

            const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªå¥³æ€§å‘æƒ…è‰²æ–‡å­¦åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„å…³é”®è¯ï¼Œå†™ä¸€æ®µç®€çŸ­çš„ã€å……æ»¡å¼ åŠ›ã€æ„Ÿå®˜æå†™ä¸°å¯Œï¼ˆå£°éŸ³ã€æ°”å‘³ã€è§¦è§‰ï¼‰çš„ç‹¬ç™½æˆ–åœºæ™¯æè¿°ã€‚é£æ ¼è¦å”¯ç¾ã€å«è“„ã€æ³¨é‡æ°›å›´æ„Ÿï¼Œé¿å…è¿‡äºç›´ç™½çš„å™¨å®˜æå†™ã€‚å­—æ•°æ§åˆ¶åœ¨100å­—ä»¥å†…ã€‚ç”¨ä¸­æ–‡å›ç­”ã€‚";
            const aiResponse = await callGemini(input.value, systemPrompt);

            resultDiv.innerHTML = marked.parse(aiResponse);
            const speakBtn = document.getElementById('speak-btn');
            speakBtn.classList.remove('hidden');
            speakBtn.onclick = () => speakScript();
            
            btn.innerText = originalBtnText;
            btn.disabled = false;
        }

        function speakScript() {
            const resultDiv = document.getElementById('script-result');
            const text = resultDiv.innerText || resultDiv.textContent;
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ========== äº’åŠ¨æ•…äº‹ ==========
        let currentStoryContext = "";
        let storyVoiceEnabled = false;

        function openStoryModal(storyType = 'elevator') {
            const modal = document.getElementById('story-modal');
            const contentDiv = document.getElementById('story-content');
            const titleDiv = document.getElementById('story-title');
            
            if (storyType === 'elevator') {
                titleDiv.textContent = "ç§äººç”µæ¢¯";
                currentStoryContext = "ç”µæ¢¯æ•…éšœåœåœ¨äº†22å±‚ã€‚ç¯å…‰é—ªçƒï¼Œåªæœ‰ä½ å’Œä»–ä¸¤ä¸ªäººã€‚";
                contentDiv.innerHTML = `
                    <p>ç”µæ¢¯çŒ›åœ°æ™ƒåŠ¨äº†ä¸€ä¸‹ï¼Œçº¢è‰²çš„æ•…éšœç¯åœ¨å¤´é¡¶é—ªçƒï¼Œå‘å‡ºå¾®å¼±çš„æ»‹æ»‹å£°ã€‚ç‹­å°çš„ç©ºé—´é‡Œï¼ŒåŸæœ¬ç¤¼è²Œçš„ç¤¾äº¤è·ç¦»ç¬é—´è¢«å‹ç¼©äº†ã€‚</p>
                    <p>ä½ é—»åˆ°äº†ä»–èº«ä¸Šæ·¡æ·¡çš„æœ¨è´¨é¦™æ°´å‘³ï¼Œæ··æ‚ç€å¤–é¢é›¨å¤œçš„æ½®æ¹¿æ°”æ¯ã€‚ä»–æ¾å¼€äº†é¢†å¸¦ï¼Œè½¬è¿‡èº«çœ‹ç€ä½ ï¼Œçœ¼ç¥æ·±é‚ƒå¾—åƒæ²¡æœ‰å°½å¤´çš„èµ°å»Šã€‚</p>
                    <p>"çœ‹æ¥æˆ‘ä»¬è¦åœ¨è¿™é‡Œå¾…ä¸€ä¼šå„¿äº†ã€‚"ä»–çš„å£°éŸ³å¾ˆä½ï¼Œå¸¦ç€ä¸€ä¸ä¸æ˜“å¯Ÿè§‰çš„æ²™å“‘ã€‚</p>
                `;
            } else if (storyType === 'library') {
                titleDiv.textContent = "ç¦å¿Œå›¾ä¹¦é¦†";
                currentStoryContext = "åœ¨è¿™æ’ä¹¦æ¶çš„æœ€æ·±å¤„ï¼Œæ²¡æœ‰äººä¼šæ¥ã€‚";
                contentDiv.innerHTML = `
                    <p>å›¾ä¹¦é¦†çš„é—­é¦†éŸ³ä¹å·²ç»å“èµ·ï¼Œä½†ä½ è¿˜åœ¨é‚£æ’æœ€æ·±çš„ä¹¦æ¶å‰ã€‚å¥¹ä¹Ÿåœ¨é‚£é‡Œï¼Œæ‰‹æŒ‡è½»æŠšè¿‡ä¹¦è„Šï¼Œåƒæ˜¯åœ¨å¯»æ‰¾ä»€ä¹ˆã€‚</p>
                    <p>ä½ ä»¬çš„ç›®å…‰åœ¨ä¹¦æ¶çš„ç¼éš™ä¸­ç›¸é‡ã€‚å¥¹çš„å˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼Œåƒæ˜¯å‘ç°äº†ä»€ä¹ˆç§˜å¯†ã€‚</p>
                    <p>"ä½ ä¹Ÿå–œæ¬¢è¿™æœ¬ä¹¦ï¼Ÿ"å¥¹çš„å£°éŸ³å¾ˆè½»ï¼Œåƒæ˜¯æ€•æ‰“ç ´è¿™å®‰é™çš„æ°›å›´ã€‚</p>
                `;
            }
            
            modal.classList.remove('hidden');
            document.getElementById('story-input').focus();
        }

        function closeStoryModal() {
            document.getElementById('story-modal').classList.add('hidden');
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }

        function toggleStoryVoice() {
            storyVoiceEnabled = !storyVoiceEnabled;
            const btn = document.getElementById('voice-toggle-btn');
            btn.classList.toggle('text-muse-rose', storyVoiceEnabled);
            btn.classList.toggle('text-stone-500', !storyVoiceEnabled);
        }

        async function continueStory() {
            if (!showApiKeyPrompt(continueStory)) return;
            
            const input = document.getElementById('story-input');
            const contentDiv = document.getElementById('story-content');
            
            if (!input.value.trim()) return;

            const userAction = input.value;
            input.value = '';

            const userP = document.createElement('p');
            userP.className = "text-muse-rose italic text-sm border-l-2 border-muse-rose pl-3 opacity-80";
            userP.innerText = `> ${userAction}`;
            contentDiv.appendChild(userP);
            contentDiv.scrollTop = contentDiv.scrollHeight;

            const loadingP = document.createElement('p');
            loadingP.className = "text-stone-500 animate-pulse text-sm";
            loadingP.id = "story-loading";
            loadingP.innerText = "æ­£åœ¨ç»­å†™...";
            contentDiv.appendChild(loadingP);
            contentDiv.scrollTop = contentDiv.scrollHeight;

            const fullPrompt = `æ•…äº‹èƒŒæ™¯: ${currentStoryContext}\nç”¨æˆ·åŠ¨ä½œ: "${userAction}"\nä»»åŠ¡: ç»­å†™2-3æ®µå‰§æƒ…ï¼Œä¾§é‡å¿ƒç†æå†™å’Œæ„Ÿå®˜å¼ åŠ›ã€‚ç”¨ä¸­æ–‡ã€‚`;
            const systemPrompt = "ä½ æ˜¯ Muse å¹³å°çš„ AI ä½œè€…ã€‚å†™ä½œé£æ ¼ï¼šå”¯ç¾ã€å«è“„ã€æ…¢çƒ­ã€æ³¨é‡æ°›å›´æ„Ÿã€‚ç”¨ä¸­æ–‡å›ç­”ã€‚";

            const aiResponse = await callGemini(fullPrompt, systemPrompt);
            currentStoryContext += `\n${userAction}\n${aiResponse}`;

            document.getElementById('story-loading').remove();
            const aiDiv = document.createElement('div');
            aiDiv.innerHTML = marked.parse(aiResponse);
            contentDiv.appendChild(aiDiv);
            contentDiv.scrollTop = contentDiv.scrollHeight;

            // å¦‚æœå¯ç”¨äº†è¯­éŸ³ï¼Œæœ—è¯» AI å›å¤
            if (storyVoiceEnabled && window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(aiResponse.replace(/[#*`]/g, ''));
                utterance.lang = 'zh-CN';
                utterance.rate = 0.85;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ========== æ ‘æ´ä¿¡ç®± ==========
        const sanctuaryLetters = [
            "ä»Šå¤©ä¸‹äº†ä¸€åœºé›¨ï¼Œæˆ‘æƒ³èµ·äº†é‚£ä¸ªåœ¨å’–å•¡åº—é‡åˆ°çš„é™Œç”Ÿäººã€‚æˆ‘ä»¬æ²¡æœ‰è¯´è¯ï¼Œåªæ˜¯çœ¼ç¥äº¤æ±‡äº†å‡ ç§’ï¼Œä½†é‚£ç§æ„Ÿè§‰...åƒæ˜¯è¢«ä»€ä¹ˆå‡»ä¸­äº†ã€‚",
            "æœ‰æ—¶å€™æˆ‘è§‰å¾—è‡ªå·±å¾ˆçŸ›ç›¾ã€‚æ¸´æœ›äº²å¯†ï¼Œåˆå®³æ€•è¢«çœ‹ç©¿ã€‚æƒ³è¦è¢«ç†è§£ï¼Œåˆä¸æƒ³æš´éœ²å¤ªå¤šã€‚",
            "æ˜¨æ™šåšäº†ä¸€ä¸ªæ¢¦ï¼Œæ¢¦é‡Œæœ‰ä¸€ä¸ªäººï¼Œæˆ‘çœ‹ä¸æ¸…è„¸ï¼Œä½†èƒ½æ„Ÿå—åˆ°æ¸©åº¦ã€‚é†’æ¥åï¼Œé‚£ç§æ¸©æš–è¿˜åœ¨ã€‚",
            "æˆ‘ä¸€ç›´åœ¨æƒ³ï¼Œä»€ä¹ˆæ˜¯çœŸæ­£çš„æ¬²æœ›ï¼Ÿæ˜¯èº«ä½“çš„ååº”ï¼Œè¿˜æ˜¯å¿ƒé‡Œçš„é‚£ç§æ‚¸åŠ¨ï¼Ÿ",
            "ä»Šå¤©è¯»äº†ä¸€é¦–è¯—ï¼Œé‡Œé¢æœ‰ä¸€å¥ï¼š'èº«ä½“æ˜¯è¯šå®çš„ï¼Œä½†æƒ³è±¡åŠ›æ‰æ˜¯é«˜æ½®çš„èµ·æºã€‚' æ·±ä»¥ä¸ºç„¶ã€‚"
        ];

        function openSanctuary() {
            document.getElementById('sanctuary-modal').classList.remove('hidden');
            document.getElementById('sanctuary-write').classList.remove('hidden');
            document.getElementById('sanctuary-read').classList.add('hidden');
        }

        function closeSanctuary() {
            document.getElementById('sanctuary-modal').classList.add('hidden');
        }

        function sendSanctuaryLetter() {
            const text = document.getElementById('sanctuary-text').value.trim();
            if (!text) return;

            // ç®€å•çš„å†…å®¹å®¡æ ¸
            const forbiddenWords = ['æš´åŠ›', 'è¡€è…¥', 'è¾±éª‚', 'æ”»å‡»'];
            if (forbiddenWords.some(word => text.includes(word))) {
                alert('è¯·ä¿æŒç¤¾åŒºæ¸©æš–ä¸å®‰å…¨');
                return;
            }

            // æ¨¡æ‹ŸæŠ•é€’åŠ¨ç”»
            const btn = event.target;
            btn.textContent = 'æŠ•é€’ä¸­...';
            btn.disabled = true;
            
            setTimeout(() => {
                alert('ä½ çš„ä¿¡ä»¶å·²æŠ•é€’');
                document.getElementById('sanctuary-text').value = '';
                btn.textContent = 'æŠ•é€’';
                btn.disabled = false;
                
                // ä¿å­˜åˆ° localStorage
                const letters = JSON.parse(localStorage.getItem('muse_sanctuary_letters') || '[]');
                letters.push({ text, timestamp: Date.now() });
                localStorage.setItem('muse_sanctuary_letters', JSON.stringify(letters));
            }, 1000);
        }

        function pickSanctuaryLetter() {
            const letters = JSON.parse(localStorage.getItem('muse_sanctuary_letters') || '[]');
            const allLetters = [...sanctuaryLetters, ...letters.map(l => l.text)];
            
            if (allLetters.length === 0) {
                alert('æš‚æ—¶æ²¡æœ‰ä¿¡ä»¶');
                return;
            }

            const randomLetter = allLetters[Math.floor(Math.random() * allLetters.length)];
            document.getElementById('sanctuary-letter-content').textContent = randomLetter;
            document.getElementById('sanctuary-write').classList.add('hidden');
            document.getElementById('sanctuary-read').classList.remove('hidden');
        }

        function closeSanctuaryRead() {
            document.getElementById('sanctuary-read').classList.add('hidden');
            document.getElementById('sanctuary-write').classList.remove('hidden');
        }

        function replySanctuaryLetter() {
            alert('å›ä¿¡å°†ç›´æ¥å‘é€åˆ°å¯¹æ–¹ä¿¡ç®±ï¼Œä¸ä¼šå…¬å¼€å±•ç¤º');
            closeSanctuaryRead();
        }

        // ========== AI ä¼´ä¾£ ==========
        function openCompanion() {
            document.getElementById('companion-modal').classList.remove('hidden');
            loadCompanionHistory();
        }

        function closeCompanion() {
            document.getElementById('companion-modal').classList.add('hidden');
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }

        function getCompanionHistory() {
            const history = JSON.parse(localStorage.getItem('muse_companion_history') || '[]');
            return history.map(item => ({
                parts: [{ text: item.role === 'user' ? item.text : item.text }]
            }));
        }

        function saveCompanionMessage(role, text) {
            const history = JSON.parse(localStorage.getItem('muse_companion_history') || '[]');
            history.push({ role, text, timestamp: Date.now() });
            // åªä¿ç•™æœ€å20æ¡
            if (history.length > 20) {
                history.shift();
            }
            localStorage.setItem('muse_companion_history', JSON.stringify(history));
        }

        function loadCompanionHistory() {
            const chatDiv = document.getElementById('companion-chat');
            const history = JSON.parse(localStorage.getItem('muse_companion_history') || '[]');
            
            chatDiv.innerHTML = '';
            if (history.length === 0) {
                chatDiv.innerHTML = '<div class="text-center text-stone-500 text-sm mb-4"><p>å¼€å§‹ä¸ä½ çš„ AI ä¼´ä¾£å¯¹è¯</p></div>';
                return;
            }

            history.forEach(item => {
                const msgDiv = document.createElement('div');
                msgDiv.className = item.role === 'user' 
                    ? 'text-right' 
                    : 'text-left';
                const bubble = document.createElement('div');
                bubble.className = item.role === 'user'
                    ? 'inline-block bg-muse-rose/20 text-stone-300 px-4 py-2 rounded-lg max-w-[80%]'
                    : 'inline-block bg-stone-800 text-stone-300 px-4 py-2 rounded-lg max-w-[80%]';
                bubble.textContent = item.text;
                msgDiv.appendChild(bubble);
                chatDiv.appendChild(msgDiv);
            });
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        async function sendCompanionMessage() {
            if (!showApiKeyPrompt(sendCompanionMessage)) return;
            
            const input = document.getElementById('companion-input');
            const chatDiv = document.getElementById('companion-chat');
            
            if (!input.value.trim()) return;

            const userMessage = input.value;
            input.value = '';

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            const userDiv = document.createElement('div');
            userDiv.className = 'text-right';
            const userBubble = document.createElement('div');
            userBubble.className = 'inline-block bg-muse-rose/20 text-stone-300 px-4 py-2 rounded-lg max-w-[80%]';
            userBubble.textContent = userMessage;
            userDiv.appendChild(userBubble);
            chatDiv.appendChild(userDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            saveCompanionMessage('user', userMessage);

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-left';
            loadingDiv.id = 'companion-loading';
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'inline-block bg-stone-800 text-stone-500 px-4 py-2 rounded-lg';
            loadingBubble.innerHTML = '<span class="animate-pulse">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</span>';
            loadingDiv.appendChild(loadingBubble);
            chatDiv.appendChild(loadingDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            const systemPrompt = "ä½ æ˜¯ Muse å¹³å°çš„ AI ä¼´ä¾£ã€‚é£æ ¼ï¼šæ¸©æŸ”ã€ç†è§£ã€æœ‰æ·±åº¦ã€‚ç”¨ä¸­æ–‡å›ç­”ã€‚";
            const aiResponse = await callGemini(userMessage, systemPrompt, true);

            document.getElementById('companion-loading').remove();
            saveCompanionMessage('assistant', aiResponse);

            const aiDiv = document.createElement('div');
            aiDiv.className = 'text-left';
            const aiBubble = document.createElement('div');
            aiBubble.className = 'inline-block bg-stone-800 text-stone-300 px-4 py-2 rounded-lg max-w-[80%]';
            aiBubble.textContent = aiResponse;
            aiDiv.appendChild(aiBubble);
            chatDiv.appendChild(aiDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            // è¯­éŸ³æ’­æ”¾
            if (window.speechSynthesis) {
                const voiceSettings = JSON.parse(localStorage.getItem('muse_voice_settings') || '{"type":"cool-maiden"}');
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(aiResponse);
                utterance.lang = 'zh-CN';
                
                if (voiceSettings.type === 'deep-sister') {
                    utterance.rate = 0.75;
                    utterance.pitch = 0.8;
                } else if (voiceSettings.type === 'cool-maiden') {
                    utterance.rate = 1.0;
                    utterance.pitch = 1.2;
                } else if (voiceSettings.type === 'gentle-uncle') {
                    utterance.rate = 0.9;
                    utterance.pitch = 0.9;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // ========== å£°çº¿è®¾ç½® ==========
        function openVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.remove('hidden');
            const settings = JSON.parse(localStorage.getItem('muse_voice_settings') || '{"type":"cool-maiden"}');
            document.querySelector(`input[value="${settings.type}"]`).checked = true;
        }

        function closeVoiceSettings() {
            document.getElementById('voice-settings-modal').classList.add('hidden');
        }

        function updateVoiceSettings() {
            const selected = document.querySelector('input[name="voice-type"]:checked').value;
            localStorage.setItem('muse_voice_settings', JSON.stringify({ type: selected }));
        }

        // ========== å¤šå…ƒæ¬²æœ›æ¿å— ==========
        function openSpectrumSettings() {
            document.getElementById('spectrum-modal').classList.remove('hidden');
            const preferences = JSON.parse(localStorage.getItem('muse_spectrum_prefs') || '[]');
            preferences.forEach(pref => {
                const checkbox = document.querySelector(`#spectrum-modal input[value="${pref}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }

        function closeSpectrumSettings() {
            document.getElementById('spectrum-modal').classList.add('hidden');
            updateSpectrumFilter();
        }

        function updateSpectrumFilter() {
            const checked = Array.from(document.querySelectorAll('#spectrum-modal input:checked')).map(cb => cb.value);
            localStorage.setItem('muse_spectrum_prefs', JSON.stringify(checked));
            
            // åº”ç”¨è¿‡æ»¤
            const cards = document.querySelectorAll('#gallery-grid > div');
            if (checked.length === 0) {
                cards.forEach(card => card.style.display = '');
                return;
            }

            cards.forEach(card => {
                const tags = card.getAttribute('data-tags') || 'all';
                const tagArray = tags.split(',');
                const shouldShow = checked.some(pref => tagArray.includes(pref)) || tagArray.includes('all');
                card.style.display = shouldShow ? '' : 'none';
            });
        }

        function filterContent(type) {
            const cards = document.querySelectorAll('#gallery-grid > div');
            cards.forEach(card => {
                if (type === 'all') {
                    card.style.display = '';
                } else {
                    const tags = card.getAttribute('data-tags') || '';
                    card.style.display = tags.includes(type) ? '' : 'none';
                }
            });
        }

        // ========== å…¶ä»–åŠŸèƒ½ ==========
        function scrollToJoin() {
            document.getElementById('join-section').scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => { document.querySelector('input[type="email"]').focus(); }, 500);
        }

        function submitForm(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "...";
            setTimeout(() => {
                document.getElementById('success-msg').classList.remove('hidden');
                btn.innerText = "SENT";
                btn.classList.add('bg-green-900', 'text-white');
                e.target.reset();
            }, 1000);
        }

        // åˆå§‹åŒ–ï¼šåº”ç”¨ä¿å­˜çš„åå¥½è®¾ç½®
        window.addEventListener('DOMContentLoaded', function() {
            const prefs = JSON.parse(localStorage.getItem('muse_spectrum_prefs') || '[]');
            if (prefs.length > 0) {
                prefs.forEach(pref => {
                    const checkbox = document.querySelector(`#spectrum-modal input[value="${pref}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                updateSpectrumFilter();
            }
        });
    </script>
</body>
</html>