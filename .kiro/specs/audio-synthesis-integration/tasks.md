# 实施计划: 音频合成集成

## 概述

将阿里云DashScope音频合成API集成到现有的Muse应用中，作为Web Speech API的高质量替代选项。实施将采用渐进式方法，首先建立核心架构，然后逐步添加功能，最后进行集成和测试。

## 任务

- [x] 1. 建立核心TTS服务架构
  - 创建TTSService类作为统一的音频合成接口
  - 实现配置管理系统（TTSConfig类）
  - 建立引擎注册和管理机制
  - _需求: 1.2, 1.3, 5.1_

- [ ]* 1.1 为TTS服务架构编写属性测试
  - **属性 1: 引擎切换完整性**
  - **属性 6: 统一接口一致性**
  - **验证: 需求 1.2, 1.3, 5.1, 5.4**

- [ ] 2. 实现Web Speech引擎适配器
  - [x] 2.1 创建WebSpeechEngine类
    - 实现现有音色配置的封装（yushao, shaonian, dashu）
    - 提供统一的synthesize接口
    - 实现getAvailableVoices方法
    - _需求: 5.1, 5.2_

  - [ ]* 2.2 为Web Speech适配器编写单元测试
    - 测试音色配置映射
    - 测试synthesize方法的参数处理
    - _需求: 5.1_

- [ ] 3. 实现DashScope引擎适配器
  - [x] 3.1 创建DashScopeEngine类
    - 实现DashScope API调用逻辑
    - 配置音色映射（yushao->Ethan, shaonian->Cherry, dashu->Dylan）
    - 处理音频URL和Base64格式数据
    - _需求: 2.1, 2.2, 2.3, 3.2_

  - [ ]* 3.2 为DashScope适配器编写属性测试
    - **属性 2: DashScope API调用正确性**
    - **属性 3: 音色映射一致性**
    - **验证: 需求 2.2, 2.3, 3.2, 3.3**

  - [x] 3.3 实现API密钥管理和验证
    - 添加API密钥设置和验证逻辑
    - 实现密钥安全存储
    - _需求: 7.1, 7.2, 7.3_

  - [ ]* 3.4 为API密钥管理编写属性测试
    - **属性 9: API密钥验证**
    - **验证: 需求 7.2, 7.4**

- [ ] 4. 实现流式音频处理
  - [x] 4.1 创建StreamingProcessor类
    - 实现流式音频数据处理
    - 支持Base64到音频的转换
    - 实现音频队列管理
    - _需求: 4.1, 4.2_

  - [ ]* 4.2 为流式处理编写属性测试
    - **属性 5: 流式音频处理**
    - **验证: 需求 4.2**

- [ ] 5. 实现错误处理和降级机制
  - [x] 5.1 创建ErrorHandler类
    - 实现分层错误处理策略
    - 添加自动降级逻辑（DashScope -> Web Speech）
    - 实现用户通知系统
    - _需求: 2.4, 6.1, 6.2, 6.3, 6.4_

  - [ ]* 5.2 为错误处理编写属性测试
    - **属性 8: 错误处理和降级**
    - **验证: 需求 2.4, 4.3, 6.2, 6.4**

- [-] 6. 检查点 - 核心功能验证
  - 确保所有核心组件正常工作，如有问题请询问用户

- [ ] 7. 更新用户界面
  - [ ] 7.1 扩展设置面板UI
    - 在现有音色选择上方添加引擎选择组件
    - 实现引擎切换时的动态音色更新
    - 添加DashScope API密钥输入界面
    - _需求: 1.1, 3.1, 7.1, 8.1, 8.2_

  - [ ] 7.2 实现流式播放控制
    - 添加流式/非流式模式切换选项
    - 更新音频播放状态指示器
    - _需求: 4.4_

  - [ ]* 7.3 为UI组件编写单元测试
    - 测试引擎选择界面
    - 测试动态音色更新
    - _需求: 8.1, 8.2_

- [ ] 8. 集成现有音频功能
  - [ ] 8.1 更新现有的音频调用点
    - 修改speakText函数使用新的TTS服务
    - 更新playSample函数支持多引擎
    - 保持现有API的向后兼容性
    - _需求: 5.2, 5.3_

  - [ ]* 8.2 为参数转换编写属性测试
    - **属性 7: 参数转换正确性**
    - **验证: 需求 5.3**

- [ ] 9. 实现配置持久化
  - [ ] 9.1 扩展现有的localStorage配置
    - 保存引擎选择和DashScope配置
    - 实现配置迁移逻辑
    - 添加配置重置功能
    - _需求: 1.4, 3.4, 7.3_

  - [ ]* 9.2 为配置管理编写属性测试
    - **属性 4: 配置持久化**
    - **验证: 需求 1.4, 3.4, 7.3**

- [ ] 10. 最终集成和测试
  - [ ] 10.1 集成所有组件
    - 将所有组件连接到主应用
    - 确保引擎切换功能正常工作
    - 验证错误处理和降级机制
    - _需求: 5.1, 5.2, 6.1, 6.3_

  - [ ]* 10.2 编写集成测试
    - 测试完整的音频合成流程
    - 测试引擎间切换的连续性
    - 测试错误恢复场景
    - _需求: 5.2, 6.1, 6.3_

  - [ ]* 10.3 为UI动态更新编写属性测试
    - **属性 10: UI动态更新**
    - **验证: 需求 8.2**

- [ ] 11. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况