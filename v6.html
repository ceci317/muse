<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muse | å¥¹çš„æƒ…æ¬²ç”»å»Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muse: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#121212',
                            rose: '#e11d48', 
                            gold: '#e5e5e5',
                            dim: '#525252',
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* === Background Slideshow === */
        .hero-slideshow {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            overflow: hidden;
        }
        .slide-image {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0;
            /* åŠ å¿«åˆ‡æ¢é€Ÿåº¦ï¼šæ·¡å…¥æ·¡å‡º 1.5sï¼Œç¼©æ”¾ 5s */
            transition: opacity 1.5s ease-in-out, transform 5s ease-out; 
            filter: contrast(1.2) brightness(0.6) saturate(1.1) blur(2px); /* å¢åŠ æ¨¡ç³Šæ„Ÿ */
            transform: scale(1.1);
        }
        .slide-image.active {
            opacity: 0.8; 
            transform: scale(1);
        }

        /* === Typography & Effects === */
        .flow-text-layer {
            font-family: "Playfair Display", serif; 
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 0 40px rgba(225, 29, 72, 0.6); 
            letter-spacing: 0.15em;
            mix-blend-mode: overlay;
        }

        /* Glass Panel */
        .glass-panel { 
            background: rgba(10, 10, 10, 0.6); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        /* Recording Animation */
        .recording-pulse {
            box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7);
            animation: recordPulse 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes recordPulse {
            to { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); }
        }

        .selected-option { background: rgba(225, 29, 72, 0.2); border-color: #e11d48; color: #e5e5e5; }
    </style>
</head>
<body class="bg-muse-black text-muse-gold font-sans antialiased overflow-x-hidden selection:bg-muse-rose selection:text-white">

    <!-- 1. HERO SECTION -->
    <section id="landing-page" class="relative w-full h-screen overflow-hidden flex flex-col items-center justify-center z-50 bg-muse-black">
        
        <div class="hero-slideshow" id="slideshow-container">
            <div class="absolute inset-0 bg-gradient-to-b from-muse-black/30 via-transparent to-muse-black/90 z-10"></div>
            <div class="absolute inset-0 opacity-[0.1] z-10" style="background-image: url('https://grainy-gradients.vercel.app/noise.svg');"></div>
        </div>

        <div class="relative z-20 text-center px-6 flex flex-col items-center">
            <div class="mb-8 animate-fade-in">
                <h1 class="flow-text-layer text-7xl md:text-[10rem] font-black leading-none select-none">
                    MUSE
                </h1>
            </div>

            <p class="font-serif italic text-white/70 text-lg md:text-xl mb-12 animate-fade-in mix-blend-screen" style="animation-delay: 0.2s;">
                ä½ çš„æ¬²æœ›ã€‚ä½ çš„å™äº‹ã€‚
            </p>
            
            <div class="animate-fade-in" style="animation-delay: 0.4s;">
                <button onclick="enterPrism()" class="group relative px-10 py-4 overflow-hidden rounded-full border border-white/20 hover:border-muse-rose transition-all duration-500 bg-white/5 backdrop-blur-md">
                    <div class="absolute inset-0 w-0 bg-muse-rose/40 transition-all duration-500 ease-out group-hover:w-full"></div>
                    <span class="relative font-serif text-xs tracking-[0.25em] text-white group-hover:text-white transition-colors duration-300 uppercase">
                        ä»Šæ™šä½ ä¹Ÿç¡ä¸ç€å—ï¼Ÿ
                    </span>
                </button>
            </div>
        </div>
    </section>

    <!-- 2. The Prism (Quiz) - Inclusive Update -->
    <section id="prism-modal" class="fixed inset-0 z-[60] hidden bg-muse-black/95 backdrop-blur-xl flex items-center justify-center p-6 transition-opacity duration-500 overflow-y-auto">
        <div class="max-w-xl w-full">
            <div class="mb-8 flex justify-between items-end border-b border-white/10 pb-4">
                <h2 class="font-serif text-3xl text-muse-gold">The Prism</h2>
                <span class="text-xs text-muse-dim tracking-widest" id="prism-step-indicator">STEP 1 / 3</span>
            </div>
            <div id="question-container" class="min-h-[300px] flex flex-col justify-center animate-fade-in"></div>
            
            <div class="flex justify-between mt-8">
                <button onclick="prevQuestion()" id="prev-btn" class="text-muse-dim hover:text-white text-xs tracking-widest invisible flex items-center gap-2">
                    <i class="fa-solid fa-arrow-left"></i> BACK
                </button>
            </div>
        </div>
    </section>

    <!-- 3. Main Dashboard - Mobile Scroll Fix -->
    <!-- MD:flex-row (Desktop split), Flex-col (Mobile stack), Overlay-y-auto (Allow scrolling on mobile) -->
    <main id="main-content" class="fixed inset-0 top-0 w-full h-full hidden flex-col md:flex-row z-40 bg-muse-black transition-opacity duration-1000 opacity-0 overflow-y-auto md:overflow-hidden">
        
        <!-- Mobile Sticky Header -->
        <div class="sticky top-0 z-50 flex justify-between items-center p-4 bg-muse-black/80 backdrop-blur-md md:absolute md:top-6 md:right-6 md:bg-transparent md:p-0 md:justify-end">
            <div class="md:hidden font-serif text-muse-gold tracking-widest">MUSE</div>
            <div class="flex gap-4 items-center">
                <button onclick="openOracle()" class="group flex items-center gap-2 text-[10px] text-muse-gold hover:text-white tracking-widest transition px-3 py-1 rounded-full border border-muse-gold/20 hover:border-muse-rose/50 bg-black/20 backdrop-blur-sm">
                    <span class="text-sm group-hover:animate-pulse">ğŸ”®</span> ORACLE
                </button>
                <button onclick="openPrism()" class="text-[10px] text-muse-dim hover:text-white tracking-widest transition">PROFILE</button>
                <button onclick="openApiKeySettings()" class="text-[10px] text-muse-dim hover:text-white tracking-widest transition">KEY</button>
            </div>
        </div>

        <!-- Left: AI Solo Fantasy (Scripter) -->
        <!-- Min-height ensures it doesn't collapse on mobile -->
        <div class="relative w-full md:w-5/12 min-h-[80vh] md:h-full border-b md:border-b-0 md:border-r border-white/5 flex flex-col bg-muse-panel shrink-0">
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
                <div class="absolute -top-[20%] -left-[20%] w-[150%] h-[150%] bg-[url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1000&auto=format&fit=crop')] bg-cover opacity-10 blur-sm mix-blend-overlay"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-muse-panel via-muse-panel/90 to-transparent"></div>
            </div>
            
            <div class="relative z-10 flex-1 flex flex-col p-8 md:p-12 justify-center">
                <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-muse-rose animate-pulse"></span>Solo Fantasy
                </span>
                <h2 class="font-serif text-3xl md:text-4xl text-muse-gold mb-4">å¹»æƒ³ç¼–å‰§</h2>
                <p class="text-muse-dim text-sm mb-8 font-light leading-relaxed max-w-sm">
                    ä¸éœ€è¦å…·ä½“çš„å¯¹è±¡ï¼Œåªéœ€è¦ä¸€ä¸ªç¬é—´ã€‚<br>è¾“å…¥ä¸€ä¸ªå…³é”®è¯ï¼ŒMuse ä¸ºä½ ç”Ÿæˆä¸€æ®µå…³äºå£°éŸ³ã€æ°”å‘³ä¸è§¦è§‰çš„ç§å¯†ç‹¬ç™½ã€‚
                </p>
                <div class="space-y-4">
                    <input type="text" id="script-prompt" placeholder="ä¾‹å¦‚ï¼šæš´é›¨å¤œã€æ·¡æ·¡çš„çƒŸè‰å‘³..." class="w-full bg-black/30 border border-white/10 rounded-lg p-4 text-muse-gold placeholder-muse-dim focus:outline-none focus:border-muse-rose transition backdrop-blur-sm text-sm">
                    <button onclick="generateScript()" id="script-btn" class="w-full py-3 bg-white/5 hover:bg-muse-rose text-white text-xs tracking-[0.2em] rounded-lg transition duration-500 border border-white/5 hover:border-transparent">
                        GENERATE
                    </button>
                    <!-- Result Area (Auto expand) -->
                    <div id="script-result" class="hidden mt-6 p-6 border-l border-muse-rose/30 bg-white/5 rounded-r-lg text-muse-gold/90 text-sm font-serif leading-loose italic max-h-[40vh] overflow-y-auto no-scrollbar animate-fade-in"></div>
                </div>
            </div>
        </div>

        <!-- Right: Interactive Story -->
        <div class="relative w-full md:w-7/12 min-h-[100vh] md:h-full flex flex-col bg-muse-black">
            
            <!-- Scenario Selector -->
            <div id="scenario-selector" class="flex-1 p-6 md:p-12 overflow-y-auto no-scrollbar pb-20">
                <div class="mb-8">
                    <span class="text-muse-rose/80 text-[10px] tracking-[0.3em] uppercase mb-3 block">Interactive Roleplay</span>
                    <h2 class="font-serif text-3xl md:text-4xl text-muse-gold">é€‰æ‹©ä½ çš„åœºæ™¯</h2>
                </div>
                
                <!-- Scenes Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cards: More abstract & suggestive images -->
                    <div onclick="startStory('elevator')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1595435934249-5df7ed86e1c0?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">ç§äººç”µæ¢¯</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Confined Â· Breath</p>
                        </div>
                    </div>
                    <div onclick="startStory('office')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1497215728101-856f4ea42174?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æ·±å¤œåŠå…¬å®¤</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Power Â· Silence</p>
                        </div>
                    </div>
                    <div onclick="startStory('bedroom')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1520697830682-8be603d3a6e9?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">è¿·ç¦»å§å®¤</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Intimate Â· Skin</p>
                        </div>
                    </div>
                    <div onclick="startStory('car')" class="group relative h-48 rounded-lg overflow-hidden cursor-pointer border border-white/5 hover:border-muse-rose/50 transition-all duration-500">
                        <img src="https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=600&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-105 transition duration-700 grayscale group-hover:grayscale-0">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                        <div class="absolute bottom-4 left-4">
                            <h3 class="font-serif text-xl text-white mb-1 group-hover:text-muse-rose transition">æš´é›¨è½¦å†…</h3>
                            <p class="text-[10px] text-muse-dim uppercase tracking-widest">Sound Â· Heat</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="hidden flex-col h-full relative bg-muse-black">
                <!-- Toolbar: Persona Settings -->
                <div class="p-3 border-b border-white/5 flex justify-between items-center bg-muse-panel/50 backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <button onclick="exitStory()" class="text-muse-dim hover:text-white transition"><i class="fa-solid fa-chevron-left"></i></button>
                        <div>
                            <h3 class="font-serif text-base text-white" id="chat-title">Story Title</h3>
                        </div>
                    </div>
                    <!-- New Persona Toolbar -->
                    <div class="flex items-center gap-2">
                        <button onclick="toggleSettings()" class="text-[10px] text-muse-gold/80 border border-white/10 hover:border-muse-rose rounded-full px-3 py-1 transition flex items-center gap-2">
                            <i class="fa-solid fa-sliders"></i> <span id="current-persona-label">Default</span>
                        </button>
                        <button onclick="toggleVoiceOutput()" id="tts-toggle" class="text-[10px] text-muse-dim border border-white/10 hover:text-muse-rose rounded-full px-2 py-1 transition">
                            <i class="fa-solid fa-volume-xmark"></i>
                        </button>
                    </div>
                </div>

                <!-- Settings Popover (Hidden) -->
                <div id="settings-popover" class="absolute top-14 right-4 z-50 bg-muse-panel border border-white/10 rounded-xl p-4 w-64 shadow-2xl hidden glass-panel animate-fade-in">
                    <h4 class="text-xs text-muse-dim uppercase tracking-widest mb-3">Persona Settings</h4>
                    
                    <div class="space-y-4">
                        <!-- Gender -->
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-1">Target Gender</label>
                            <select id="setting-gender" class="w-full bg-black/50 text-xs text-white border border-white/10 rounded p-2 focus:border-muse-rose outline-none" onchange="updateLiveSettings()">
                                <option value="male">ç”·æ€§ (Masculine)</option>
                                <option value="female">å¥³æ€§ (Feminine)</option>
                                <option value="neutral">æ— æ€§åˆ« (Neutral)</option>
                            </select>
                        </div>
                        <!-- Voice Tone -->
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-1">Voice Tone</label>
                            <select id="setting-voice" class="w-full bg-black/50 text-xs text-white border border-white/10 rounded p-2 focus:border-muse-rose outline-none" onchange="updateLiveSettings()">
                                <option value="deep">ä½æ²‰ç£æ€§ (Deep)</option>
                                <option value="gentle">æ¸©æŸ”æ²»æ„ˆ (Gentle)</option>
                                <option value="cool">æ¸…å†·ç¦æ¬² (Cool)</option>
                                <option value="dom">å¼ºåŠ¿æŒæ§ (Dominant)</option>
                            </select>
                        </div>
                        <!-- Atmosphere -->
                        <div>
                            <label class="text-[10px] text-stone-400 block mb-1">Atmosphere</label>
                            <select id="setting-vibe" class="w-full bg-black/50 text-xs text-white border border-white/10 rounded p-2 focus:border-muse-rose outline-none" onchange="updateLiveSettings()">
                                <option value="tension">æš§æ˜§æ‹‰æ‰¯ (Tension)</option>
                                <option value="romantic">æµªæ¼«å”¯ç¾ (Romantic)</option>
                                <option value="taboo">ç¦å¿Œåˆºæ¿€ (Taboo)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
                
                <!-- Input Area with Voice -->
                <div class="p-4 bg-muse-black border-t border-white/5">
                    <div class="relative max-w-2xl mx-auto flex gap-2">
                        <!-- Voice Input Button -->
                        <button id="mic-btn" onmousedown="startListening()" onmouseup="stopListening()" ontouchstart="startListening()" ontouchend="stopListening()" class="bg-white/5 hover:bg-white/10 text-muse-dim hover:text-muse-rose rounded-full w-12 h-12 flex items-center justify-center transition border border-white/10">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        
                        <div class="flex-1 relative">
                            <input type="text" id="story-input" placeholder="è¾“å…¥æˆ–æŒ‰ä½éº¦å…‹é£è¯´è¯..." 
                                   class="w-full h-12 bg-white/5 border border-white/10 rounded-full pl-6 pr-12 text-sm text-muse-gold focus:outline-none focus:border-muse-rose focus:bg-white/10 transition"
                                   onkeypress="if(event.key==='Enter') continueStory()">
                            <button onclick="continueStory()" class="absolute right-2 top-2 p-2 text-muse-dim hover:text-muse-rose transition bg-white/5 rounded-full hover:bg-white/10 w-8 h-8 flex items-center justify-center">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Oracle Modal -->
    <div id="oracle-modal" class="fixed inset-0 z-[80] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-6">
        <!-- Content same as before but styled -->
        <div class="max-w-md w-full text-center relative">
            <button onclick="closeOracle()" class="absolute -top-12 right-0 text-stone-500 hover:text-white p-2">âœ•</button>
            <h3 class="font-serif text-3xl text-muse-gold mb-2">The Oracle</h3>
            <p class="text-xs text-muse-dim tracking-widest mb-8">Ask the universe...</p>
            <!-- Card Container -->
            <div id="oracle-card-container" class="relative w-64 h-96 mx-auto mb-8 cursor-pointer perspective-1000 hidden" onclick="flipCard()">
                <div class="card-inner relative w-full h-full shadow-2xl transition-transform duration-700 transform-style-3d">
                    <div class="card-front absolute inset-0 bg-muse-panel border border-muse-rose/30 rounded-xl flex flex-col items-center justify-center p-6 backface-hidden rotate-y-180" style="transform: rotateY(180deg);">
                        <div class="text-6xl mb-4" id="oracle-icon">ğŸ”®</div>
                        <h4 class="font-serif text-xl text-muse-rose mb-4" id="oracle-title">...</h4>
                        <p class="text-sm text-muse-gold/80 italic leading-relaxed" id="oracle-desc">...</p>
                    </div>
                    <div class="card-back absolute inset-0 bg-gradient-to-br from-stone-900 to-black border border-white/10 rounded-xl flex items-center justify-center backface-hidden">
                        <div class="text-muse-dim/20 text-6xl font-serif">M</div>
                        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                    </div>
                </div>
            </div>
            <div id="oracle-controls">
                <button onclick="consultOracle()" id="oracle-btn" class="bg-white/10 hover:bg-muse-rose text-white px-8 py-3 rounded-full text-xs tracking-[0.2em] transition border border-white/10">æŠ½ä¸€å¼ ç‰Œ</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apikey-modal" class="fixed inset-0 z-[70] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel max-w-md w-full p-8 rounded-lg">
            <h3 class="font-serif text-xl text-muse-gold mb-2">Settings</h3>
            <!-- ... (Same as v11 logic) ... -->
            <div class="flex gap-2 mb-4 bg-white/5 p-1 rounded">
                <button onclick="switchProvider('gemini')" id="btn-gemini" class="flex-1 py-2 text-xs rounded transition text-white bg-muse-rose">GEMINI</button>
                <button onclick="switchProvider('dashscope')" id="btn-dashscope" class="flex-1 py-2 text-xs rounded transition text-stone-400">ALIYUN</button>
            </div>
            <input type="password" id="apikey-input" placeholder="Paste API Key..." class="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-muse-gold mb-4 text-sm">
            <button onclick="saveApiSettings()" class="w-full bg-white/10 hover:bg-muse-rose text-white py-2 rounded text-xs tracking-widest">SAVE</button>
            <button onclick="document.getElementById('apikey-modal').classList.add('hidden')" class="w-full mt-2 text-stone-500 text-xs hover:text-white">CLOSE</button>
        </div>
    </div>

    <script>
        // ========== 1. Dynamic Slideshow (Faster & Sensual) ==========
        const backgroundImages = [
            "https://images.unsplash.com/photo-1596704017254-9b121068fb31?q=80&w=1920&auto=format&fit=crop", // Hazy Red
            "https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?q=80&w=1920&auto=format&fit=crop", // Skin Texture
            "https://images.unsplash.com/photo-1507608616759-54f48f0af0ee?q=80&w=1920&auto=format&fit=crop", // Rain/Glass
            "https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1920&auto=format&fit=crop"  // Shadow Silhouette
        ];

        let currentSlide = 0;
        function initSlideshow() {
            const container = document.getElementById('slideshow-container');
            backgroundImages.forEach((src, index) => {
                const img = document.createElement('img');
                img.src = src;
                img.className = `slide-image ${index === 0 ? 'active' : ''}`;
                container.prepend(img);
            });
            // Faster interval: 3.5s
            setInterval(() => {
                const images = document.querySelectorAll('.slide-image');
                images[currentSlide].classList.remove('active');
                currentSlide = (currentSlide + 1) % backgroundImages.length;
                images[currentSlide].classList.add('active');
            }, 3500); 
        }
        document.addEventListener('DOMContentLoaded', initSlideshow);

        // ========== 2. The Prism (Inclusive Quiz) ==========
        const quizData = [
            {
                id: 'orientation',
                question: "ä½ è¢«ä»€ä¹ˆæ ·çš„ç‰¹è´¨å¸å¼•ï¼Ÿ",
                options: [
                    { label: "é˜³åˆšæ°”è´¨ (Masculinity)", value: "masculine", desc: "æ¸´æœ›åŠ›é‡æ„Ÿä¸å¼ åŠ›" },
                    { label: "é˜´æŸ”æ°”è´¨ (Femininity)", value: "feminine", desc: "æ²‰æººäºç»†è…»ä¸æŸ”ç¾" },
                    { label: "æŒæ§ä¸ä¸»å¯¼ (Dominance)", value: "dom", desc: "äº«å—æƒåŠ›çš„è®©æ¸¡" },
                    { label: "çµé­‚å…±é¸£ (Soul)", value: "fluid", desc: "è¶…è¶Šæ€§åˆ«çš„è¿æ¥" }
                ]
            },
            {
                id: 'atmosphere',
                question: "ä½ åçˆ±æ€æ ·çš„æ°›å›´ï¼Ÿ",
                options: [
                    { label: "æš§æ˜§æ‹‰æ‰¯", value: "tension", desc: "è‹¥å³è‹¥ç¦»ï¼Œçœ¼ç¥äº¤æ±‡" },
                    { label: "ç¦å¿Œåˆºæ¿€", value: "taboo", desc: "èƒŒå¾·æ„Ÿä¸å±é™©çš„è¾¹ç¼˜" },
                    { label: "æ¸©æŸ”æ²»æ„ˆ", value: "gentle", desc: "ç¼“æ…¢çš„æ‹¥æŠ±ä¸ä½è¯­" },
                    { label: "ç»å¯¹æœä»", value: "submission", desc: "å®Œå…¨çš„äº¤ä»˜" }
                ]
            },
            {
                id: 'style',
                question: "å‰§æœ¬é£æ ¼åå¥½ï¼Ÿ",
                options: [
                    { label: "å”¯ç¾å«è“„", value: "poetic", desc: "æ³¨é‡äº”æ„Ÿæå†™ï¼Œç•™æœ‰æƒ³è±¡ç©ºé—´" },
                    { label: "ç›´ç™½ç‚½çƒ­", value: "intense", desc: "æ›´ç›´æ¥çš„æ„Ÿå®˜åˆºæ¿€" }
                ]
            }
        ];
        let currentStep = 0;
        let userProfile = { orientation: 'masculine', atmosphere: 'tension', style: 'poetic' }; // Defaults

        function enterPrism() {
            document.getElementById('landing-page').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('prism-modal').classList.remove('hidden');
                renderQuestion();
            }, 500);
        }
        
        function renderQuestion() {
            const q = quizData[currentStep];
            const container = document.getElementById('question-container');
            document.getElementById('prism-step-indicator').innerText = `STEP ${currentStep + 1} / ${quizData.length}`;
            let html = `<h3 class="text-2xl font-serif text-white mb-8 animate-fade-in">${q.question}</h3><div class="grid grid-cols-1 gap-3 animate-fade-in">`;
            q.options.forEach(opt => {
                const isSelected = userProfile[q.id] === opt.value;
                html += `<div onclick="selectOption('${q.id}', '${opt.value}')" class="cursor-pointer border border-white/10 rounded-lg p-4 transition-all hover:bg-white/5 hover:border-muse-rose/50 ${isSelected ? 'selected-option' : ''}"><div class="font-serif text-lg mb-1">${opt.label}</div><div class="text-xs text-muse-dim">${opt.desc}</div></div>`;
            });
            container.innerHTML = html + `</div>`;
            document.getElementById('prev-btn').style.visibility = currentStep > 0 ? 'visible' : 'hidden';
        }

        function selectOption(key, value) {
            userProfile[key] = value;
            renderQuestion();
            setTimeout(() => {
                if(currentStep < quizData.length - 1) {
                    currentStep++;
                    renderQuestion();
                } else {
                    finishPrism();
                }
            }, 300);
        }
        
        function prevQuestion() { if(currentStep>0) { currentStep--; renderQuestion(); } }
        
        function finishPrism() {
            localStorage.setItem('muse_profile', JSON.stringify(userProfile));
            document.getElementById('prism-modal').classList.add('hidden');
            const main = document.getElementById('main-content');
            main.classList.remove('hidden'); main.classList.add('flex');
            setTimeout(() => main.classList.remove('opacity-0'), 100);
            updateLiveSettings(); // Sync toolbar
        }

        function openPrism() {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('prism-modal').classList.remove('hidden');
            currentStep = 0;
            renderQuestion();
        }

        // ========== 3. AI & Voice Logic ==========
        let activeProvider = localStorage.getItem('muse_ai_provider') || 'gemini';
        let voiceEnabled = false;
        
        // Voice Input (Web Speech API)
        let recognition;
        function initRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    document.getElementById('mic-btn').classList.add('recording-pulse', 'text-muse-rose', 'border-muse-rose');
                };
                recognition.onend = () => {
                    document.getElementById('mic-btn').classList.remove('recording-pulse', 'text-muse-rose', 'border-muse-rose');
                };
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const input = document.getElementById('story-input');
                    input.value = text;
                    input.focus();
                };
            } else {
                alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥");
            }
        }
        
        function startListening() { if(recognition) recognition.start(); else initRecognition(); }
        function stopListening() { if(recognition) recognition.stop(); }

        // TTS Toggle
        function toggleVoiceOutput() {
            voiceEnabled = !voiceEnabled;
            const btn = document.getElementById('tts-toggle');
            if(voiceEnabled) {
                btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                btn.classList.add('text-muse-rose', 'border-muse-rose');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
                btn.classList.remove('text-muse-rose', 'border-muse-rose');
                window.speechSynthesis.cancel();
            }
        }

        function speak(text) {
            if(!voiceEnabled) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            // Simple voice matching based on profile
            if(userProfile.orientation === 'masculine') u.pitch = 0.8;
            else u.pitch = 1.2;
            window.speechSynthesis.speak(u);
        }

        // API Calls
        function getApiKey(p=activeProvider) { 
            return p==='gemini' ? localStorage.getItem('muse_gemini_apikey') : localStorage.getItem('muse_dashscope_apikey'); 
        }
        
        async function callAI(prompt, system, json=false) {
            const key = getApiKey();
            if(!key) { openApiKeySettings(); return "è¯·å…ˆé…ç½® API Key"; }
            
            // Unified Call Logic
            try {
                if(activeProvider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const body = { contents: [{parts:[{text: prompt}]}], systemInstruction:{parts:[{text:system}]} };
                    if(json) body.generationConfig = { responseMimeType: "application/json" };
                    
                    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
                } else {
                    // DashScope / OpenAI Compatible
                    const url = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
                    const res = await fetch(url, {
                        method:'POST',
                        headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                        body: JSON.stringify({ model:'qwen-plus', messages:[{role:'system',content:system},{role:'user',content:prompt}] })
                    });
                    const data = await res.json();
                    return data.choices?.[0]?.message?.content || "Error";
                }
            } catch(e) { console.error(e); return "Network Error"; }
        }

        // ========== 4. Core Features ==========
        
        // Settings Toolbar Logic
        function toggleSettings() {
            const pop = document.getElementById('settings-popover');
            pop.classList.toggle('hidden');
        }
        
        function updateLiveSettings() {
            // Update local profile from dropdowns
            userProfile.orientation = document.getElementById('setting-gender').value;
            userProfile.atmosphere = document.getElementById('setting-vibe').value;
            // Also update voice logic if needed here
            
            // Update Label
            document.getElementById('current-persona-label').innerText = `${userProfile.orientation} / ${userProfile.atmosphere}`;
        }

        // Feature: Scripter (Updated for Long Context)
        async function generateScript() {
            const input = document.getElementById('script-prompt');
            const resDiv = document.getElementById('script-result');
            const btn = document.getElementById('script-btn');
            if(!input.value) return;
            
            btn.innerText = "WRITING..."; btn.disabled = true;
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = '<span class="animate-pulse">Muse æ­£åœ¨ç¼–ç»‡...</span>';
            
            const system = `ä½ æ˜¯ä¸€ä¸ªå¥³æ€§å‘æƒ…è‰²æ–‡å­¦ä¸“å®¶ã€‚
            è¯·æ ¹æ®å…³é”®è¯å†™ä¸€æ®µã€200-300å­—ã€‘çš„ç‹¬ç™½æˆ–åœºæ™¯æå†™ã€‚
            é‡ç‚¹ï¼šæåº¦ç»†è…»çš„äº”æ„Ÿæå†™ï¼ˆå£°éŸ³ã€æ°”å‘³ã€æ¸©åº¦ã€è§¦è§‰ï¼‰ï¼Œæ°›å›´è¦${userProfile.atmosphere}ï¼Œå¯¹è±¡æ˜¯${userProfile.orientation}ã€‚
            æ‹’ç»é™ˆè¯æ»¥è°ƒï¼Œä½¿ç”¨é«˜çº§ã€å¯Œæœ‰å¼ åŠ›çš„è¯­è¨€ã€‚`;
            
            const text = await callAI(input.value, system);
            resDiv.innerHTML = marked.parse(text);
            btn.innerText = "GENERATE"; btn.disabled = false;
        }

        // Feature: Interactive Story
        let storyContext = "";
        function startStory(scene) {
            document.getElementById('scenario-selector').classList.add('hidden');
            document.getElementById('chat-interface').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('flex');
            
            // Set initial context based on scene + profile
            const target = userProfile.orientation === 'female' ? 'å¥¹' : (userProfile.orientation === 'masculine' ? 'ä»–' : 'Ta');
            let intro = "";
            
            if(scene === 'elevator') intro = `ç”µæ¢¯æ•…éšœåœåœ¨22å±‚ã€‚${target}è§£å¼€äº†é¢†å£ï¼Œç‹­å°çš„ç©ºé—´é‡Œå……æ»¡äº†${userProfile.atmosphere === 'taboo' ? 'å±é™©' : 'æš§æ˜§'}çš„æ°”æ¯...`;
            else if(scene === 'office') intro = `æ·±å¤œçš„åŠå…¬å®¤ï¼Œåªæœ‰ä½ å’Œ${target}ã€‚${target}åé”äº†é—¨ï¼Œèµ°å‘ä½ ...`;
            else if(scene === 'bedroom') intro = `å§å®¤å†…å…‰çº¿æ˜æš—ï¼Œ${target}çš„æ°”æ¯å°±åœ¨è€³è¾¹...`;
            else intro = `æš´é›¨æ‹æ‰“ç€è½¦çª—ï¼Œè½¦å†…é›¾æ°”å¼¥æ¼«ï¼Œ${target}çš„æ‰‹æ­åœ¨æ–¹å‘ç›˜ä¸Šï¼Œä¾§å¤´çœ‹ä½ ...`;
            
            storyContext = `åœºæ™¯ï¼š${scene}ã€‚å¯¹è±¡ï¼š${target}ã€‚æ°›å›´ï¼š${userProfile.atmosphere}ã€‚`;
            addBubble(intro, 'ai');
            initRecognition(); // Prepare mic
        }

        function exitStory() {
            document.getElementById('chat-interface').classList.remove('flex');
            document.getElementById('chat-interface').classList.add('hidden');
            document.getElementById('scenario-selector').classList.remove('hidden');
            document.getElementById('chat-history').innerHTML = '';
        }

        async function continueStory() {
            const input = document.getElementById('story-input');
            const val = input.value.trim();
            if(!val) return;
            
            addBubble(val, 'user');
            input.value = '';
            
            const loadingId = addBubble('...', 'ai', true);
            const system = `Roleplay Game. ä½ çš„å¯¹è±¡è®¾å®šï¼š${userProfile.orientation}ï¼Œå£°çº¿ï¼š${document.getElementById('setting-voice').value}ã€‚
            æ°›å›´ï¼š${userProfile.atmosphere}ã€‚è¯·ä»¥ç¬¬äºŒäººç§°â€œä½ â€ç»­å†™ã€‚
            è¦æ±‚ï¼šæ³¨é‡æ„Ÿå®˜æå†™ã€æ‹‰æ‰¯æ„Ÿã€æ€§å¼ åŠ›ã€‚å›å¤ä¸è¦å¤ªçŸ­ï¼Œ100å­—å·¦å³ã€‚`;
            const prompt = `Story Context: ${storyContext}\nUser Action: ${val}`;
            
            const res = await callAI(prompt, system);
            document.getElementById(loadingId).remove();
            addBubble(res, 'ai');
            storyContext += `\nUser: ${val}\nAI: ${res}`;
            
            // Auto Speak if enabled
            if(voiceEnabled) speak(res.replace(/[*#]/g, ''));
        }

        function addBubble(text, role, loading=false) {
            const div = document.createElement('div');
            div.className = `flex w-full ${role==='user'?'justify-end':'justify-start'}`;
            div.id = 'msg-' + Date.now();
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] px-4 py-3 rounded-2xl text-sm leading-relaxed ${
                role==='user' 
                ? 'bg-muse-rose/20 text-white border border-muse-rose/30 rounded-tr-none' 
                : 'bg-white/10 text-muse-gold border border-white/5 rounded-tl-none font-serif'
            }`;
            
            if(loading) bubble.classList.add('animate-pulse');
            bubble.innerHTML = loading ? text : marked.parse(text);
            
            div.appendChild(bubble);
            document.getElementById('chat-history').appendChild(div);
            
            const history = document.getElementById('chat-history');
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        // Init Logic
        function openApiKeySettings() { document.getElementById('apikey-modal').classList.remove('hidden'); }
        function saveApiSettings() {
            const k1 = document.getElementById('apikey-input').value;
            if(k1) localStorage.setItem('muse_gemini_apikey', k1); 
            // Simple logic for MVP
            document.getElementById('apikey-modal').classList.add('hidden');
        }
        function switchProvider(p) {
            activeProvider = p;
            localStorage.setItem('muse_ai_provider', p);
            document.getElementById('btn-gemini').className = p==='gemini'?'flex-1 py-2 text-xs rounded transition text-white bg-muse-rose':'flex-1 py-2 text-xs rounded transition text-stone-400';
            document.getElementById('btn-dashscope').className = p==='dashscope'?'flex-1 py-2 text-xs rounded transition text-white bg-muse-rose':'flex-1 py-2 text-xs rounded transition text-stone-400';
        }
        
        // Oracle Stubs
        function openOracle() { document.getElementById('oracle-modal').classList.remove('hidden'); }
        function closeOracle() { document.getElementById('oracle-modal').classList.add('hidden'); }
        async function consultOracle() {
            const btn = document.getElementById('oracle-btn');
            btn.innerText = "...";
            const sys = "Oracle mode. Output JSON: {title:'Card', icon:'ğŸ”®', desc:'Short poetic meaning'}";
            const res = await callAI("Draw a card", sys, true);
            try {
                const j = JSON.parse(res.replace(/```json|```/g,''));
                document.getElementById('oracle-title').innerText = j.title;
                document.getElementById('oracle-icon').innerText = j.icon;
                document.getElementById('oracle-desc').innerText = j.desc;
                document.querySelector('.card-inner').style.transform = 'rotateY(180deg)';
            } catch(e){}
            btn.innerText = "æŠ½ä¸€å¼ ç‰Œ";
        }

        // Init
        window.onload = () => {
            initSlideshow();
            initRecognition();
            const saved = localStorage.getItem('muse_profile');
            if(saved) {
                userProfile = JSON.parse(saved);
                // Pre-fill dropdowns
                document.getElementById('setting-gender').value = userProfile.orientation || 'masculine';
                document.getElementById('setting-vibe').value = userProfile.atmosphere || 'tension';
                updateLiveSettings();
            }
        };
    </script>
</body>
</html>